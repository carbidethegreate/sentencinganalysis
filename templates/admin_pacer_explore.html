{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | Explore PACER{% endblock %}

{% block federal_content %}
  {% set case_values = case_values or case_defaults %}
  {% set party_values = party_values or party_defaults %}
  <section class="card stack">
    <div>
      <p class="pacer-eyebrow">Quick search</p>
      <h2>Search PACER</h2>
      <p class="small">
        Run a quick PACER search to preview results. Click “Save to database” to keep cases in Cases.
      </p>
    </div>

    <div class="pacer-inline-note" role="note">
      <strong>What you get:</strong> case or party results, plus PACER receipts and fees.<br>
      <strong>What comes later:</strong> full dockets or documents. Use “Expand data” to enrich saved cases.
    </div>

    <div class="flash">
      <strong>Billing note:</strong> PACER bills per search. Billing status: {{ pacer_env_billable_label }}.
      Immediate searches return one page at a time ({{ explore_page_size }} results per page).
      Batch runs are for larger searches (up to {{ explore_max_records }} results).
    </div>

    <details class="pacer-status-summary" {% if pacer_env_mismatch %}open{% endif %}>
      <summary>
        <div class="pacer-status-summary__row">
          <span class="pacer-status-pill {% if pacer_search_enabled %}pacer-status-pill--enabled{% else %}pacer-status-pill--disabled{% endif %}" role="status" aria-live="polite">
            {% if pacer_search_enabled %}Search enabled{% else %}Search disabled{% endif %}
          </span>
          <span class="pacer-status-summary__text">
            Connection: PACER Auth {{ pacer_auth_env_label }} · PCL {{ pcl_env_label }} · Billable {{ pacer_env_billable_label }} · {{ pacer_auth_host }} · {{ pcl_host }}
          </span>
          <span class="pacer-status-summary__hint">Expand</span>
        </div>
      </summary>

      <div class="pacer-status-summary__content">
        <section class="pacer-status-grid">
          <article class="card pacer-status-compact">
            <div class="pacer-status-compact__header">
              <div>
                <p class="pacer-eyebrow">PACER environment</p>
                <h3>Environment: {{ pcl_env_label }}</h3>
                <p class="small">
                  PACER Auth: {{ pacer_auth_env_label }} · PCL: {{ pcl_env_label }} · Billable: {{ pacer_env_billable_label }}
                </p>
              </div>
              <a class="pill" href="{{ pacer_authorize_url }}">Settings</a>
            </div>
            <details class="pacer-status-details">
              <summary class="small">Connection details</summary>
              <p class="small">PACER_AUTH_BASE_URL host: {{ pacer_auth_host }}</p>
              <p class="small">PCL_BASE_URL host: {{ pcl_host }}</p>
            </details>
            {% if pacer_env_mismatch and pacer_env_mismatch_reason %}
              <div class="flash error">
                <strong>Environment mismatch:</strong> {{ pacer_env_mismatch_reason }}
              </div>
            {% endif %}
          </article>

          <article class="card pacer-status-compact">
            <div class="pacer-status-compact__header">
              <div>
                <p class="pacer-eyebrow">Authorization</p>
                <h3>{% if pacer_authenticated %}Authenticated{% else %}Not authenticated{% endif %}</h3>
                <p class="small">
                  Authenticated: {{ 'Yes' if pacer_authenticated else 'No' }} · Search enabled: {{ 'Yes' if pacer_search_enabled else 'No' }}
                </p>
                {% if pacer_authorized_at %}
                  <p class="small">Authorized at {{ pacer_authorized_at.replace('T', ' ') }} UTC.</p>
                {% endif %}
              </div>
              <div class="pacer-status-pill {% if pacer_search_enabled %}pacer-status-pill--enabled{% else %}pacer-status-pill--disabled{% endif %}" role="status" aria-live="polite">
                {% if pacer_search_enabled %}Search enabled{% else %}Search disabled{% endif %}
              </div>
            </div>
            {% if pacer_client_code_required %}
              <div class="flash warning">
                <strong>Client code required by PACER:</strong>
                Re-authorize with a client code to ensure billable activity is tracked correctly.
              </div>
            {% endif %}
            <div class="actions">
              <a class="primary" href="{{ pacer_authorize_url }}">Authorize / manage PACER session</a>
            </div>
          </article>
        </section>
      </div>
    </details>

    <div class="pacer-mode-tabs" role="tablist" aria-label="PACER search mode">
      <a class="pacer-mode-tab {% if mode == 'cases' %}active{% endif %}" href="{{ url_for('admin_pacer_explore', mode='cases') }}" role="tab" aria-selected="{{ 'true' if mode == 'cases' else 'false' }}">Search cases</a>
      <a class="pacer-mode-tab {% if mode == 'parties' %}active{% endif %}" href="{{ url_for('admin_pacer_explore', mode='parties') }}" role="tab" aria-selected="{{ 'true' if mode == 'parties' else 'false' }}">Search people/parties</a>
    </div>

    {% if not pacer_search_enabled %}
      <div class="flash warning">
        PACER search is disabled until authentication is active and the PACER environment matches.
        Re-authorize and try again.
      </div>
    {% endif %}

    {% if mode == 'cases' %}
      <form method="post" action="{{ url_for('admin_pacer_explore_run') }}" class="stack">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="mode" value="cases">

        <div class="stack">
          <label for="case-search-mode">How fast do you need results?</label>
          <select id="case-search-mode" name="search_mode" data-search-mode-control>
            <option value="immediate" {% if not case_values or case_values.search_mode == 'immediate' %}selected{% endif %}>Immediate (see results now)</option>
            <option value="batch" {% if case_values and case_values.search_mode == 'batch' %}selected{% endif %}>Batch (run a large search)</option>
          </select>
          <p class="small">
            Immediate returns one page at a time ({{ explore_page_size }} results per page).
          </p>
          <p class="small">
            Batch runs a report for later retrieval and supports up to {{ batch_max_pages }} pages / {{ explore_max_records }} items.
          </p>
        </div>

        <div class="grid two">
          <div>
            <label for="explore-court">Court (optional)</label>
            <input class="small" type="search" placeholder="Type to filter courts" data-filter-input="explore-court">
            <select id="explore-court" name="court_id">
              <option value="">Select a court…</option>
              {% for court in courts %}
                <option value="{{ court.court_id }}" {% if case_values and case_values.court_id == court.court_id %}selected{% endif %}>
                  {{ court.label }}
                </option>
              {% endfor %}
            </select>
            <p class="small">Choose a court or a region below.</p>
          </div>
          <div>
            <label for="explore-region">Region (optional)</label>
            <input class="small" type="search" placeholder="Type to filter regions" data-filter-input="explore-region">
            <select id="explore-region" name="region_code">
              <option value="">Select a region…</option>
              {% for region in regions %}
                <option value="{{ region.region_code }}" {% if case_values and case_values.region_code == region.region_code %}selected{% endif %}>
                  {{ region.label }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid two">
          <div data-search-mode-field="immediate">
            <label for="case-page-number">Page</label>
            <input
              id="case-page-number"
              name="page"
              type="number"
              min="1"
              max="{{ immediate_max_pages }}"
              value="{{ case_values.page if case_values else 1 }}"
              required
            >
            <p class="small">Page size is fixed at {{ explore_page_size }}. Maximum {{ immediate_max_pages }} pages.</p>
          </div>
        </div>

        <div class="grid two" data-search-mode-field="batch">
          <div>
            <label for="explore-max-records">Max records</label>
            <input
              id="explore-max-records"
              name="max_records"
              type="number"
              min="1"
              max="{{ explore_max_records }}"
              value="{{ case_values.max_records if case_values else explore_page_size }}"
              required
            >
            <p class="small">Default {{ explore_page_size }} (one page). Hard cap {{ explore_max_records }}.</p>
          </div>
        </div>

        <div class="grid two">
          <div>
            <label for="explore-date-from">Date filed from</label>
            <input id="explore-date-from" name="date_filed_from" type="date" value="{{ case_values.date_filed_from if case_values else '' }}" required>
          </div>
          <div>
            <label for="explore-date-to">Date filed to</label>
            <input id="explore-date-to" name="date_filed_to" type="date" value="{{ case_values.date_filed_to if case_values else '' }}" required>
          </div>
        </div>

        <div>
          <label for="explore-case-types">Case types (optional)</label>
          <input class="small" type="search" placeholder="Type to filter case types" data-filter-input="explore-case-types">
          <select id="explore-case-types" name="case_types" multiple size="4">
            {% set selected_case_types = case_values.case_types if case_values else [] %}
            {% for case_type, label in case_type_choices %}
              <option value="{{ case_type }}" {% if selected_case_types and case_type in selected_case_types %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <p class="small">Leave blank to include all case types.</p>
        </div>

        <div class="grid two">
          <div>
            <label for="case-sort-field">Sort field (optional)</label>
            <select id="case-sort-field" name="sort_field">
              <option value="">Default order</option>
              {% for field in case_sort_fields %}
                <option value="{{ field }}" {% if case_values and case_values.sort_field == field %}selected{% endif %}>
                  {{ field }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="case-sort-order">Sort order</label>
            <select id="case-sort-order" name="sort_order">
              <option value="asc" {% if not case_values or case_values.sort_order == 'asc' %}selected{% endif %}>ASC</option>
              <option value="desc" {% if case_values and case_values.sort_order == 'desc' %}selected{% endif %}>DESC</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="primary" type="submit" {% if not pacer_search_enabled %}disabled{% endif %}>Run search</button>
        </div>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('admin_pacer_explore_run') }}" class="stack">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="mode" value="parties">

        <div class="stack">
          <label for="party-search-mode">How fast do you need results?</label>
          <select id="party-search-mode" name="search_mode" data-search-mode-control>
            <option value="immediate" {% if not party_values or party_values.search_mode == 'immediate' %}selected{% endif %}>Immediate (see results now)</option>
            <option value="batch" {% if party_values and party_values.search_mode == 'batch' %}selected{% endif %}>Batch (run a large search)</option>
          </select>
          <p class="small">
            Immediate returns one page at a time ({{ explore_page_size }} results per page).
          </p>
          <p class="small">
            Batch runs a report for later retrieval and supports up to {{ batch_max_pages }} pages / {{ explore_max_records }} items.
          </p>
        </div>

        <div class="grid two">
          <div>
            <label for="party-last-name">Last name</label>
            <input id="party-last-name" name="last_name" type="text" value="{{ party_values.last_name if party_values else '' }}" required>
            <p class="small">Required. Defaults to a “starts with” search.</p>
            <label class="small">
              <input type="checkbox" name="exact_name_match" value="true" {% if party_values and party_values.exact_name_match %}checked{% endif %}>
              Exact name match
            </label>
          </div>
          <div>
            <label for="party-first-name">First name (optional)</label>
            <input id="party-first-name" name="first_name" type="text" value="{{ party_values.first_name if party_values else '' }}">
            <label for="party-ssn" class="small mt-8">SSN (optional)</label>
            <input id="party-ssn" name="ssn" type="text" value="{{ party_values.ssn if party_values else '' }}" placeholder="123-45-6789">
          </div>
        </div>

        <div class="grid two">
          <div>
            <label for="party-date-from">Date filed from (optional)</label>
            <input id="party-date-from" name="date_filed_from" type="date" value="{{ party_values.date_filed_from if party_values else '' }}">
          </div>
          <div>
            <label for="party-date-to">Date filed to (optional)</label>
            <input id="party-date-to" name="date_filed_to" type="date" value="{{ party_values.date_filed_to if party_values else '' }}">
          </div>
        </div>

        <div class="grid two">
          <div>
            <label for="party-court">Court (optional)</label>
            <input class="small" type="search" placeholder="Type to filter courts" data-filter-input="party-court">
            <select id="party-court" name="court_id">
              <option value="">All courts</option>
              {% for court in courts %}
                <option value="{{ court.court_id }}" {% if party_values and party_values.court_id == court.court_id %}selected{% endif %}>
                  {{ court.label }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="party-region">Region (optional)</label>
            <input class="small" type="search" placeholder="Type to filter regions" data-filter-input="party-region">
            <select id="party-region" name="region_code">
              <option value="">All regions</option>
              {% for region in regions %}
                <option value="{{ region.region_code }}" {% if party_values and party_values.region_code == region.region_code %}selected{% endif %}>
                  {{ region.label }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid two">
          <div data-search-mode-field="immediate">
            <label for="party-page-number">Page</label>
            <input
              id="party-page-number"
              name="page"
              type="number"
              min="1"
              max="{{ immediate_max_pages }}"
              value="{{ party_values.page if party_values else 1 }}"
              required
            >
            <p class="small">Page size is fixed at {{ explore_page_size }}. Maximum {{ immediate_max_pages }} pages.</p>
          </div>
        </div>

        <div class="grid two" data-search-mode-field="batch">
          <div>
            <label for="party-max-records">Max records</label>
            <input
              id="party-max-records"
              name="max_records"
              type="number"
              min="1"
              max="{{ explore_max_records }}"
              value="{{ party_values.max_records if party_values else explore_page_size }}"
              required
            >
            <p class="small">Default {{ explore_page_size }} (one page). Hard cap {{ explore_max_records }}.</p>
          </div>
        </div>

        <div class="grid two">
          <div>
            <label for="party-sort-field">Sort field (optional)</label>
            <select id="party-sort-field" name="sort_field">
              <option value="">Default order</option>
              {% for field in party_sort_fields %}
                <option value="{{ field }}" {% if party_values and party_values.sort_field == field %}selected{% endif %}>
                  {{ field }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="party-sort-order">Sort order</label>
            <select id="party-sort-order" name="sort_order">
              <option value="asc" {% if not party_values or party_values.sort_order == 'asc' %}selected{% endif %}>ASC</option>
              <option value="desc" {% if party_values and party_values.sort_order == 'desc' %}selected{% endif %}>DESC</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="primary" type="submit" {% if not pacer_search_enabled %}disabled{% endif %}>Run search</button>
        </div>
      </form>
    {% endif %}
  </section>

  {% if run_result %}
    <section class="stack" aria-live="polite">
        {% if run_result.errors %}
        <div class="flash error">
          <strong>Run failed.</strong>
          <ul>
            {% for err in run_result.errors %}
              <li>{{ err }}</li>
            {% endfor %}
          </ul>
          <p class="small">
            Next step: use the debug bundle below when opening a fix request.
          </p>
        </div>
      {% else %}
        {% if run_result.search_mode == 'batch' %}
          <div class="flash success">
            <strong>Report submitted.</strong>
            Track the report status below before loading results.
          </div>
        {% else %}
          <div class="flash success">
            <strong>Run complete.</strong>
            Pulled {{ (run_result.cases|length) if run_result.mode == 'cases' else (run_result.parties|length) }} records across {{ run_result.pages_fetched }} page(s).
          </div>
        {% endif %}
        {% if run_result.save_summary %}
          <div class="flash success">
            <strong>Saved search results.</strong>
            New cases: {{ run_result.save_summary.cases_inserted }} · Updated cases: {{ run_result.save_summary.cases_updated }}
            · New parties: {{ run_result.save_summary.parties_inserted }} · Updated parties: {{ run_result.save_summary.parties_updated }}
          </div>
        {% endif %}
      {% endif %}

      {% if run_result.warnings %}
        <div class="flash">
          <strong>Warnings</strong>
          <ul>
            {% for warn in run_result.warnings %}
              <li>{{ warn }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if run_result.search_mode == 'batch' and run_result.report_request %}
        {% set report_info = run_result.report_request.info or {} %}
        <section class="card stack" id="batch-report-status">
          <div class="row row--spread">
            <div>
              <p class="pacer-eyebrow">Batch report</p>
              <h3>Report status</h3>
              <p class="small">Report ID: <code>{{ run_result.report_request.report_id or '—' }}</code></p>
            </div>
            <div class="actions">
              <form method="post" action="{{ url_for('admin_pacer_explore_batch_status') }}" class="row" data-auto-poll-form>
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="request_id" value="{{ run_result.report_request.request_id }}">
                <button class="secondary" type="submit">Refresh status</button>
                <label class="small ml-12">
                  <input type="checkbox" data-auto-poll-toggle>
                  Auto-refresh
                </label>
              </form>
            </div>
          </div>

          <dl class="pcl-detail-list">
            <div><dt>Status</dt><dd>{{ run_result.report_request.status or '—' }}</dd></div>
            <div><dt>Start time</dt><dd>{{ report_info.startTime or '—' }}</dd></div>
            <div><dt>End time</dt><dd>{{ report_info.endTime or '—' }}</dd></div>
            <div><dt>Record count</dt><dd>{{ report_info.recordCount or '—' }}</dd></div>
            <div><dt>Unbilled pages</dt><dd>{{ report_info.unbilledPageCount or '—' }}</dd></div>
            <div><dt>Download fee</dt><dd>{{ report_info.downloadFee or '—' }}</dd></div>
            <div><dt>Pages</dt><dd>{{ report_info.pages or '—' }}</dd></div>
          </dl>

          {% if run_result.report_request.status == 'COMPLETED' %}
            <div class="actions">
              <form method="post" action="{{ url_for('admin_pacer_explore_batch_load') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="request_id" value="{{ run_result.report_request.request_id }}">
                <button class="primary" type="submit">Load results</button>
              </form>
              <a class="secondary" href="{{ url_for('admin_pacer_explore_batch_download', request_id=run_result.report_request.request_id) }}">Download report</a>
            </div>
          {% endif %}
        </section>
      {% endif %}

      <section class="card stack">
        <div class="row row--spread">
          <div>
            <p class="pacer-eyebrow">Debug bundle</p>
            <h3>Copyable run bundle</h3>
            <p class="small">
              Includes sanitized inputs, request body, status codes, page info, response snippets, and case samples.
            </p>
          </div>
          <div class="actions">
            <button class="secondary" type="button" id="copy-debug-bundle">Copy debug bundle</button>
          </div>
        </div>
        <pre id="debug-bundle" class="code-block">{{ run_result.debug_bundle }}</pre>
      </section>

      {% if run_result.search_mode == 'immediate' or run_result.cases or run_result.parties %}
        <section class="card stack">
          <p class="pacer-eyebrow">Results</p>
          {% if run_result.mode == 'cases' %}
            <h3>Returned cases (truncated)</h3>
            {% if run_result.page_info %}
              <p class="small">
                Page {{ run_result.page_number or (run_result.page_info.number + 1 if run_result.page_info.number is not none else '—') }}
                · Total pages {{ run_result.page_info.totalPages or '—' }}
                · Total records {{ run_result.page_info.totalElements or '—' }}
              </p>
              {% set total_pages = run_result.page_info.totalPages %}
              {% if run_result.page_number and total_pages and run_result.page_number > total_pages %}
                <div class="flash warning">
                  Requested page {{ run_result.page_number }} exceeds the total page count ({{ total_pages }}).
                  Try page 1 or a narrower date range.
                </div>
                <form method="post" action="{{ url_for('admin_pacer_explore_run') }}" class="actions">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="mode" value="cases">
                  <input type="hidden" name="search_mode" value="immediate">
                  <input type="hidden" name="court_id" value="{{ case_values.court_id if case_values else '' }}">
                  <input type="hidden" name="region_code" value="{{ case_values.region_code if case_values else '' }}">
                  <input type="hidden" name="date_filed_from" value="{{ case_values.date_filed_from if case_values else '' }}">
                  <input type="hidden" name="date_filed_to" value="{{ case_values.date_filed_to if case_values else '' }}">
                  {% if case_values and case_values.case_types %}
                    {% for case_type in case_values.case_types %}
                      <input type="hidden" name="case_types" value="{{ case_type }}">
                    {% endfor %}
                  {% endif %}
                  <input type="hidden" name="sort_field" value="{{ case_values.sort_field if case_values else '' }}">
                  <input type="hidden" name="sort_order" value="{{ case_values.sort_order if case_values else '' }}">
                  <input type="hidden" name="page" value="1">
                  <button class="secondary" type="submit">Run page 1</button>
                </form>
              {% endif %}
            {% endif %}
            {% if run_result.search_mode == 'immediate' and run_result.page_info %}
              {% set current_page = run_result.page_number or (run_result.page_info.number + 1 if run_result.page_info.number is not none else 1) %}
              <div class="actions">
                {% if not run_result.page_info.first %}
                  <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="mode" value="cases">
                    <input type="hidden" name="search_mode" value="immediate">
                    <input type="hidden" name="court_id" value="{{ case_values.court_id if case_values else '' }}">
                    <input type="hidden" name="region_code" value="{{ case_values.region_code if case_values else '' }}">
                    <input type="hidden" name="date_filed_from" value="{{ case_values.date_filed_from if case_values else '' }}">
                    <input type="hidden" name="date_filed_to" value="{{ case_values.date_filed_to if case_values else '' }}">
                    {% if case_values and case_values.case_types %}
                      {% for case_type in case_values.case_types %}
                        <input type="hidden" name="case_types" value="{{ case_type }}">
                      {% endfor %}
                    {% endif %}
                    <input type="hidden" name="sort_field" value="{{ case_values.sort_field if case_values else '' }}">
                    <input type="hidden" name="sort_order" value="{{ case_values.sort_order if case_values else '' }}">
                    <input type="hidden" name="page" value="{{ current_page - 1 }}">
                    <button class="secondary" type="submit">Previous page</button>
                  </form>
                {% endif %}
                {% if not run_result.page_info.last %}
                  <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="mode" value="cases">
                    <input type="hidden" name="search_mode" value="immediate">
                    <input type="hidden" name="court_id" value="{{ case_values.court_id if case_values else '' }}">
                    <input type="hidden" name="region_code" value="{{ case_values.region_code if case_values else '' }}">
                    <input type="hidden" name="date_filed_from" value="{{ case_values.date_filed_from if case_values else '' }}">
                    <input type="hidden" name="date_filed_to" value="{{ case_values.date_filed_to if case_values else '' }}">
                    {% if case_values and case_values.case_types %}
                      {% for case_type in case_values.case_types %}
                        <input type="hidden" name="case_types" value="{{ case_type }}">
                      {% endfor %}
                    {% endif %}
                    <input type="hidden" name="sort_field" value="{{ case_values.sort_field if case_values else '' }}">
                    <input type="hidden" name="sort_order" value="{{ case_values.sort_order if case_values else '' }}">
                    <input type="hidden" name="page" value="{{ current_page + 1 }}">
                    <button class="secondary" type="submit">Next page</button>
                  </form>
                {% endif %}
              </div>
            {% endif %}
            {% if run_result.cases %}
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Case number</th>
                      <th>Case type</th>
                      <th>Date filed</th>
                      <th>Short title</th>
                      <th>Court</th>
                      <th>Saved?</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for case in run_result.cases_view or run_result.cases %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ case.case_number or case.caseNumber or case.case_number_full or case.cs_case_number or '—' }}</td>
                        <td>{{ case.case_type or case.caseType or '—' }}</td>
                        <td>{{ case.date_filed or case.dateFiled or '—' }}</td>
                        <td>{{ case.short_title or case.shortTitle or case.cs_short_title or '—' }}</td>
                        <td>{{ case.court_id or case.courtId or case_values.court_id }}</td>
                        <td>
                          {% if case.already_indexed %}
                            <span class="pill">Already indexed</span>
                          {% else %}
                            <span class="pill primary">New</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if case.case_id %}
                            <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case.case_id) }}">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                              <button class="secondary" type="submit">Expand data</button>
                            </form>
                          {% else %}
                            <span class="small">—</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td colspan="8">
                          <details>
                            <summary class="small">Show full PACER record</summary>
                            <pre class="code-block">{{ case | tojson(indent=2) }}</pre>
                          </details>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if run_result.store_payload %}
                <div class="actions">
                  <form method="post" action="{{ url_for('admin_pacer_explore_store') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <textarea name="store_payload" hidden>{{ run_result.store_payload | tojson }}</textarea>
                    <button class="primary" type="submit">Save to database</button>
                  </form>
                  <a class="pill" href="{{ url_for('admin_federal_data_dashboard_case_cards') }}">View saved case cards</a>
                </div>
              {% endif %}
            {% else %}
              <p class="small">No cases were returned for the selected filters.</p>
            {% endif %}
          {% else %}
            <h3>Returned parties (truncated)</h3>
            {% if run_result.page_info %}
              <p class="small">
                Page {{ run_result.page_number or (run_result.page_info.number + 1 if run_result.page_info.number is not none else '—') }}
                · Total pages {{ run_result.page_info.totalPages or '—' }}
                · Total records {{ run_result.page_info.totalElements or '—' }}
              </p>
              {% set total_pages = run_result.page_info.totalPages %}
              {% if run_result.page_number and total_pages and run_result.page_number > total_pages %}
                <div class="flash warning">
                  Requested page {{ run_result.page_number }} exceeds the total page count ({{ total_pages }}).
                  Try page 1 or a narrower date range.
                </div>
                <form method="post" action="{{ url_for('admin_pacer_explore_run') }}" class="actions">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="mode" value="parties">
                  <input type="hidden" name="search_mode" value="immediate">
                  <input type="hidden" name="last_name" value="{{ party_values.last_name if party_values else '' }}">
                  <input type="hidden" name="first_name" value="{{ party_values.first_name if party_values else '' }}">
                  <input type="hidden" name="ssn" value="{{ party_values.ssn if party_values else '' }}">
                  <input type="hidden" name="court_id" value="{{ party_values.court_id if party_values else '' }}">
                  <input type="hidden" name="region_code" value="{{ party_values.region_code if party_values else '' }}">
                  <input type="hidden" name="date_filed_from" value="{{ party_values.date_filed_from if party_values else '' }}">
                  <input type="hidden" name="date_filed_to" value="{{ party_values.date_filed_to if party_values else '' }}">
                  <input type="hidden" name="sort_field" value="{{ party_values.sort_field if party_values else '' }}">
                  <input type="hidden" name="sort_order" value="{{ party_values.sort_order if party_values else '' }}">
                  {% if party_values and party_values.exact_name_match %}
                    <input type="hidden" name="exact_name_match" value="true">
                  {% endif %}
                  <input type="hidden" name="page" value="1">
                  <button class="secondary" type="submit">Run page 1</button>
                </form>
              {% endif %}
            {% endif %}
            {% if run_result.search_mode == 'immediate' and run_result.page_info %}
              {% set current_page = run_result.page_number or (run_result.page_info.number + 1 if run_result.page_info.number is not none else 1) %}
              <div class="actions">
                {% if not run_result.page_info.first %}
                  <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="mode" value="parties">
                    <input type="hidden" name="search_mode" value="immediate">
                    <input type="hidden" name="last_name" value="{{ party_values.last_name if party_values else '' }}">
                    <input type="hidden" name="first_name" value="{{ party_values.first_name if party_values else '' }}">
                    <input type="hidden" name="ssn" value="{{ party_values.ssn if party_values else '' }}">
                    <input type="hidden" name="court_id" value="{{ party_values.court_id if party_values else '' }}">
                    <input type="hidden" name="region_code" value="{{ party_values.region_code if party_values else '' }}">
                    <input type="hidden" name="date_filed_from" value="{{ party_values.date_filed_from if party_values else '' }}">
                    <input type="hidden" name="date_filed_to" value="{{ party_values.date_filed_to if party_values else '' }}">
                    <input type="hidden" name="sort_field" value="{{ party_values.sort_field if party_values else '' }}">
                    <input type="hidden" name="sort_order" value="{{ party_values.sort_order if party_values else '' }}">
                    {% if party_values and party_values.exact_name_match %}
                      <input type="hidden" name="exact_name_match" value="true">
                    {% endif %}
                    <input type="hidden" name="page" value="{{ current_page - 1 }}">
                    <button class="secondary" type="submit">Previous page</button>
                  </form>
                {% endif %}
                {% if not run_result.page_info.last %}
                  <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="mode" value="parties">
                    <input type="hidden" name="search_mode" value="immediate">
                    <input type="hidden" name="last_name" value="{{ party_values.last_name if party_values else '' }}">
                    <input type="hidden" name="first_name" value="{{ party_values.first_name if party_values else '' }}">
                    <input type="hidden" name="ssn" value="{{ party_values.ssn if party_values else '' }}">
                    <input type="hidden" name="court_id" value="{{ party_values.court_id if party_values else '' }}">
                    <input type="hidden" name="region_code" value="{{ party_values.region_code if party_values else '' }}">
                    <input type="hidden" name="date_filed_from" value="{{ party_values.date_filed_from if party_values else '' }}">
                    <input type="hidden" name="date_filed_to" value="{{ party_values.date_filed_to if party_values else '' }}">
                    <input type="hidden" name="sort_field" value="{{ party_values.sort_field if party_values else '' }}">
                    <input type="hidden" name="sort_order" value="{{ party_values.sort_order if party_values else '' }}">
                    {% if party_values and party_values.exact_name_match %}
                      <input type="hidden" name="exact_name_match" value="true">
                    {% endif %}
                    <input type="hidden" name="page" value="{{ current_page + 1 }}">
                    <button class="secondary" type="submit">Next page</button>
                  </form>
                {% endif %}
              </div>
            {% endif %}
            {% if run_result.parties %}
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Last name</th>
                      <th>First name</th>
                      <th>Party type</th>
                      <th>Case number</th>
                      <th>Court</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for party in run_result.parties %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ party.lastName or party.last_name or '—' }}</td>
                        <td>{{ party.firstName or party.first_name or '—' }}</td>
                        <td>{{ party.partyType or party.party_type or '—' }}</td>
                        <td>{{ party.courtCase.caseNumber if party.courtCase else (party.court_case.case_number if party.court_case else '—') }}</td>
                        <td>{{ party.courtCase.courtId if party.courtCase else (party.court_case.court_id if party.court_case else party_values.court_id or '—') }}</td>
                      </tr>
                      <tr>
                        <td colspan="6">
                          <details>
                            <summary class="small">Show full PACER record</summary>
                            <pre class="code-block">{{ party | tojson(indent=2) }}</pre>
                          </details>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if run_result.store_payload %}
                <div class="actions">
                  <form method="post" action="{{ url_for('admin_pacer_explore_store') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <textarea name="store_payload" hidden>{{ run_result.store_payload | tojson }}</textarea>
                    <button class="primary" type="submit">Save to database</button>
                  </form>
                  <a class="pill" href="{{ url_for('admin_federal_data_dashboard_case_cards') }}">View saved case cards</a>
                </div>
              {% endif %}
            {% else %}
              <p class="small">No parties were returned for the selected filters.</p>
            {% endif %}
          {% endif %}
        </section>
      {% else %}
        <section class="card stack">
          <p class="pacer-eyebrow">Results</p>
          <h3>Report pending</h3>
          <p class="small">Batch results will be available once the report status is completed.</p>
        </section>
      {% endif %}

      <section class="card stack">
        <p class="pacer-eyebrow">Observed fields</p>
        {% if run_result.mode == 'cases' %}
          <h3>Top-level field coverage</h3>
          {% if run_result.observed_fields %}
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Field</th>
                    <th>Non-empty count</th>
                    <th>Coverage</th>
                  </tr>
                </thead>
                <tbody>
                  {% for field in run_result.observed_fields %}
                    <tr>
                      <td><code>{{ field.field }}</code></td>
                      <td>{{ field.non_empty_count }}</td>
                      <td>{{ '%.1f'|format(field.coverage * 100) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No field observations available yet.</p>
          {% endif %}
        {% else %}
          <h3>Party fields</h3>
          {% if run_result.party_observed_fields %}
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Field</th>
                    <th>Non-empty count</th>
                    <th>Coverage</th>
                  </tr>
                </thead>
                <tbody>
                  {% for field in run_result.party_observed_fields %}
                    <tr>
                      <td><code>{{ field.field }}</code></td>
                      <td>{{ field.non_empty_count }}</td>
                      <td>{{ '%.1f'|format(field.coverage * 100) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No party field observations available yet.</p>
          {% endif %}

          <h3>Court case fields</h3>
          {% if run_result.court_case_observed_fields %}
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Field</th>
                    <th>Non-empty count</th>
                    <th>Coverage</th>
                  </tr>
                </thead>
                <tbody>
                  {% for field in run_result.court_case_observed_fields %}
                    <tr>
                      <td><code>{{ field.field }}</code></td>
                      <td>{{ field.non_empty_count }}</td>
                      <td>{{ '%.1f'|format(field.coverage * 100) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No court case field observations available yet.</p>
          {% endif %}
        {% endif %}
      </section>

      <section class="card stack">
        <p class="pacer-eyebrow">Next steps</p>
        <h3>What to do next</h3>
        <ul class="small">
          {% for step in run_result.next_steps %}
            <li>
              {% if step.active %}
                <strong>{{ step.label }}</strong>
              {% else %}
                {{ step.label }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </section>

      <section class="card stack">
        <p class="pacer-eyebrow">Receipts & cost signals</p>
        <h3>PACER receipts</h3>
        <p class="small">
          This section reports what PACER returned. It does not assume pricing or attempt to compute fees beyond PACER's receipts.
        </p>
        <div class="grid two">
          <div class="card">
            <h4>Totals</h4>
            <p class="small">Billable pages total: <strong>{{ run_result.cost_summary.billable_pages }}</strong></p>
            {% if run_result.cost_summary.fee_totals %}
              <ul class="small">
                {% for key, value in run_result.cost_summary.fee_totals.items() %}
                  <li><code>{{ key }}</code>: {{ '%.2f'|format(value) }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="small">No fee fields were reported.</p>
            {% endif %}
          </div>
          <div class="card">
            <h4>Per page receipts</h4>
            {% if run_result.receipts %}
              <ul class="small">
                {% for receipt in run_result.receipts %}
                  <li>
                    <strong>Page {{ receipt.page }}</strong>
                    <pre class="code-block">{{ receipt.receipt | tojson(indent=2) }}</pre>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="small">No receipts were returned.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <section class="card stack">
        <p class="pacer-eyebrow">Run logs</p>
        <h3>Per-page activity</h3>
        {% if run_result.logs %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Page</th>
                  <th>API page</th>
                  <th>Timestamp (UTC)</th>
                  <th>Endpoint</th>
                  <th>Status</th>
                  <th>Elapsed (ms)</th>
                </tr>
              </thead>
              <tbody>
                {% for log in run_result.logs %}
                  <tr>
                    <td>{{ log.human_display_page or log.page }}</td>
                    <td>{{ log.api_page if log.api_page is not none else '—' }}</td>
                    <td>{{ log.timestamp.replace('T', ' ') }}</td>
                    <td><code>{{ log.endpoint }}</code></td>
                    <td>{{ log.status_code }}</td>
                    <td>{{ log.elapsed_ms }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="small">No run logs available.</p>
        {% endif %}
      </section>

      <section class="card stack">
        <p class="pacer-eyebrow">Raw response</p>
        <h3>Status codes and response snippets</h3>
        <p class="small">
          Each entry shows the HTTP status, endpoint, and a truncated, token-redacted snippet of the response body.
        </p>
        {% if run_result.response_snippets %}
          {% for snippet in run_result.response_snippets %}
            <div class="card">
              <p class="small">
                <strong>Page {{ snippet.page }}</strong>
                {% if snippet.api_page is not none %}
                  · API page {{ snippet.api_page }}
                {% endif %}
                · Status {{ snippet.status_code }} · <code>{{ snippet.endpoint }}</code>
              </p>
              <pre class="code-block">{{ snippet.snippet | tojson(indent=2) }}</pre>
            </div>
          {% endfor %}
        {% else %}
          <p class="small">No response snippets captured.</p>
        {% endif %}
      </section>
    </section>

    <script>
      (function () {
        const copyButton = document.getElementById("copy-debug-bundle");
        const bundle = document.getElementById("debug-bundle");
        if (!copyButton || !bundle) return;

        copyButton.addEventListener("click", async function () {
          const text = bundle.textContent || "";
          try {
            await navigator.clipboard.writeText(text);
            copyButton.textContent = "Copied";
            window.setTimeout(function () {
              copyButton.textContent = "Copy debug bundle";
            }, 1500);
          } catch (err) {
            copyButton.textContent = "Copy failed";
            window.setTimeout(function () {
              copyButton.textContent = "Copy debug bundle";
            }, 1500);
          }
        });
      })();

      (function () {
        const modeControls = document.querySelectorAll("[data-search-mode-control]");
        const toggleFields = (mode) => {
          document.querySelectorAll("[data-search-mode-field]").forEach((field) => {
            const target = field.getAttribute("data-search-mode-field");
            const isMatch = target === mode;
            field.style.display = isMatch ? "" : "none";
            field.querySelectorAll("input, select, textarea").forEach((input) => {
              input.disabled = !isMatch;
            });
          });
        };
        modeControls.forEach((control) => {
          toggleFields(control.value);
          control.addEventListener("change", (event) => {
            toggleFields(event.target.value);
          });
        });
      })();

      (function () {
        const pollForms = document.querySelectorAll("[data-auto-poll-form]");
        pollForms.forEach((form) => {
          const toggle = form.querySelector("[data-auto-poll-toggle]");
          if (!toggle) return;
          let timer = null;
          const stop = () => {
            if (timer) {
              window.clearInterval(timer);
              timer = null;
            }
          };
          const start = () => {
            stop();
            timer = window.setInterval(() => {
              form.submit();
            }, 15000);
          };
          toggle.addEventListener("change", () => {
            if (toggle.checked) {
              start();
            } else {
              stop();
            }
          });
          window.addEventListener("beforeunload", stop);
        });
      })();
    </script>
  {% endif %}

  <section class="card stack">
    <p class="pacer-eyebrow">Saved searches</p>
    <h3>Stored PACER search runs</h3>
    <p class="small">
      These runs represent stored data in the database. Use this list to confirm deduping and traceability.
    </p>
    {% if search_run_history %}
      <div class="stack">
        {% for run in search_run_history %}
          <div class="card">
            <div class="row row--spread">
              <div>
                <p class="small"><strong>{{ run.search_type|capitalize }}</strong> · {{ run.search_mode|capitalize }} · {{ run.created_at_display }}</p>
                <p class="small">
                  Court: <code>{{ run.court_id or 'All' }}</code>
                  {% if run.date_from or run.date_to %}
                    · Date range: {{ run.date_from or '—' }} → {{ run.date_to or '—' }}
                  {% endif %}
                </p>
                <p class="small">
                  New cases: {{ run.cases_inserted or 0 }} · Updated cases: {{ run.cases_updated or 0 }}
                  · New parties: {{ run.parties_inserted or 0 }} · Updated parties: {{ run.parties_updated or 0 }}
                </p>
                {% if run.report_id %}
                  <p class="small">Report ID: <code>{{ run.report_id }}</code> · Status: {{ run.report_status or '—' }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No saved runs yet.</p>
    {% endif %}
  </section>

  <section class="card stack">
    <p class="pacer-eyebrow">Recent runs</p>
    <h3>Saved Explore PACER runs</h3>
    <p class="small">
      Recent runs are saved for debugging and receipts review. Storage is capped to the most recent entries.
    </p>
    {% if run_history %}
      <div class="stack">
        {% for run in run_history %}
          <div class="card">
            <div class="row row--spread">
              <div>
                <p class="small"><strong>{{ run.mode|capitalize }}</strong> · {{ run.created_at_display }}</p>
                <p class="small">
                  Court: <code>{{ run.court_id or 'All' }}</code>
                  {% if run.date_from or run.date_to %}
                    · Date range: {{ run.date_from or '—' }} → {{ run.date_to or '—' }}
                  {% endif %}
                  · Pages fetched: {{ run.pages_fetched }}
                </p>
                {% if run.error_summary %}
                  <p class="small"><strong>Error:</strong> {{ run.error_summary }}</p>
                {% endif %}
              </div>
              <div class="actions">
                <form method="post" action="{{ url_for('admin_pacer_explore_run_delete', run_id=run.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="mode" value="{{ mode }}">
                  <button class="secondary" type="submit">Delete run</button>
                </form>
              </div>
            </div>

            <div class="grid two">
              <div>
                <h4>Receipts</h4>
                {% if run.receipts %}
                  <pre class="code-block">{{ run.receipts | tojson(indent=2) }}</pre>
                {% else %}
                  <p class="small">No receipts saved.</p>
                {% endif %}
              </div>
              <div>
                <h4>Observed fields</h4>
                {% if run.observed_fields %}
                  <pre class="code-block">{{ run.observed_fields | tojson(indent=2) }}</pre>
                {% else %}
                  <p class="small">No observed field summary saved.</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No saved runs yet.</p>
    {% endif %}
  </section>
  <script>
    (function () {
      const filters = document.querySelectorAll("[data-filter-input]");
      filters.forEach((input) => {
        const targetId = input.getAttribute("data-filter-input");
        const select = document.getElementById(targetId);
        if (!select) return;
        const options = Array.from(select.options).map((opt) => ({
          value: opt.value,
          label: opt.textContent || "",
          selected: opt.selected,
        }));
        const placeholder = options.shift();
        input.addEventListener("input", () => {
          const query = input.value.trim().toLowerCase();
          select.innerHTML = "";
          if (placeholder) {
            const placeholderOpt = document.createElement("option");
            placeholderOpt.value = placeholder.value;
            placeholderOpt.textContent = placeholder.label;
            placeholderOpt.selected = placeholder.selected;
            select.appendChild(placeholderOpt);
          }
          options.forEach((opt) => {
            const label = opt.label.toLowerCase();
            const value = String(opt.value).toLowerCase();
            if (!query || label.includes(query) || value.includes(query)) {
              const optionEl = document.createElement("option");
              optionEl.value = opt.value;
              optionEl.textContent = opt.label;
              optionEl.selected = opt.selected;
              select.appendChild(optionEl);
            }
          });
        });
      });
    })();
  </script>
{% endblock %}
