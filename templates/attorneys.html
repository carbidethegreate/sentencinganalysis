{% extends "base.html" %}

{% block title %}Attorneys | CourtDataPro{% endblock %}

{% block content %}
  <section class="card attorney-shell">
    {% set advanced_filters_open = filters.sort != 'cases_desc' or filters.page_size != 25 or filters.has_email or filters.has_phone or filters.has_address %}
    {% set active_filter_count = (1 if filters.q else 0) + (1 if filters.court_id else 0) + (1 if filters.case_type else 0) + (1 if filters.has_email else 0) + (1 if filters.has_phone else 0) + (1 if filters.has_address else 0) + (1 if filters.sort and filters.sort != 'cases_desc' else 0) %}
    <div class="attorney-toolbar">
      <div>
        <p class="pacer-eyebrow">Directory</p>
        <h1>Docket attorneys</h1>
        <p class="small">Find counsel quickly by name, contact details, office, or related case.</p>
      </div>
      <div class="pcl-cases-summary">
        <strong>{{ pagination.total }}</strong>
        <span class="small">attorney records</span>
      </div>
    </div>
    <p class="small attorney-results-meta">
      Attorney-focused mode: all saved contact lines are visible on each card.
    </p>

    <form method="get" class="pcl-filter-form attorney-filter-form" aria-label="Filter docket attorneys">
      <input type="hidden" name="page" value="1">
      <div class="grid three">
        <div>
          <label for="attorney-search">Search</label>
          <input id="attorney-search" name="q" value="{{ filters.q or '' }}" placeholder="Name, email, phone, organization, case">
        </div>
        <div>
          <label for="attorney-court">Court</label>
          <select id="attorney-court" name="court_id">
            <option value="">All courts</option>
            {% for court in available_courts %}
              <option value="{{ court }}" {% if filters.court_id == court %}selected{% endif %}>{{ court }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="attorney-case-type">Case type</label>
          <select id="attorney-case-type" name="case_type">
            <option value="">All case types</option>
            {% for value in available_case_types %}
              <option value="{{ value }}" {% if filters.case_type == value %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <details class="attorney-advanced-filters" {% if advanced_filters_open %}open{% endif %}>
        <summary class="pcl-detail-summary">Advanced filters</summary>
        <div class="grid three attorney-filter-secondary">
          <div>
            <label for="attorney-sort">Sort</label>
            <select id="attorney-sort" name="sort">
              <option value="cases_desc" {% if filters.sort == 'cases_desc' %}selected{% endif %}>Most cases</option>
              <option value="recent_desc" {% if filters.sort == 'recent_desc' %}selected{% endif %}>Recently updated</option>
              <option value="contacts_desc" {% if filters.sort == 'contacts_desc' %}selected{% endif %}>Most contact info</option>
              <option value="name_asc" {% if filters.sort == 'name_asc' %}selected{% endif %}>Name (A–Z)</option>
            </select>
          </div>
          <div>
            <label for="attorney-page-size">Rows per page</label>
            <select id="attorney-page-size" name="page_size">
              <option value="25" {% if filters.page_size == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if filters.page_size == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if filters.page_size == 100 %}selected{% endif %}>100</option>
            </select>
          </div>
          <div class="attorney-filter-toggles">
            <label><input type="checkbox" name="has_email" value="1" {% if filters.has_email %}checked{% endif %}> Has email</label>
            <label><input type="checkbox" name="has_phone" value="1" {% if filters.has_phone %}checked{% endif %}> Has phone</label>
            <label><input type="checkbox" name="has_address" value="1" {% if filters.has_address %}checked{% endif %}> Has address</label>
          </div>
        </div>
      </details>
      <div class="actions pcl-filter-actions">
        <button class="primary" type="submit">Search directory</button>
        <a class="pill" href="{{ url_for('attorneys') }}">Reset</a>
        <span class="small">Showing {{ attorneys|length }} on this page</span>
      </div>
      {% if active_filter_count > 0 %}
        <div class="attorney-active-filters">
          <span class="small">Active filters:</span>
          {% if filters.q %}<span class="attorney-filter-chip">Search: {{ filters.q }}</span>{% endif %}
          {% if filters.court_id %}<span class="attorney-filter-chip">Court: {{ filters.court_id }}</span>{% endif %}
          {% if filters.case_type %}<span class="attorney-filter-chip">Case type: {{ filters.case_type }}</span>{% endif %}
          {% if filters.sort and filters.sort != 'cases_desc' %}<span class="attorney-filter-chip">Sort: {{ filters.sort }}</span>{% endif %}
          {% if filters.has_email %}<span class="attorney-filter-chip">Has email</span>{% endif %}
          {% if filters.has_phone %}<span class="attorney-filter-chip">Has phone</span>{% endif %}
          {% if filters.has_address %}<span class="attorney-filter-chip">Has address</span>{% endif %}
        </div>
      {% endif %}
    </form>
  </section>

  {% if attorneys %}
    <section class="attorney-grid" aria-live="polite">
      {% for attorney in attorneys %}
        <article class="card attorney-card">
          <header class="attorney-card__header">
            <div>
              <h2 class="attorney-card__name">{{ attorney.name }}</h2>
              <p class="small">
                {% if attorney.last_seen_at %}Last seen {{ attorney.last_seen_at.strftime('%Y-%m-%d %H:%M') }} UTC{% else %}Last seen —{% endif %}
              </p>
              <div class="attorney-meta attorney-meta--tight">
                <span class="attorney-chip">{{ attorney.case_count }} cases</span>
                <span class="attorney-chip">{{ attorney.contact_count or ((attorney.emails|length) + (attorney.phones|length) + (attorney.faxes|length)) }} contacts</span>
              </div>
            </div>
            <div class="attorney-card__actions">
              <button
                type="button"
                class="pill attorney-copy-btn"
                data-copy-target="att-copy-{{ loop.index0 }}"
              >Copy full contact</button>
            </div>
          </header>
          {% set copy_lines = ([attorney.name] + (attorney.organizations or []) + (attorney.all_lines or [])) %}
          <pre id="att-copy-{{ loop.index0 }}" class="attorney-copy-source">{{ copy_lines | join('\n') }}</pre>

          <div class="attorney-contact-grid">
            <div>
              <p class="small attorney-field-label">Email</p>
              {% if attorney.emails %}
                <ul class="attorney-contact-list">
                  {% for email in attorney.emails %}
                    <li><a href="mailto:{{ email }}">{{ email }}</a></li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">—</p>
              {% endif %}
            </div>
            <div>
              <p class="small attorney-field-label">Phone</p>
              {% if attorney.phones %}
                <ul class="attorney-contact-list">
                  {% for phone in attorney.phones %}
                    <li><a href="tel:{{ phone|replace(' ', '') }}">{{ phone }}</a></li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">—</p>
              {% endif %}
            </div>
            <div>
              <p class="small attorney-field-label">Fax</p>
              {% if attorney.faxes %}
                <ul class="attorney-contact-list">
                  {% for fax in attorney.faxes %}
                    <li>{{ fax }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">—</p>
              {% endif %}
            </div>
            <div>
              <p class="small attorney-field-label">Web</p>
              {% if attorney.websites %}
                <ul class="attorney-contact-list">
                  {% for site in attorney.websites %}
                    {% set site_href = site if site.startswith('http://') or site.startswith('https://') else 'https://' ~ site %}
                    <li><a href="{{ site_href }}" target="_blank" rel="noopener">{{ site }}</a></li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">—</p>
              {% endif %}
            </div>
          </div>

          {% if attorney.addresses %}
            <div class="attorney-address">
              <p class="small attorney-field-label">Address</p>
              <ul class="attorney-contact-list">
                {% for line in attorney.addresses %}
                  <li>{{ line }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if attorney.all_lines %}
            <div class="attorney-docket-lines">
              <p class="small attorney-field-label">Full contact block (from docket)</p>
              <div class="attorney-docket-lines__body">
                <ul class="attorney-contact-list">
                  {% for line in attorney.all_lines %}
                    <li>{{ line }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% endif %}

          {% if attorney.organizations or attorney.designations or attorney.roles %}
            <div class="attorney-tags">
              {% for organization in attorney.organizations %}
                <span class="attorney-tag">{{ organization }}</span>
              {% endfor %}
              {% for designation in attorney.designations %}
                <span class="attorney-tag">{{ designation }}</span>
              {% endfor %}
              {% for role in attorney.roles %}
                <span class="attorney-tag">{{ role }}</span>
              {% endfor %}
            </div>
          {% endif %}

          <section class="attorney-related">
            <p class="small attorney-field-label">Recent related cases</p>
            <ul class="attorney-case-list">
              {% for case in attorney.related_cases[:3] %}
                <li class="attorney-case-item">
                  <div>
                    {{ case.case_number_full or case.case_number or 'Case' }}
                    <div class="small">{{ case.short_title or case.case_title or 'Untitled case' }}</div>
                  </div>
                  <div class="small">
                    {{ case.court_id or '—' }} · {{ case.case_type or '—' }}{% if case.date_filed %} · {{ case.date_filed.isoformat() }}{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </section>

          {% if attorney.related_cases|length > 5 %}
            <details class="attorney-details">
              <summary class="pcl-detail-summary">Show all related cases ({{ attorney.related_cases|length }})</summary>
              <div class="table-wrap mt-8">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Case</th>
                      <th>Court</th>
                      <th>Type</th>
                      <th>Filed</th>
                      <th>Party</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for case in attorney.related_cases %}
                      <tr>
                        <td>
                          {{ case.case_number_full or case.case_number or 'Case' }}
                          <div class="small">{{ case.short_title or case.case_title or 'Untitled case' }}</div>
                        </td>
                        <td>{{ case.court_id or '—' }}</td>
                        <td>{{ case.case_type or '—' }}</td>
                        <td>{{ case.date_filed.isoformat() if case.date_filed else '—' }}</td>
                        <td>
                          {{ case.party_name or '—' }}
                          {% if case.party_type %}<div class="small">{{ case.party_type }}</div>{% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </details>
          {% endif %}
        </article>
      {% endfor %}
    </section>
  {% else %}
    <div class="card pcl-empty-state">
      <h2>No attorneys match those filters</h2>
      <p class="small">Pull more dockets to expand the directory, or broaden filters.</p>
    </div>
  {% endif %}

  <nav class="pcl-pagination" aria-label="Attorney pagination">
    {% set total_pages = pagination.total_pages %}
    {% set current_page = pagination.page %}
    <span class="small">Page {{ current_page }} of {{ total_pages }}</span>
    <div class="pcl-pagination__actions">
      <a class="pill {% if current_page <= 1 %}disabled{% endif %}" href="{{ page_url(current_page - 1) if current_page > 1 else '#' }}" aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">Previous</a>
      <a class="pill {% if current_page >= total_pages %}disabled{% endif %}" href="{{ page_url(current_page + 1) if current_page < total_pages else '#' }}" aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">Next</a>
    </div>
  </nav>

  <script>
    (function () {
      function setCopyButtonState(button, text, timeoutMs) {
        var original = button.getAttribute("data-label") || button.textContent;
        button.textContent = text;
        window.setTimeout(function () {
          button.textContent = original;
        }, timeoutMs || 1200);
      }
      document.addEventListener("click", async function (event) {
        var button = event.target.closest(".attorney-copy-btn");
        if (!button) return;
        var targetId = button.getAttribute("data-copy-target");
        if (!targetId) return;
        var source = document.getElementById(targetId);
        if (!source) return;
        var text = (source.textContent || "").trim();
        if (!text) return;
        if (!button.getAttribute("data-label")) {
          button.setAttribute("data-label", button.textContent);
        }
        try {
          await navigator.clipboard.writeText(text);
          setCopyButtonState(button, "Copied", 1400);
        } catch (err) {
          setCopyButtonState(button, "Copy failed", 1800);
        }
      });
    })();
  </script>
{% endblock %}
