{% extends "base.html" %}

{% block title %}Profile | CourtDataPro{% endblock %}

{% block content %}
  <div class="card">
    <h1>Your profile</h1>
    <p class="small">Update your account details below.</p>

    <form method="post" action="{{ url_for('profile') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <div class="grid two" style="margin-top: 14px;">
        <div>
          <label for="first_name">First name</label>
          <input id="first_name" name="first_name" value="{{ user.get('first_name','') }}" required>
        </div>
        <div>
          <label for="last_name">Last name</label>
          <input id="last_name" name="last_name" value="{{ user.get('last_name','') }}" required>
        </div>
      </div>

      <div class="grid two" style="margin-top: 14px;">
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" value="{{ user.get('email','') }}" required>
          <div class="newsletter-toggle">
            <label class="toggle">
              <input
                type="checkbox"
                name="newsletter_opt_in"
                {% if newsletter_opt_in %}checked{% endif %}
              >
              <span class="toggle-slider" aria-hidden="true"></span>
              <span class="toggle-label" aria-live="polite">
                Newsletter: <strong data-newsletter-label>{{ "Subscribed" if newsletter_opt_in else "Not subscribed" }}</strong>
              </span>
            </label>
          </div>
        </div>
        <div>
          <label for="user_type">User type</label>
          <select id="user_type" name="user_type" required>
            <option value="">Select one</option>
            {% for t in user_types %}
              <option value="{{ t }}" {% if user.get('user_type') == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div id="firm_fields" class="grid two" style="margin-top: 14px; display: none;">
        <div>
          <label for="firm_name">Firm name (required for law firm)</label>
          <input id="firm_name" name="firm_name" value="{{ user.get('firm_name','') }}">
        </div>
        <div>
          <label for="title">Title (required for law firm)</label>
          <input id="title" name="title" value="{{ user.get('title','') }}">
        </div>
      </div>

      <h2 style="margin-top: 22px;">Contact and location</h2>

      <div class="grid two" style="margin-top: 14px;">
        <div>
          <label for="phone">Phone</label>
          <input id="phone" name="phone" value="{{ user.get('phone','') }}">
        </div>
        <div>
          <label for="address">Address</label>
          <input id="address" name="address" value="{{ user.get('address','') }}">
        </div>
      </div>

      <div class="grid two" style="margin-top: 14px;">
        <div>
          <label for="city">City</label>
          <input id="city" name="city" value="{{ user.get('city','') }}">
        </div>
        <div>
          <label for="state">State</label>
          <input id="state" name="state" value="{{ user.get('state','') }}">
        </div>
      </div>

      <div class="grid two" style="margin-top: 14px;">
        <div>
          <label for="zip">Zip</label>
          <input id="zip" name="zip" value="{{ user.get('zip','') }}">
        </div>
        <div>
          <label for="county">County</label>
          <input id="county" name="county" value="{{ user.get('county','') }}">
        </div>
      </div>

      <div style="margin-top: 14px;">
        <label for="country">Country</label>
        <input id="country" name="country" value="{{ user.get('country','') }}">
      </div>

      <h2 style="margin-top: 22px;">Other details</h2>

      <div style="margin-top: 14px;">
        <label>
          <input type="checkbox" name="has_pacer_account" {% if user.get('has_pacer_account') %}checked{% endif %}>
          Do you have a PACER account?
        </label>
      </div>

      <div style="margin-top: 14px;">
        <label for="heard_about_us">How did you hear about us?</label>
        <textarea id="heard_about_us" name="heard_about_us">{{ user.get('heard_about_us','') }}</textarea>
      </div>

      <div style="margin-top: 14px;">
        <label for="referral_code">Referral code</label>
        <input id="referral_code" name="referral_code" value="{{ user.get('referral_code','') }}">
      </div>

      <div class="actions" style="margin-top: 16px;">
        <button class="primary" type="submit">Save changes</button>
        <a class="pill" href="{{ url_for('dashboard') }}">Back to dashboard</a>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const userType = document.getElementById('user_type');
      const firmFields = document.getElementById('firm_fields');
      const firmName = document.getElementById('firm_name');
      const title = document.getElementById('title');
      const newsletterCheckbox = document.querySelector('input[name="newsletter_opt_in"]');
      const newsletterLabel = document.querySelector('[data-newsletter-label]');

      function toggleFirmFields() {
        const isLawFirm = userType.value === 'Attorney, Law Firm';
        firmFields.style.display = isLawFirm ? 'grid' : 'none';
        firmName.required = isLawFirm;
        title.required = isLawFirm;
      }

      function updateNewsletterLabel() {
        if (!newsletterCheckbox || !newsletterLabel) {
          return;
        }

        newsletterLabel.textContent = newsletterCheckbox.checked
          ? 'Subscribed'
          : 'Not subscribed';
      }

      userType.addEventListener('change', toggleFirmFields);
      if (newsletterCheckbox) {
        newsletterCheckbox.addEventListener('change', updateNewsletterLabel);
      }
      toggleFirmFields();
      updateNewsletterLabel();
    })();
  </script>
{% endblock %}
