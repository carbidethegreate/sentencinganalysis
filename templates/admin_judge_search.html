{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | Judge PACER Search{% endblock %}

{% block federal_content %}
  <section class="card stack">
    <div class="page-header page-header--tight">
      <h2>Specific Judge Workflow</h2>
      <p class="small">
        Pick a district and date range, start the background case search, then review cases and queue docket pulls.
      </p>
    </div>

    <div class="wizard" data-wizard>
      <div class="wizard-progress" aria-label="Judge search steps">
        <div class="wizard-progress__step" data-wizard-progress="1">
          <span class="wizard-progress__num">1</span>
          <span class="wizard-progress__label">Court</span>
        </div>
        <div class="wizard-progress__step" data-wizard-progress="2">
          <span class="wizard-progress__num">2</span>
          <span class="wizard-progress__label">Dates</span>
        </div>
        <div class="wizard-progress__step" data-wizard-progress="3">
          <span class="wizard-progress__num">3</span>
          <span class="wizard-progress__label">Thresholds</span>
        </div>
        <div class="wizard-progress__step" data-wizard-progress="4">
          <span class="wizard-progress__num">4</span>
          <span class="wizard-progress__label">Start</span>
        </div>
      </div>

      <form
        method="post"
        action="{{ url_for('admin_federal_data_dashboard_judge_search_start') }}"
        class="stack wizard-form"
        id="judge-search-form"
        novalidate
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="court_id" id="court-id" value="{{ selected_court_id }}">
        <input type="hidden" name="max_batch_iterations" value="300">

	        <section class="wizard-step" data-wizard-step="1">
	          <h3>Step 1 of 4: Choose the district court</h3>
	          <p class="small">Start by selecting where the case was filed.</p>

	          <div class="court-picker">
	            <label for="court-query">District court</label>
	            <input
	              id="court-query"
	              type="search"
	              placeholder="Start typing a court name (example: Pennsylvania Eastern)"
	              autocomplete="off"
	              spellcheck="false"
	              role="combobox"
	              aria-autocomplete="list"
	              aria-expanded="false"
	              aria-controls="court-results"
	              aria-haspopup="listbox"
	            >

	            <div class="small court-picker__meta" id="court-meta" aria-live="polite">
	              Start typing to search {{ court_choices|length }} district courts.
	            </div>

	            <div class="court-picker__results" id="court-results" role="listbox" aria-label="Court suggestions" hidden></div>

	            <div class="wizard-selected small" id="court-selected" aria-live="polite"></div>
	            <div class="wizard-error small" id="wizard-error-1" aria-live="polite"></div>
	          </div>

	          <div class="wizard-actions">
	            <button type="button" class="primary" data-wizard-next id="wizard-next-1" {% if not selected_court_id %}disabled{% endif %}>Continue</button>
	          </div>
	        </section>

        <section class="wizard-step" data-wizard-step="2" hidden>
          <h3>Step 2 of 4: Choose the date range</h3>
          <p class="small">For sentencing habit analysis, start with January 1, 2010 through today.</p>

          <div class="grid two">
            <div>
              <label for="date-from">Date filed from</label>
              <input id="date-from" type="date" name="date_filed_from" value="{{ date_from }}" required>
            </div>
            <div>
              <label for="date-to">Date filed to</label>
              <input id="date-to" type="date" name="date_filed_to" value="{{ date_to }}" required>
            </div>
          </div>

          <div class="wizard-error small" id="wizard-error-2" aria-live="polite"></div>

          <div class="wizard-actions">
            <button type="button" class="secondary" data-wizard-back>Back</button>
            <button type="button" class="primary" data-wizard-next>Continue</button>
          </div>
        </section>

        <section class="wizard-step" data-wizard-step="3" hidden>
          <h3>Step 3 of 4: Set thresholds</h3>
          <p class="small">Start with a small test run to confirm results before running the full date range.</p>

          <fieldset class="stack wizard-fieldset">
            <legend class="small">Case types</legend>
            <div class="grid two">
              {% for case_type in case_type_choices %}
                <label class="wizard-radio">
                  <input
                    type="checkbox"
                    name="case_types"
                    value="{{ case_type }}"
                    {% if case_type in selected_case_types %}checked{% endif %}
                  >
                  {{ case_type|upper }}
                </label>
              {% endfor %}
            </div>
            <p class="small mt-8">Tip: start with <strong>CR</strong> for sentencing analysis.</p>
          </fieldset>

          <fieldset class="stack wizard-fieldset">
            <legend class="small">Run type</legend>
            <label class="wizard-radio">
              <input
                type="radio"
                name="search_scope"
                value="limited"
                {% if search_scope != 'all' %}checked{% endif %}
              >
              Test run (recommended first)
            </label>

            <div class="wizard-cap">
              <label for="max-cases">Maximum cases</label>
              <input
                id="max-cases"
                type="number"
                name="max_cases"
                min="1"
                max="5000"
                value="{{ max_cases }}"
              >
              <div class="actions wizard-cap__quick">
                <button type="button" class="pill" data-max-cases="5">5</button>
                <button type="button" class="pill" data-max-cases="25">25</button>
                <button type="button" class="pill" data-max-cases="100">100</button>
              </div>
            </div>

            <label class="wizard-radio">
              <input type="radio" name="search_scope" value="all" {% if search_scope == 'all' %}checked{% endif %}>
              Full run (entire date range)
            </label>
          </fieldset>

          <div class="wizard-error small" id="wizard-error-3" aria-live="polite"></div>

          <div class="wizard-actions">
            <button type="button" class="secondary" data-wizard-back>Back</button>
            <button type="button" class="primary" data-wizard-next>Continue</button>
          </div>
        </section>

        <section class="wizard-step" data-wizard-step="4" hidden>
          <h3>Step 4 of 4: Confirm and start</h3>
          <p class="small">Review your choices, then start the PACER case search.</p>

          <div class="wizard-summary" role="status" aria-live="polite">
            <div>
              <span class="wizard-summary__label">Court</span>
              <strong class="wizard-summary__value" id="summary-court">—</strong>
            </div>
            <div>
              <span class="wizard-summary__label">Date range</span>
              <strong class="wizard-summary__value" id="summary-dates">—</strong>
            </div>
            <div>
              <span class="wizard-summary__label">Case cap</span>
              <strong class="wizard-summary__value" id="summary-cap">—</strong>
            </div>
            <div>
              <span class="wizard-summary__label">Case types</span>
              <strong class="wizard-summary__value" id="summary-case-types">—</strong>
            </div>
          </div>

          <div class="wizard-actions">
            <button type="button" class="secondary" data-wizard-back>Back</button>
            <button class="primary" type="submit" id="wizard-submit">Start search</button>
          </div>
        </section>
      </form>
    </div>
  </section>

  <script>
    (function () {
      const wizardRoot = document.querySelector("[data-wizard]");
      if (!wizardRoot) return;

      const form = document.getElementById("judge-search-form");
      const stepEls = Array.from(document.querySelectorAll("[data-wizard-step]"));
      const progressEls = Array.from(document.querySelectorAll("[data-wizard-progress]"));
      const nextButtons = Array.from(document.querySelectorAll("[data-wizard-next]"));
      const backButtons = Array.from(document.querySelectorAll("[data-wizard-back]"));

      const errorByStep = {
        1: document.getElementById("wizard-error-1"),
        2: document.getElementById("wizard-error-2"),
        3: document.getElementById("wizard-error-3"),
      };

      const courtHidden = document.getElementById("court-id");
      const courtQuery = document.getElementById("court-query");
      const courtMeta = document.getElementById("court-meta");
      const courtResults = document.getElementById("court-results");
      const courtSelected = document.getElementById("court-selected");
      const courtContinue = document.getElementById("wizard-next-1");
      const courtChoices = {{ court_choices | tojson }};

      const dateFrom = document.getElementById("date-from");
      const dateTo = document.getElementById("date-to");

      const maxCasesInput = document.getElementById("max-cases");
      const scopeLimited = document.querySelector("input[name=\"search_scope\"][value=\"limited\"]");
      const scopeAll = document.querySelector("input[name=\"search_scope\"][value=\"all\"]");
      const quickCaps = Array.from(document.querySelectorAll("[data-max-cases]"));

      const summaryCourt = document.getElementById("summary-court");
      const summaryDates = document.getElementById("summary-dates");
      const summaryCap = document.getElementById("summary-cap");
      const summaryCaseTypes = document.getElementById("summary-case-types");

      const caseTypeCheckboxes = Array.from(document.querySelectorAll("input[name=\"case_types\"]"));

      let currentStep = Number({{ initial_step|default(1)|int }}) || 1;
      if (currentStep < 1 || currentStep > 4) currentStep = 1;

      const setError = (step, message) => {
        const el = errorByStep[step];
        if (!el) return;
        el.textContent = message || "";
        if (message) {
          el.classList.add("is-visible");
        } else {
          el.classList.remove("is-visible");
        }
      };

      const normalize = (value) => (value || "").toString().trim().toLowerCase();

      const courtIdToChoice = new Map();
      if (Array.isArray(courtChoices)) {
        for (const court of courtChoices) {
          if (!court || !court.id) continue;
          courtIdToChoice.set(normalize(court.id), court);
        }
      }

      const getSelectedCourt = () => {
        const selectedId = normalize(courtHidden && courtHidden.value);
        if (!selectedId) return null;
        return courtIdToChoice.get(selectedId) || null;
      };

      const activeCourtLabel = () => {
        const court = getSelectedCourt();
        if (!court) return "";
        return court.label || court.name || court.id;
      };

      let courtMatches = [];
      let activeCourtMatchIndex = -1;
      const MAX_COURT_RESULTS = 8;

      const closeCourtSuggestions = () => {
        if (courtResults) {
          courtResults.hidden = true;
          courtResults.innerHTML = "";
        }
        if (courtQuery) {
          courtQuery.setAttribute("aria-expanded", "false");
          courtQuery.removeAttribute("aria-activedescendant");
        }
        activeCourtMatchIndex = -1;
      };

      const openCourtSuggestions = () => {
        if (courtResults) {
          courtResults.hidden = false;
        }
        if (courtQuery) {
          courtQuery.setAttribute("aria-expanded", "true");
        }
      };

      const syncActiveCourtOption = () => {
        if (!courtResults) return;
        const options = Array.from(courtResults.querySelectorAll(".court-picker__option"));
        for (let i = 0; i < options.length; i += 1) {
          options[i].classList.toggle("is-active", i === activeCourtMatchIndex);
        }
      };

      const renderHighlightedText = (text, q) => {
        const frag = document.createDocumentFragment();
        const lower = (text || "").toLowerCase();
        const idx = q ? lower.indexOf(q) : -1;
        if (idx < 0 || !q) {
          frag.append(document.createTextNode(text));
          return frag;
        }
        const before = text.slice(0, idx);
        const match = text.slice(idx, idx + q.length);
        const after = text.slice(idx + q.length);
        if (before) frag.append(document.createTextNode(before));
        const mark = document.createElement("mark");
        mark.textContent = match;
        frag.append(mark);
        if (after) frag.append(document.createTextNode(after));
        return frag;
      };

      const renderCourtSuggestions = (queryLower, totalMatches) => {
        if (!courtResults) return;
        courtResults.innerHTML = "";

        if (!totalMatches) {
          const empty = document.createElement("div");
          empty.className = "court-picker__empty small";
          empty.textContent = "No matching courts. Try a shorter search (example: \"Pennsylvania\").";
          courtResults.append(empty);
          return;
        }

        const display = courtMatches.slice(0, MAX_COURT_RESULTS);
        for (let i = 0; i < display.length; i += 1) {
          const court = display[i];
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "court-picker__option";
          btn.id = `court-option-${i}`;
          btn.setAttribute("role", "option");
          btn.dataset.courtId = court.id;

          const nameEl = document.createElement("span");
          nameEl.className = "court-picker__name";
          nameEl.append(renderHighlightedText(court.name || court.label || court.id, queryLower));

          const idEl = document.createElement("span");
          idEl.className = "court-picker__id";
          idEl.textContent = court.id;

          btn.append(nameEl, idEl);

          btn.addEventListener("click", () => {
            setSelectedCourt(court);
          });

          courtResults.append(btn);
        }
        syncActiveCourtOption();
      };

      const scoreCourt = (court, queryLower) => {
        const name = normalize(court && (court.name || court.label || ""));
        const id = normalize(court && court.id);
        if (!queryLower) return 9999;
        if (name.startsWith(queryLower)) return 0;
        if (id.startsWith(queryLower)) return 1;
        if (name.includes(queryLower)) return 2;
        if (id.includes(queryLower)) return 3;
        return 50;
      };

      const updateCourtSuggestions = () => {
        if (!courtQuery || !Array.isArray(courtChoices)) return;
        const queryRaw = (courtQuery.value || "").trim();
        const queryLower = queryRaw.toLowerCase();

        if (!queryLower) {
          closeCourtSuggestions();
          if (courtMeta) {
            const selectedLabel = activeCourtLabel();
            courtMeta.textContent = selectedLabel
              ? `Selected: ${selectedLabel}. Type to change the court.`
              : `Start typing to search ${courtChoices.length} district courts.`;
          }
          return;
        }

        const matches = [];
        for (const court of courtChoices) {
          if (!court) continue;
          const haystack = `${court.name || ""} ${court.label || ""} ${court.id || ""}`.toLowerCase();
          if (haystack.includes(queryLower)) {
            matches.push(court);
          }
        }

        matches.sort((a, b) => {
          const scoreA = scoreCourt(a, queryLower);
          const scoreB = scoreCourt(b, queryLower);
          if (scoreA !== scoreB) return scoreA - scoreB;
          return normalize(a.name).localeCompare(normalize(b.name));
        });

        courtMatches = matches;
        activeCourtMatchIndex = matches.length ? 0 : -1;
        openCourtSuggestions();
        renderCourtSuggestions(queryLower, matches.length);
        syncActiveCourtOption();

        // If the user hasn't explicitly clicked a court yet, allow "Continue" when
        // there's at least one match (we'll auto-pick the top match on continue).
        if (courtContinue && !getSelectedCourt()) {
          courtContinue.disabled = matches.length === 0;
        }

        if (courtMeta) {
          const showing = Math.min(MAX_COURT_RESULTS, matches.length);
          courtMeta.textContent = matches.length
            ? `${matches.length} match(es). Showing ${showing}. Press Enter to select the top match.`
            : "No matches.";
        }

        if (courtQuery && activeCourtMatchIndex >= 0) {
          courtQuery.setAttribute("aria-activedescendant", `court-option-${activeCourtMatchIndex}`);
        }

        renderSelectedCourt();
      };

      const setSelectedCourt = (court) => {
        if (!courtHidden || !court || !court.id) return;
        courtHidden.value = normalize(court.id);
        if (courtQuery) {
          courtQuery.value = court.name || court.label || court.id;
        }
        setError(1, "");
        renderSelectedCourt();
        closeCourtSuggestions();
        if (currentStep === 1) {
          showStep(2);
        }
      };

      const renderSelectedCourt = () => {
        const label = activeCourtLabel();
        const query = (courtQuery && (courtQuery.value || "").trim()) || "";
        const hasMatches = !label && query && courtMatches.length;
        if (courtSelected) {
          courtSelected.textContent = label
            ? `Selected court: ${label}`
            : hasMatches
              ? `Press Continue to select the top match: ${(courtMatches[0].label || courtMatches[0].name || courtMatches[0].id)}`
            : "No court selected yet. Type a court name above and choose a match.";
        }
        if (courtContinue) {
          courtContinue.disabled = !(label || hasMatches);
        }
      };

      if (courtQuery) {
        courtQuery.addEventListener("input", () => {
          updateCourtSuggestions();
        });

        courtQuery.addEventListener("focus", () => {
          if ((courtQuery.value || "").trim()) {
            updateCourtSuggestions();
          }
        });

        courtQuery.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            closeCourtSuggestions();
            return;
          }

          if (event.key === "ArrowDown" || event.key === "ArrowUp") {
            if (!courtMatches.length) return;
            event.preventDefault();
            openCourtSuggestions();

            const delta = event.key === "ArrowDown" ? 1 : -1;
            const maxIndex = Math.min(MAX_COURT_RESULTS, courtMatches.length) - 1;
            let nextIndex = activeCourtMatchIndex + delta;
            if (nextIndex < 0) nextIndex = maxIndex;
            if (nextIndex > maxIndex) nextIndex = 0;
            activeCourtMatchIndex = nextIndex;

            courtQuery.setAttribute("aria-activedescendant", `court-option-${activeCourtMatchIndex}`);
            syncActiveCourtOption();
            const activeEl = document.getElementById(`court-option-${activeCourtMatchIndex}`);
            if (activeEl && courtResults) {
              activeEl.scrollIntoView({ block: "nearest" });
            }
            return;
          }

          if (event.key === "Enter") {
            event.preventDefault();
            if (!courtMatches.length) {
              setError(1, "No matching court to select. Keep typing a court name.");
              return;
            }
            const idx = activeCourtMatchIndex >= 0 ? activeCourtMatchIndex : 0;
            const court = courtMatches[idx];
            if (court) setSelectedCourt(court);
          }
        });
      }

      // Clicking outside the court picker closes suggestions.
      document.addEventListener("click", (event) => {
        if (!courtResults || !courtQuery) return;
        const picker = courtQuery.closest(".court-picker");
        if (!picker) return;
        if (!picker.contains(event.target)) {
          closeCourtSuggestions();
        }
      });

      const syncMaxCasesEnabled = () => {
        if (!maxCasesInput || !scopeLimited) return;
        maxCasesInput.disabled = !scopeLimited.checked;
      };

      if (scopeLimited && scopeAll) {
        scopeLimited.addEventListener("change", syncMaxCasesEnabled);
        scopeAll.addEventListener("change", syncMaxCasesEnabled);
      }

      if (quickCaps.length && maxCasesInput) {
        for (const btn of quickCaps) {
          btn.addEventListener("click", () => {
            const value = Number(btn.dataset.maxCases || "0");
            if (Number.isFinite(value) && value > 0) {
              if (scopeLimited) scopeLimited.checked = true;
              maxCasesInput.disabled = false;
              maxCasesInput.value = String(value);
              setError(3, "");
            }
          });
        }
      }

      const validateStep = (step) => {
        if (step === 1) {
          if (!courtHidden || !courtHidden.value) {
            const query = (courtQuery && (courtQuery.value || "").trim()) || "";
            if (query && courtMatches.length) {
              const idx = activeCourtMatchIndex >= 0 ? activeCourtMatchIndex : 0;
              const court = courtMatches[idx] || courtMatches[0];
              if (court) {
                setSelectedCourt(court);
                return true;
              }
            }
            setError(1, "Select a court to continue.");
            return false;
          }
          setError(1, "");
          return true;
        }

        if (step === 2) {
          if (!dateFrom || !dateTo || !dateFrom.value || !dateTo.value) {
            setError(2, "Enter a valid date range to continue.");
            return false;
          }
          if (dateFrom.value > dateTo.value) {
            setError(2, "Date filed from must be before date filed to.");
            return false;
          }
          setError(2, "");
          return true;
        }

        if (step === 3) {
          const selectedTypes = caseTypeCheckboxes.filter((el) => el && el.checked);
          if (!selectedTypes.length) {
            setError(3, "Select at least one case type to continue.");
            return false;
          }
          if (scopeLimited && scopeLimited.checked) {
            const value = Number(maxCasesInput && maxCasesInput.value || "0");
            if (!Number.isFinite(value) || value <= 0) {
              setError(3, "Enter a valid maximum case count.");
              return false;
            }
          }
          setError(3, "");
          return true;
        }

        return true;
      };

      const updateSummary = () => {
        if (summaryCourt) {
          summaryCourt.textContent = activeCourtLabel() || "—";
        }

        if (summaryDates && dateFrom && dateTo) {
          const from = dateFrom.value || "—";
          const to = dateTo.value || "—";
          summaryDates.textContent = `${from} to ${to}`;
        }

        if (summaryCap) {
          if (scopeAll && scopeAll.checked) {
            summaryCap.textContent = "Full run (no cap)";
          } else {
            const value = (maxCasesInput && maxCasesInput.value) || "—";
            summaryCap.textContent = `Test run (up to ${value} cases)`;
          }
        }

        if (summaryCaseTypes) {
          const selectedTypes = caseTypeCheckboxes
            .filter((el) => el && el.checked)
            .map((el) => (el.value || "").toString().toUpperCase())
            .filter(Boolean);
          summaryCaseTypes.textContent = selectedTypes.length ? selectedTypes.join(", ") : "—";
        }
      };

      const showStep = (step) => {
        currentStep = step;
        for (const el of stepEls) {
          const elStep = Number(el.dataset.wizardStep || "0");
          el.hidden = elStep !== step;
        }
        for (const el of progressEls) {
          const elStep = Number(el.dataset.wizardProgress || "0");
          el.classList.toggle("is-current", elStep === step);
          el.classList.toggle("is-complete", elStep < step);
        }
        updateSummary();
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      for (const btn of nextButtons) {
        btn.addEventListener("click", () => {
          if (!validateStep(currentStep)) return;
          const next = Math.min(4, currentStep + 1);
          showStep(next);
        });
      }

      for (const btn of backButtons) {
        btn.addEventListener("click", () => {
          const prev = Math.max(1, currentStep - 1);
          showStep(prev);
        });
      }

      if (form) {
        form.addEventListener("submit", (event) => {
          // Make sure earlier steps are valid before allowing submission.
          for (const step of [1, 2, 3]) {
            if (!validateStep(step)) {
              event.preventDefault();
              showStep(step);
              return;
            }
          }
        });
      }

      syncMaxCasesEnabled();
      renderSelectedCourt();
      if (courtMeta) {
        const selectedLabel = activeCourtLabel();
        courtMeta.textContent = selectedLabel
          ? `Selected: ${selectedLabel}. Type to change the court.`
          : `Start typing to search ${Array.isArray(courtChoices) ? courtChoices.length : 0} district courts.`;
      }
      closeCourtSuggestions();
      showStep(currentStep);
    })();
  </script>
{% endblock %}
