{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | PCL Case {{ case_detail.case_number_full or case_detail.case_number }}{% endblock %}

{% block federal_content %}
  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <p class="pcl-case-card__number">{{ case_detail.case_number_full or case_detail.case_number }}</p>
        <h2>{{ case_detail.short_title or case_detail.case_title or "Untitled case" }}</h2>
        <p class="small">Court {{ case_detail.court_id }}{% if case_detail.case_type %} • Type {{ case_detail.case_type }}{% endif %}</p>
      </div>
      <div class="actions">
        <a class="pill" href="{{ url_for('admin_pcl_cases') }}">Back to cases</a>
        <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case_detail.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="secondary" type="submit">Expand data</button>
        </form>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Normalized fields</h3>
        <dl class="pcl-detail-list">
          <div><dt>Case number</dt><dd>{{ case_detail.case_number }}</dd></div>
          <div><dt>Case number full</dt><dd>{{ case_detail.case_number_full or "—" }}</dd></div>
          <div><dt>Date filed</dt><dd>{{ case_detail.date_filed.isoformat() if case_detail.date_filed else "—" }}</dd></div>
          <div>
            <dt>Date closed</dt>
            <dd>
              {% set closed_date = case_detail.effective_date_closed or case_detail.date_closed %}
              {{ closed_date.isoformat() if closed_date else "—" }}
            </dd>
          </div>
          <div><dt>Judge last name</dt><dd>{{ case_detail.judge_last_name or "—" }}</dd></div>
          <div><dt>Record hash</dt><dd class="pcl-mono">{{ case_detail.record_hash or "—" }}</dd></div>
          <div><dt>Last updated</dt><dd>{{ case_detail.updated_at.isoformat() if case_detail.updated_at else "—" }}</dd></div>
        </dl>
      </article>

      <article class="pcl-detail-card">
        <h3>Batch segment provenance</h3>
        <dl class="pcl-detail-list">
          <div><dt>Segment ID</dt><dd>{{ case_detail.last_segment_id or "—" }}</dd></div>
          <div><dt>Status</dt><dd>{{ case_detail.segment_status or "—" }}</dd></div>
          <div><dt>Date window</dt><dd>
            {% if case_detail.segment_date_from or case_detail.segment_date_to %}
              {{ case_detail.segment_date_from.isoformat() if case_detail.segment_date_from else "?" }} → {{ case_detail.segment_date_to.isoformat() if case_detail.segment_date_to else "?" }}
            {% else %}
              —
            {% endif %}
          </dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.segment_report_id or "—" }}</dd></div>
          <div><dt>Remote status</dt><dd>{{ case_detail.segment_remote_status or "—" }}</dd></div>
          <div><dt>Remote message</dt><dd>{{ case_detail.segment_remote_status_message or "—" }}</dd></div>
          <div><dt>Completed at</dt><dd>{{ case_detail.segment_completed_at.isoformat() if case_detail.segment_completed_at else "—" }}</dd></div>
        </dl>
      </article>

      <article class="pcl-detail-card">
        <h3>PACER run provenance</h3>
        <dl class="pcl-detail-list">
          <div><dt>Last run ID</dt><dd>{{ case_detail.pacer_run_id or case_detail.last_search_run_id or "—" }}</dd></div>
          <div>
            <dt>Last run time</dt>
            <dd>
              {% set run_time = case_detail.last_search_run_at or case_detail.pacer_run_created_at %}
              {{ run_time.isoformat() if run_time else "—" }}
            </dd>
          </div>
          <div><dt>Run type</dt><dd>{{ case_detail.pacer_run_search_type or "—" }}</dd></div>
          <div><dt>Run mode</dt><dd>{{ case_detail.pacer_run_search_mode or "—" }}</dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.pacer_run_report_id or "—" }}</dd></div>
          <div><dt>Report status</dt><dd>{{ case_detail.pacer_run_report_status or "—" }}</dd></div>
        </dl>
      </article>
    </div>
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>PACER capture details</h3>
        <p class="small">Who pulled this data and what PACER reported.</p>
      </div>
    </div>
    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Harvested by</h3>
        <dl class="pcl-detail-list">
          <div><dt>Login ID</dt><dd>{{ case_detail.harvested_info.login_id or "—" }}</dd></div>
          <div><dt>CSO ID</dt><dd>{{ case_detail.harvested_info.cso_id or "—" }}</dd></div>
          <div><dt>Transaction date</dt><dd>{{ case_detail.harvested_info.transaction_date or "—" }}</dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.harvested_info.report_id or "—" }}</dd></div>
        </dl>
      </article>
      <article class="pcl-detail-card">
        <h3>Search receipt</h3>
        <dl class="pcl-detail-list">
          <div><dt>Search fee</dt><dd>{{ case_detail.harvested_info.search_fee or "—" }}</dd></div>
          <div><dt>Client code</dt><dd>{{ case_detail.harvested_info.client_code or "—" }}</dd></div>
          <div><dt>Description</dt><dd>{{ case_detail.harvested_info.description or "—" }}</dd></div>
          <div><dt>Search</dt><dd>{{ case_detail.harvested_info.search or "—" }}</dd></div>
        </dl>
      </article>
    </div>
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Full PACER payload</h3>
        <p class="small">Every field returned for this case. Use this to add new fields to the UI.</p>
      </div>
    </div>
    <details class="pcl-detail-card">
      <summary class="pcl-detail-summary">Show raw PACER JSON</summary>
      <pre class="code-block">{{ case_detail.data_json_parsed | tojson(indent=2) if case_detail.data_json_parsed else (case_detail.data_json or "—") }}</pre>
    </details>
  </section>


  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Sentencing events</h3>
        <p class="small">Admin-entered sentencing facts with provenance references.</p>
      </div>
      <div class="actions">
        <a class="pill" href="{{ url_for('admin_sentencing_events_report') }}">View report</a>
        <a class="primary" href="{{ url_for('admin_sentencing_event_new', case_id=case_detail.id) }}">Add sentencing event</a>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Sentencing judges</h3>
        {% if case_detail.sentencing_judges %}
          <ul class="pcl-list">
            {% for judge in case_detail.sentencing_judges %}
              <li>
                <strong>{{ judge.judge_name }}</strong>
                {% if judge.confidence is not none %}<span class="small">confidence {{ '%.2f'|format(judge.confidence) }}</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% elif case_detail.case_judges %}
          <p class="small">Case judges are recorded but none are marked as sentencing judges yet.</p>
        {% else %}
          <p class="small">No judges linked to this case yet.</p>
        {% endif %}
      </article>

      <article class="pcl-detail-card">
        <h3>Sentencing summary</h3>
        <dl class="pcl-detail-list">
          <div><dt>Events recorded</dt><dd>{{ case_detail.sentencing_events|length }}</dd></div>
          <div><dt>Latest sentencing date</dt><dd>
            {% if case_detail.sentencing_events %}
              {{ case_detail.sentencing_events[0].sentencing_date.isoformat() if case_detail.sentencing_events[0].sentencing_date else '—' }}
            {% else %}
              —
            {% endif %}
          </dd></div>
        </dl>
      </article>
    </div>

    {% if case_detail.sentencing_events %}
      <div class="pcl-json-list">
        {% for event in case_detail.sentencing_events %}
          <article class="pcl-json-item">
            <header>
              <strong>Sentencing {{ event.sentencing_date.isoformat() if event.sentencing_date else '—' }}</strong>
              <span class="small">Sentence {{ event.sentence_months }} months</span>
            </header>
            <dl class="pcl-detail-list">
              <div><dt>Defendant</dt><dd>{{ event.defendant_identifier or '—' }}</dd></div>
              <div><dt>Guideline range</dt><dd>
                {% if event.guideline_range_low is not none or event.guideline_range_high is not none %}
                  {{ event.guideline_range_low if event.guideline_range_low is not none else '?' }}–{{ event.guideline_range_high if event.guideline_range_high is not none else '?' }}
                {% else %}
                  —
                {% endif %}
              </dd></div>
              <div><dt>Offense level</dt><dd>{{ event.offense_level if event.offense_level is not none else '—' }}</dd></div>
              <div><dt>Criminal history</dt><dd>{{ event.criminal_history_category or '—' }}</dd></div>
              <div><dt>Variance</dt><dd>{{ event.variance_type or '—' }}</dd></div>
              <div><dt>Notes</dt><dd>{{ event.notes or '—' }}</dd></div>
            </dl>
            <div class="stack" style="margin-top: 12px;">
              <strong>Evidence</strong>
              {% if event.evidence %}
                <ul class="pcl-list">
                  {% for evidence in event.evidence %}
                    <li>
                      <span class="pill small" style="margin-right: 6px;">{{ evidence.source_type.replace('_', ' ')|title }}</span>
                      {% if evidence.source_id %}<span class="small">#{{ evidence.source_id }}</span>{% endif %}
                      <div>{{ evidence.reference_text }}</div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">No evidence references recorded.</p>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No sentencing events recorded for this case.</p>
    {% endif %}
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Docket enrichment</h3>
        <p class="small">Queue docket-level enrichment. Cost values below are estimates derived from historical receipts.</p>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Queue enrichment</h3>
        <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case_detail.id) }}" class="stack">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <label class="checkbox-row">
            <input type="checkbox" name="include_docket_text" value="1">
            <span>Include docket text</span>
          </label>
          <button class="primary" type="submit">Queue enrichment</button>
        </form>
        <p class="small">This action is admin-only and does not store credentials client side.</p>
      </article>

      <article class="pcl-detail-card">
        <h3>Estimated cost (estimate)</h3>
        {% set estimates = case_detail.docket_estimate.by_include_docket_text %}
        {% set without_text = estimates.get(False) %}
        {% set with_text = estimates.get(True) %}
        <dl class="pcl-detail-list">
          <div>
            <dt>Without docket text</dt>
            <dd>
              {% if without_text and without_text.receipt_count and without_text.avg_fee is not none %}
                ${{ '%.2f'|format(without_text.avg_fee) }} · {{ without_text.receipt_count }} receipts
              {% else %}
                unknown
              {% endif %}
            </dd>
          </div>
          <div>
            <dt>With docket text</dt>
            <dd>
              {% if with_text and with_text.receipt_count and with_text.avg_fee is not none %}
                ${{ '%.2f'|format(with_text.avg_fee) }} · {{ with_text.receipt_count }} receipts
              {% else %}
                unknown
              {% endif %}
            </dd>
          </div>
          <div>
            <dt>Case type match</dt>
            <dd>
              {% if case_detail.case_type %}
                {{ case_detail.case_type }}{% if (with_text and with_text.case_type_matched) or (without_text and without_text.case_type_matched) %} · matched history{% else %} · using broader history{% endif %}
              {% else %}
                Case type unavailable
              {% endif %}
            </dd>
          </div>
        </dl>
        <p class="small">Actual costs will be recorded from receipts once docket endpoints are implemented.</p>
      </article>
    </div>

    <article class="pcl-detail-card">
      <h3>Docket jobs</h3>
      {% if case_detail.docket_jobs %}
        <div class="table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Include text</th>
                <th>Attempts</th>
                <th>Receipts</th>
                <th>Last receipt</th>
                <th>Last error</th>
                <th>Queued</th>
              </tr>
            </thead>
            <tbody>
              {% for job in case_detail.docket_jobs %}
                <tr>
                  <td class="pcl-mono">{{ job.id }}</td>
                  <td>{{ job.status }}</td>
                  <td>{{ "yes" if job.include_docket_text else "no" }}</td>
                  <td>{{ job.attempts }}</td>
                  <td>{{ job.receipt_count }}</td>
                  <td>{{ job.last_receipt_at.isoformat() if job.last_receipt_at else "—" }}</td>
                  <td>{{ job.last_error or "—" }}</td>
                  <td>{{ job.created_at.isoformat() if job.created_at else "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="small">No docket enrichment jobs queued for this case.</p>
      {% endif %}
    </article>
  </section>

  <section class="card pcl-detail-shell">
    <h3>Receipts</h3>
    {% if case_detail.receipts %}
      <div class="pcl-json-list">
        {% for receipt in case_detail.receipts %}
          <article class="pcl-json-item">
            <header>
              <strong>Receipt {{ receipt.id }}</strong>
              <span class="small">{{ receipt.created_at.isoformat() if receipt.created_at else "—" }}</span>
            </header>
            <pre>{{ receipt.receipt_json }}</pre>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No receipts stored for this segment yet.</p>
    {% endif %}
  </section>

  <section class="card pcl-detail-shell">
    <h3>Raw payloads</h3>
    {% if case_detail.raw_payloads %}
      <div class="pcl-json-list">
        {% for payload in case_detail.raw_payloads %}
          <article class="pcl-json-item">
            <header>
              <strong>Raw record {{ payload.id }}</strong>
              <span class="small">Segment {{ payload.segment_id }} • {{ payload.created_at.isoformat() if payload.created_at else "—" }}</span>
            </header>
            <pre>{{ payload.payload_json }}</pre>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No raw payloads stored for this case.</p>
    {% endif %}
  </section>
{% endblock %}
