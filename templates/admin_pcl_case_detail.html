{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | PCL Case {{ case_detail.case_number_full or case_detail.case_number }}{% endblock %}

{% block federal_content %}
  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <p class="pcl-case-card__number">{{ case_detail.case_number_full or case_detail.case_number }}</p>
        <h2>{{ case_detail.short_title or case_detail.case_title or "Untitled case" }}</h2>
        <p class="small">Court {{ case_detail.court_id }}{% if case_detail.case_type %} • Type {{ case_detail.case_type }}{% endif %}</p>
      </div>
      <div class="actions">
        <a class="pill" href="{{ url_for('admin_pcl_cases') }}">Back to cases</a>
        <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case_detail.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="secondary" type="submit">Expand data</button>
        </form>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Normalized fields</h3>
        <dl class="pcl-detail-list">
          <div><dt>Case number</dt><dd>{{ case_detail.case_number }}</dd></div>
          <div><dt>Case number full</dt><dd>{{ case_detail.case_number_full or "—" }}</dd></div>
          <div><dt>Date filed</dt><dd>{{ case_detail.date_filed.isoformat() if case_detail.date_filed else "—" }}</dd></div>
          <div>
            <dt>Date closed</dt>
            <dd>
              {% set closed_date = case_detail.effective_date_closed or case_detail.date_closed %}
              {{ closed_date.isoformat() if closed_date else "—" }}
            </dd>
          </div>
          <div><dt>Judge last name</dt><dd>{{ case_detail.judge_last_name or "—" }}</dd></div>
          <div><dt>Record hash</dt><dd class="pcl-mono">{{ case_detail.record_hash or "—" }}</dd></div>
          <div><dt>Last updated</dt><dd>{{ case_detail.updated_at.isoformat() if case_detail.updated_at else "—" }}</dd></div>
        </dl>
      </article>

      <article class="pcl-detail-card">
        <h3>Batch segment provenance</h3>
        <dl class="pcl-detail-list">
          <div><dt>Segment ID</dt><dd>{{ case_detail.last_segment_id or "—" }}</dd></div>
          <div><dt>Status</dt><dd>{{ case_detail.segment_status or "—" }}</dd></div>
          <div><dt>Date window</dt><dd>
            {% if case_detail.segment_date_from or case_detail.segment_date_to %}
              {{ case_detail.segment_date_from.isoformat() if case_detail.segment_date_from else "?" }} → {{ case_detail.segment_date_to.isoformat() if case_detail.segment_date_to else "?" }}
            {% else %}
              —
            {% endif %}
          </dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.segment_report_id or "—" }}</dd></div>
          <div><dt>Remote status</dt><dd>{{ case_detail.segment_remote_status or "—" }}</dd></div>
          <div><dt>Remote message</dt><dd>{{ case_detail.segment_remote_status_message or "—" }}</dd></div>
          <div><dt>Completed at</dt><dd>{{ case_detail.segment_completed_at.isoformat() if case_detail.segment_completed_at else "—" }}</dd></div>
        </dl>
      </article>

      <article class="pcl-detail-card">
        <h3>PACER run provenance</h3>
        <dl class="pcl-detail-list">
          <div><dt>Last run ID</dt><dd>{{ case_detail.pacer_run_id or case_detail.last_search_run_id or "—" }}</dd></div>
          <div>
            <dt>Last run time</dt>
            <dd>
              {% set run_time = case_detail.last_search_run_at or case_detail.pacer_run_created_at %}
              {{ run_time.isoformat() if run_time else "—" }}
            </dd>
          </div>
          <div><dt>Run type</dt><dd>{{ case_detail.pacer_run_search_type or "—" }}</dd></div>
          <div><dt>Run mode</dt><dd>{{ case_detail.pacer_run_search_mode or "—" }}</dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.pacer_run_report_id or "—" }}</dd></div>
          <div><dt>Report status</dt><dd>{{ case_detail.pacer_run_report_status or "—" }}</dd></div>
        </dl>
      </article>
    </div>
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>PACER capture details</h3>
        <p class="small">Who pulled this data and what PACER reported.</p>
      </div>
    </div>
    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Harvested by</h3>
        <dl class="pcl-detail-list">
          <div><dt>Login ID</dt><dd>{{ case_detail.harvested_info.login_id or "—" }}</dd></div>
          <div><dt>CSO ID</dt><dd>{{ case_detail.harvested_info.cso_id or "—" }}</dd></div>
          <div><dt>Transaction date</dt><dd>{{ case_detail.harvested_info.transaction_date or "—" }}</dd></div>
          <div><dt>Report ID</dt><dd class="pcl-mono">{{ case_detail.harvested_info.report_id or "—" }}</dd></div>
        </dl>
      </article>
      <article class="pcl-detail-card">
        <h3>Search receipt</h3>
        <dl class="pcl-detail-list">
          <div><dt>Search fee</dt><dd>{{ case_detail.harvested_info.search_fee or "—" }}</dd></div>
          <div><dt>Client code</dt><dd>{{ case_detail.harvested_info.client_code or "—" }}</dd></div>
          <div><dt>Description</dt><dd>{{ case_detail.harvested_info.description or "—" }}</dd></div>
          <div><dt>Search</dt><dd>{{ case_detail.harvested_info.search or "—" }}</dd></div>
        </dl>
      </article>
    </div>
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Normalized PACER fields</h3>
        <p class="small">Every field saved as a searchable value.</p>
      </div>
    </div>
    {% set docket = namespace(text=None, preview=None, entries=None, updated_at=None, html=None, html_preview=None, header_fields=None, form_action=None, form_payload=None, request_debug=None, parties=None, attorneys=None, party_summary=None) %}
    {% set ai = namespace(review=None, case_prompt=None, system_prompt=None) %}
    {% if case_detail.case_fields %}
      {% for field in case_detail.case_fields %}
        {% if field.field_name == 'docket_text' %}
          {% set docket.text = field.field_value_json %}
          {% set docket.updated_at = field.updated_at %}
        {% elif field.field_name == 'docket_text_preview' %}
          {% set docket.preview = field.field_value_text %}
          {% set docket.updated_at = field.updated_at %}
        {% elif field.field_name == 'docket_html' %}
          {% set docket.html = field.field_value_json %}
          {% set docket.updated_at = field.updated_at %}
        {% elif field.field_name == 'docket_html_preview' %}
          {% set docket.html_preview = field.field_value_text %}
          {% set docket.updated_at = field.updated_at %}
        {% elif field.field_name == 'docket_entries' %}
          {% set docket.entries = field.field_value_json %}
        {% elif field.field_name == 'docket_header_fields' %}
          {% set docket.header_fields = field.field_value_json %}
        {% elif field.field_name == 'docket_parties' %}
          {% set docket.parties = field.field_value_json %}
        {% elif field.field_name == 'docket_attorneys' %}
          {% set docket.attorneys = field.field_value_json %}
        {% elif field.field_name == 'docket_party_summary' %}
          {% set docket.party_summary = field.field_value_text %}
        {% elif field.field_name == 'docket_form_action' %}
          {% set docket.form_action = field.field_value_text %}
        {% elif field.field_name == 'docket_form_payload' %}
          {% set docket.form_payload = field.field_value_json %}
        {% elif field.field_name == 'docket_request_debug' %}
          {% set docket.request_debug = field.field_value_json %}
        {% elif field.field_name == 'case_ai_review' %}
          {% set ai.review = field.field_value_text %}
        {% elif field.field_name == 'case_ai_prompt' %}
          {% set ai.case_prompt = field.field_value_text %}
        {% elif field.field_name == 'system_ai_prompt' %}
          {% set ai.system_prompt = field.field_value_text %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% set docket_html_raw = docket.html.text if docket.html and docket.html.text %}
    {% set docket_html_text = docket_html_raw or docket.html_preview %}
    {% set docket_is_html = docket_html_text %}
    {% set docket_is_login = docket_html_text and ('pacer.login.uscourts.gov' in docket_html_text or 'csologin' in docket_html_text) %}
    {% set docket_entry_count = docket.entries|length if docket.entries else 0 %}
    {% set docket_party_count = docket.parties|length if docket.parties else 0 %}
    {% set docket_attorney_count = docket.attorneys|length if docket.attorneys else 0 %}
    {% set assigned_judges = docket.header_fields.assigned_to if docket.header_fields and docket.header_fields.assigned_to else None %}
    {% set referred_judges = docket.header_fields.referred_to if docket.header_fields and docket.header_fields.referred_to else None %}
    {% if docket.text or docket.preview or docket.entries or docket_is_html %}
      <article class="pcl-detail-card">
        <h3>Docket text</h3>
        <p class="small">Latest docket text captured from PACER.</p>
        {% if docket.updated_at %}
          <p class="small">Updated {{ docket.updated_at.isoformat() }}</p>
        {% endif %}
        <form method="post" action="{{ url_for('admin_pcl_case_docket_clear', case_id=case_detail.id) }}" style="margin: 8px 0 12px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="secondary" type="submit" onclick="return confirm('Clear docket fields for this case?')">
            Clear docket fields
          </button>
        </form>
        {% if docket.entries or docket.parties or assigned_judges or referred_judges %}
          <div class="docket-summary">
            <div class="docket-summary__item">
              <span class="docket-summary__label">Entries</span>
              <span class="docket-summary__value">{{ docket_entry_count }}</span>
            </div>
            {% if docket.parties %}
              <div class="docket-summary__item">
                <span class="docket-summary__label">Parties</span>
                <span class="docket-summary__value">{{ docket_party_count }}</span>
              </div>
            {% endif %}
            {% if docket.attorneys %}
              <div class="docket-summary__item">
                <span class="docket-summary__label">Attorneys</span>
                <span class="docket-summary__value">{{ docket_attorney_count }}</span>
              </div>
            {% endif %}
            {% if assigned_judges %}
              <div class="docket-summary__item docket-summary__item--wide">
                <span class="docket-summary__label">Assigned judges</span>
                <div class="docket-summary__value docket-summary__tags">
                  {% for judge in assigned_judges %}
                    <span class="docket-tag">{{ judge }}</span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if referred_judges %}
              <div class="docket-summary__item docket-summary__item--wide">
                <span class="docket-summary__label">Referred judges</span>
                <div class="docket-summary__value docket-summary__tags">
                  {% for judge in referred_judges %}
                    <span class="docket-tag">{{ judge }}</span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if docket.parties %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show parties, counsel, and count/disposition details</summary>
            {% for party in docket.parties %}
              <div class="pcl-detail-card" style="margin-top: 12px;">
                <h4 style="margin: 0 0 8px;">{{ party.party_heading or party.party_type or 'Party' }}</h4>
                <dl class="pcl-detail-list">
                  <div><dt>Name</dt><dd>{{ party.name or "—" }}</dd></div>
                  {% if party.aliases %}
                    <div><dt>Aliases</dt><dd>{{ party.aliases | join(', ') }}</dd></div>
                  {% endif %}
                  {% if party.highest_offense_level_opening %}
                    <div><dt>Highest offense level (opening)</dt><dd>{{ party.highest_offense_level_opening }}</dd></div>
                  {% endif %}
                  {% if party.highest_offense_level_terminated %}
                    <div><dt>Highest offense level (terminated)</dt><dd>{{ party.highest_offense_level_terminated }}</dd></div>
                  {% endif %}
                </dl>
                {% if party.represented_by %}
                  <h5 style="margin: 10px 0 6px;">Represented by</h5>
                  <div class="table-wrapper">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Attorney</th>
                          <th>Organization / details</th>
                          <th>Contact</th>
                          <th>Roles / designation</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for attorney in party.represented_by %}
                          <tr>
                            <td>{{ attorney.name or "—" }}</td>
                            <td>
                              {% if attorney.details %}
                                {{ attorney.details | join(' | ') }}
                              {% elif attorney.organization %}
                                {{ attorney.organization }}
                              {% else %}
                                —
                              {% endif %}
                            </td>
                            <td>
                              {% set contact = [] %}
                              {% if attorney.emails %}{% set _ = contact.append('Email: ' ~ (attorney.emails | join(', '))) %}{% endif %}
                              {% if attorney.phones %}{% set _ = contact.append('Phone: ' ~ (attorney.phones | join(', '))) %}{% endif %}
                              {% if attorney.faxes %}{% set _ = contact.append('Fax: ' ~ (attorney.faxes | join(', '))) %}{% endif %}
                              {% if attorney.websites %}{% set _ = contact.append('Web: ' ~ (attorney.websites | join(', '))) %}{% endif %}
                              {{ contact | join(' | ') if contact else '—' }}
                            </td>
                            <td>
                              {% set role_parts = [] %}
                              {% if attorney.roles %}{% set _ = role_parts.append(attorney.roles | join(', ')) %}{% endif %}
                              {% if attorney.designations %}{% set _ = role_parts.append('Designation: ' ~ (attorney.designations | join(', '))) %}{% endif %}
                              {{ role_parts | join(' | ') if role_parts else '—' }}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
                {% if party.pending_counts %}
                  <h5 style="margin: 10px 0 6px;">Pending counts</h5>
                  <div class="table-wrapper">
                    <table class="table">
                      <thead>
                        <tr><th>Count</th><th>Disposition</th></tr>
                      </thead>
                      <tbody>
                        {% for item in party.pending_counts %}
                          <tr><td>{{ item.count or "—" }}</td><td>{{ item.disposition or "—" }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
                {% if party.terminated_counts %}
                  <h5 style="margin: 10px 0 6px;">Terminated counts</h5>
                  <div class="table-wrapper">
                    <table class="table">
                      <thead>
                        <tr><th>Count</th><th>Disposition</th></tr>
                      </thead>
                      <tbody>
                        {% for item in party.terminated_counts %}
                          <tr><td>{{ item.count or "—" }}</td><td>{{ item.disposition or "—" }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
                {% if party.complaints %}
                  <h5 style="margin: 10px 0 6px;">Complaints</h5>
                  <div class="table-wrapper">
                    <table class="table">
                      <thead>
                        <tr><th>Complaint</th><th>Disposition</th></tr>
                      </thead>
                      <tbody>
                        {% for item in party.complaints %}
                          <tr><td>{{ item.count or "—" }}</td><td>{{ item.disposition or "—" }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </details>
        {% endif %}
        {% if docket.header_fields %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show docket header fields</summary>
            <pre class="code-block">{{ docket.header_fields | tojson(indent=2) }}</pre>
          </details>
        {% endif %}
        {% if docket_is_html and docket_is_login %}
          <p class="small">PACER returned a login redirect. Docket text was not captured.</p>
        {% elif docket_is_html %}
          <p class="small">PACER returned a docket request form. Docket text was not captured.</p>
          {% if docket.form_action or docket.form_payload %}
            <details class="pcl-detail-card" style="margin-top: 12px;">
              <summary class="pcl-detail-summary">Show docket form details</summary>
              {% if docket.form_action %}
                <pre class="code-block">form_action: {{ docket.form_action }}</pre>
              {% endif %}
              {% if docket.form_payload %}
                <pre class="code-block">{{ docket.form_payload | tojson(indent=2) }}</pre>
              {% endif %}
            </details>
          {% endif %}
          {% if docket.request_debug %}
            <details class="pcl-detail-card" style="margin-top: 12px;">
              <summary class="pcl-detail-summary">Show docket request debug</summary>
              <pre class="code-block">{{ docket.request_debug | tojson(indent=2) }}</pre>
            </details>
          {% endif %}
        {% else %}
          <p class="small">Docket text stored without preview.</p>
        {% endif %}
        {% if docket.entries %}
          <div class="table-wrapper docket-entries-table" style="margin-top: 12px;">
            <table class="table">
              <thead>
                <tr>
                  <th>Date filed</th>
                  <th>ECF #</th>
                  <th>Description</th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in docket.entries %}
                  <tr>
                    <td>{{ entry.dateFiled or "—" }}</td>
                    <td>{{ entry.documentNumber or "—" }}</td>
                    <td>{{ entry.description or "—" }}</td>
                    <td>
                      {% if entry.documentLinks %}
                        {% for link in entry.documentLinks %}
                          <div>
                            <a href="{{ link.href }}" target="_blank" rel="noopener">
                              {{ link.label or link.href }}
                            </a>
                          </div>
                        {% endfor %}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show raw JSON</summary>
            <pre class="code-block">{{ docket.entries | tojson(indent=2) }}</pre>
          </details>
        {% endif %}
        {% if docket.text and docket.text.text %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show raw docket text</summary>
            <pre class="code-block docket-text-block">{{ docket.text.text }}</pre>
          </details>
        {% elif docket.preview %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show raw docket text</summary>
            <pre class="code-block docket-text-block">{{ docket.preview }}</pre>
          </details>
        {% endif %}
        {% if docket_is_html and docket_html_raw %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show raw PACER response (full)</summary>
            <pre class="code-block">{{ docket_html_raw }}</pre>
          </details>
        {% elif docket_is_html %}
          <details class="pcl-detail-card" style="margin-top: 12px;">
            <summary class="pcl-detail-summary">Show raw PACER response</summary>
            <pre class="code-block">{{ docket_html_text }}</pre>
          </details>
        {% endif %}
      </article>
    {% endif %}

    <article id="docket-documents" class="pcl-detail-card" style="margin-top: 20px;">
      <h3>Docket documents</h3>
      <p class="small">Queue document downloads from the docket entries. Downloads incur PACER fees.</p>
      <form method="post" action="{{ url_for('admin_pcl_case_queue_documents', case_id=case_detail.id) }}" style="display:inline-block; margin-right: 8px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="document-numbers-queue">ECF numbers (optional)</label>
        <input id="document-numbers-queue" name="document_numbers" type="text" placeholder="e.g., 5, 8-10, 12">
        <button class="secondary" type="submit">Queue document downloads</button>
      </form>
      <form method="post" action="{{ url_for('admin_pcl_case_download_documents_now', case_id=case_detail.id) }}" style="display:inline-block;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="document-numbers-download">ECF numbers (optional)</label>
        <input id="document-numbers-download" name="document_numbers" type="text" placeholder="e.g., 5, 8-10, 12">
        <button class="primary" type="submit" onclick="return confirm('Download documents now? This may incur PACER fees.')">
          Download now
        </button>
      </form>
      {% if case_detail.document_jobs %}
        <div class="table-wrap" style="margin-top: 16px;">
          <table>
            <thead>
              <tr>
                <th>Job</th>
                <th>Status</th>
                <th>Total</th>
                <th>Downloaded</th>
                <th>Last error</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for job in case_detail.document_jobs %}
                <tr>
                  <td>#{{ job.id }}</td>
                  <td>{{ job.status }}</td>
                  <td>{{ job.documents_total or "—" }}</td>
                  <td>{{ job.documents_downloaded or "—" }}</td>
                  <td>{{ job.last_error or "—" }}</td>
                  <td>
                    <form method="post" action="{{ url_for('admin_run_document_job', job_id=job.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                      <button class="secondary" type="submit">Run job</button>
                    </form>
                  </td>
                </tr>
                {% if job.items %}
                  <tr>
                    <td colspan="6">
                      <details>
                        <summary>Show documents ({{ job.items | length }})</summary>
                        <div class="table-wrap" style="margin-top: 12px;">
                          <table>
                            <thead>
                              <tr>
                                <th>Doc #</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>File</th>
                                <th>Error</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for item in job.items %}
                                <tr>
                                  <td>{{ item.document_number or "—" }}</td>
                                  <td>{{ item.description or "—" }}</td>
                                  <td>{{ item.status }}</td>
                                  <td>{{ item.file_path or "—" }}</td>
                                  <td>{{ item.error or "—" }}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </details>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </article>

    <article id="ai-notes" class="pcl-detail-card" style="margin-top: 20px;">
      <h3>AI case notes & prompts</h3>
      <p class="small">Store case-specific AI review text and prompts for later analysis.</p>
      <form method="post" action="{{ url_for('admin_pcl_case_ai_notes', case_id=case_detail.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="case-ai-review">Case AI review</label>
        <textarea id="case-ai-review" name="case_ai_review" rows="6">{{ ai.review or "" }}</textarea>
        <label for="case-ai-prompt">Case-level prompt</label>
        <textarea id="case-ai-prompt" name="case_ai_prompt" rows="5">{{ ai.case_prompt or "" }}</textarea>
        <label for="system-ai-prompt">System-level prompt</label>
        <textarea id="system-ai-prompt" name="system_ai_prompt" rows="5">{{ ai.system_prompt or "" }}</textarea>
        <button class="primary" type="submit">Save AI notes</button>
      </form>
    </article>
    {% if case_detail.case_fields %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Field</th>
              <th>Value</th>
              <th>Last updated</th>
            </tr>
          </thead>
          <tbody>
            {% for field in case_detail.case_fields %}
              {% if field.field_name.startswith('docket_') %}
                {% set skip_field = true %}
              {% else %}
                {% set skip_field = false %}
              {% endif %}
              {% if skip_field %}
              {% else %}
              <tr>
                <td>{{ field.field_name }}</td>
                <td class="pcl-mono">
                  {{ field.field_value_text or (field.field_value_json | tojson(indent=0) if field.field_value_json is not none else "—") }}
                </td>
                <td>{{ field.updated_at.isoformat() if field.updated_at else "—" }}</td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% elif case_detail.case_fields_preview %}
      <p class="small">Preview from raw PACER payload (not yet indexed).</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            {% for field in case_detail.case_fields_preview %}
              <tr>
                <td>{{ field.field_name }}</td>
                <td class="pcl-mono">{{ field.field_value_text or "—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="small">No field snapshot saved yet. Save a PACER search to populate these fields.</p>
    {% endif %}
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Full PACER payload</h3>
        <p class="small">Every field returned for this case. Use this to add new fields to the UI.</p>
      </div>
    </div>
    <details class="pcl-detail-card">
      <summary class="pcl-detail-summary">Show raw PACER JSON</summary>
      <pre class="code-block">{{ case_detail.data_json_parsed | tojson(indent=2) if case_detail.data_json_parsed else (case_detail.data_json or "—") }}</pre>
    </details>
  </section>


  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Sentencing events</h3>
        <p class="small">Admin-entered sentencing facts with provenance references.</p>
      </div>
      <div class="actions">
        <a class="pill" href="{{ url_for('admin_sentencing_events_report') }}">View report</a>
        <a class="primary" href="{{ url_for('admin_sentencing_event_new', case_id=case_detail.id) }}">Add sentencing event</a>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Sentencing judges</h3>
        {% if case_detail.sentencing_judges %}
          <ul class="pcl-list">
            {% for judge in case_detail.sentencing_judges %}
              <li>
                <strong>{{ judge.judge_name }}</strong>
                {% if judge.confidence is not none %}<span class="small">confidence {{ '%.2f'|format(judge.confidence) }}</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% elif case_detail.case_judges %}
          <p class="small">Case judges are recorded but none are marked as sentencing judges yet.</p>
        {% else %}
          <p class="small">No judges linked to this case yet.</p>
        {% endif %}
      </article>

      <article class="pcl-detail-card">
        <h3>Sentencing summary</h3>
        <dl class="pcl-detail-list">
          <div><dt>Events recorded</dt><dd>{{ case_detail.sentencing_events|length }}</dd></div>
          <div><dt>Latest sentencing date</dt><dd>
            {% if case_detail.sentencing_events %}
              {{ case_detail.sentencing_events[0].sentencing_date.isoformat() if case_detail.sentencing_events[0].sentencing_date else '—' }}
            {% else %}
              —
            {% endif %}
          </dd></div>
        </dl>
      </article>
    </div>

    {% if case_detail.sentencing_events %}
      <div class="pcl-json-list">
        {% for event in case_detail.sentencing_events %}
          <article class="pcl-json-item">
            <header>
              <strong>Sentencing {{ event.sentencing_date.isoformat() if event.sentencing_date else '—' }}</strong>
              <span class="small">Sentence {{ event.sentence_months }} months</span>
            </header>
            <dl class="pcl-detail-list">
              <div><dt>Defendant</dt><dd>{{ event.defendant_identifier or '—' }}</dd></div>
              <div><dt>Guideline range</dt><dd>
                {% if event.guideline_range_low is not none or event.guideline_range_high is not none %}
                  {{ event.guideline_range_low if event.guideline_range_low is not none else '?' }}–{{ event.guideline_range_high if event.guideline_range_high is not none else '?' }}
                {% else %}
                  —
                {% endif %}
              </dd></div>
              <div><dt>Offense level</dt><dd>{{ event.offense_level if event.offense_level is not none else '—' }}</dd></div>
              <div><dt>Criminal history</dt><dd>{{ event.criminal_history_category or '—' }}</dd></div>
              <div><dt>Variance</dt><dd>{{ event.variance_type or '—' }}</dd></div>
              <div><dt>Notes</dt><dd>{{ event.notes or '—' }}</dd></div>
            </dl>
            <div class="stack" style="margin-top: 12px;">
              <strong>Evidence</strong>
              {% if event.evidence %}
                <ul class="pcl-list">
                  {% for evidence in event.evidence %}
                    <li>
                      <span class="pill small" style="margin-right: 6px;">{{ evidence.source_type.replace('_', ' ')|title }}</span>
                      {% if evidence.source_id %}<span class="small">#{{ evidence.source_id }}</span>{% endif %}
                      <div>{{ evidence.reference_text }}</div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small">No evidence references recorded.</p>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No sentencing events recorded for this case.</p>
    {% endif %}
  </section>

  <section class="card pcl-detail-shell">
    <div class="pcl-detail-header">
      <div>
        <h3>Docket enrichment</h3>
        <p class="small">Queue docket-level enrichment. Cost values below are estimates derived from historical receipts.</p>
      </div>
    </div>

    <div class="grid two pcl-detail-grid">
      <article class="pcl-detail-card">
        <h3>Queue enrichment</h3>
        <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case_detail.id) }}" class="stack">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <label class="checkbox-row">
            <input type="checkbox" name="include_docket_text" value="1">
            <span>Include docket text</span>
          </label>
          <button class="primary" type="submit">Queue enrichment</button>
        </form>
        <p class="small">This action is admin-only and does not store credentials client side.</p>
      </article>

      <article class="pcl-detail-card">
        <h3>Estimated cost (estimate)</h3>
        {% set estimates = case_detail.docket_estimate.by_include_docket_text %}
        {% set without_text = estimates.get(False) %}
        {% set with_text = estimates.get(True) %}
        <dl class="pcl-detail-list">
          <div>
            <dt>Without docket text</dt>
            <dd>
              {% if without_text and without_text.receipt_count and without_text.avg_fee is not none %}
                ${{ '%.2f'|format(without_text.avg_fee) }} · {{ without_text.receipt_count }} receipts
              {% else %}
                unknown
              {% endif %}
            </dd>
          </div>
          <div>
            <dt>With docket text</dt>
            <dd>
              {% if with_text and with_text.receipt_count and with_text.avg_fee is not none %}
                ${{ '%.2f'|format(with_text.avg_fee) }} · {{ with_text.receipt_count }} receipts
              {% else %}
                unknown
              {% endif %}
            </dd>
          </div>
          <div>
            <dt>Case type match</dt>
            <dd>
              {% if case_detail.case_type %}
                {{ case_detail.case_type }}{% if (with_text and with_text.case_type_matched) or (without_text and without_text.case_type_matched) %} · matched history{% else %} · using broader history{% endif %}
              {% else %}
                Case type unavailable
              {% endif %}
            </dd>
          </div>
        </dl>
        <p class="small">Actual costs will be recorded from receipts once docket endpoints are implemented.</p>
      </article>
    </div>

    <article class="pcl-detail-card" id="docket-jobs">
      <div class="pcl-detail-card__header">
        <h3>Docket jobs</h3>
        <div class="actions">
          <form method="post" action="{{ url_for('admin_pcl_case_pull_docket_now', case_id=case_detail.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="include_docket_text" value="1">
            <button class="secondary" type="submit">Pull docket text now</button>
          </form>
        </div>
      </div>
      {% if case_detail.docket_jobs %}
        {% set latest_job = case_detail.docket_jobs[0] %}
        <p class="small">
          Latest job: {{ latest_job.status }} · Attempts {{ latest_job.attempts }}
          {% if latest_job.updated_at %} · Updated {{ latest_job.updated_at.isoformat() }}{% endif %}
        </p>
      {% endif %}
      {% if case_detail.docket_jobs %}
        <div class="table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Include text</th>
                <th>Attempts</th>
                <th>Receipts</th>
                <th>Last receipt</th>
                <th>Last error</th>
                <th>Queued</th>
              </tr>
            </thead>
            <tbody>
              {% for job in case_detail.docket_jobs %}
                <tr>
                  <td class="pcl-mono">{{ job.id }}</td>
                  <td>{{ job.status }}</td>
                  <td>{{ "yes" if job.include_docket_text else "no" }}</td>
                  <td>{{ job.attempts }}</td>
                  <td>{{ job.receipt_count }}</td>
                  <td>{{ job.last_receipt_at.isoformat() if job.last_receipt_at else "—" }}</td>
                  <td>{{ job.last_error or "—" }}</td>
                  <td>{{ job.created_at.isoformat() if job.created_at else "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="small">No docket enrichment jobs queued for this case.</p>
      {% endif %}
    </article>
  </section>

  <section class="card pcl-detail-shell">
    <h3>Receipts</h3>
    {% if case_detail.receipts %}
      <div class="pcl-json-list">
        {% for receipt in case_detail.receipts %}
          <article class="pcl-json-item">
            <header>
              <strong>Receipt {{ receipt.id }}</strong>
              <span class="small">{{ receipt.created_at.isoformat() if receipt.created_at else "—" }}</span>
            </header>
            <pre>{{ receipt.receipt_json }}</pre>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No receipts stored for this segment yet.</p>
    {% endif %}
  </section>

  <section class="card pcl-detail-shell">
    <h3>Raw payloads</h3>
    {% if case_detail.raw_payloads %}
      <div class="pcl-json-list">
        {% for payload in case_detail.raw_payloads %}
          <article class="pcl-json-item">
            <header>
              <strong>Raw record {{ payload.id }}</strong>
              <span class="small">Segment {{ payload.segment_id }} • {{ payload.created_at.isoformat() if payload.created_at else "—" }}</span>
            </header>
            <pre>{{ payload.payload_json }}</pre>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No raw payloads stored for this case.</p>
    {% endif %}
  </section>
{% endblock %}
