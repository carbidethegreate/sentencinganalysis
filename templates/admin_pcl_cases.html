{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | Indexed PCL Cases{% endblock %}

{% block federal_content %}
  <section class="card stack">
    <p class="pacer-eyebrow">Saved searches</p>
    <h3>Reusable PACER search presets</h3>
    <p class="small">Run a saved search to refresh or expand indexed cases.</p>
    {% if saved_searches %}
      <div class="stack">
        {% for saved in saved_searches %}
          <div class="card">
            <div class="row" style="justify-content: space-between; align-items: flex-start;">
              <div>
                <p class="small"><strong>{{ saved.label }}</strong></p>
                <p class="small">
                  {{ saved.search_type|capitalize }} · {{ saved.search_mode|capitalize }}
                  · Schedule: {{ saved.schedule_label|capitalize }}
                </p>
                <p class="small">
                  Court/Region: <code>{{ saved.summary.court_id or saved.summary.region_code or 'All' }}</code>
                  {% if saved.summary.court_id and saved.summary.region_code %}
                    · Region: <code>{{ saved.summary.region_code }}</code>
                  {% endif %}
                  {% if saved.summary.date_from or saved.summary.date_to %}
                    · Date range: {{ saved.summary.date_from or '—' }} → {{ saved.summary.date_to or '—' }}
                  {% endif %}
                </p>
                {% if saved.summary.case_types %}
                  <p class="small">Case types: {{ saved.summary.case_types | join(', ') }}</p>
                {% endif %}
                {% if saved.last_run_display %}
                  <p class="small">Last run: {{ saved.last_run_display }}</p>
                {% endif %}
                {% if saved.summary.sort_field %}
                  <p class="small">Sort: {{ saved.summary.sort_field }} · {{ (saved.summary.sort_order or 'asc') | upper }}</p>
                {% endif %}
              </div>
              <div class="actions">
                <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  {% for field in saved.run_fields %}
                    <input type="hidden" name="{{ field.name }}" value="{{ field.value }}">
                  {% endfor %}
                  <button class="primary" type="submit">Run now</button>
                </form>
                <form method="post" action="{{ url_for('admin_pacer_saved_search_delete', search_id=saved.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="next" value="{{ url_for('admin_pcl_cases') }}">
                  <button class="secondary" type="submit">Remove</button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No saved searches yet. Save a run on the Get PACER Data page.</p>
    {% endif %}
  </section>

  <section class="card stack">
    <p class="pacer-eyebrow">Run history</p>
    <h3>Recent PACER runs</h3>
    <p class="small">Quick context on recent ingestion and updates.</p>
    {% if search_run_history %}
      <div class="stack">
        {% for run in search_run_history %}
          <div class="card">
            <p class="small"><strong>{{ run.search_type|capitalize }}</strong> · {{ run.search_mode|capitalize }} · {{ run.created_at_display }}</p>
            <p class="small">
              Court/Region: <code>{{ run.court_id or run.region_code or 'All' }}</code>
              {% if run.court_id and run.region_code %}
                · Region: <code>{{ run.region_code }}</code>
              {% endif %}
              {% if run.date_from or run.date_to %}
                · Date range: {{ run.date_from or '—' }} → {{ run.date_to or '—' }}
              {% endif %}
            </p>
            {% if run.sort_field %}
              <p class="small">Sort: {{ run.sort_field }} · {{ (run.sort_order or 'asc') | upper }}</p>
            {% endif %}
            <p class="small">
              New cases: {{ run.cases_inserted or 0 }} · Updated cases: {{ run.cases_updated or 0 }}
              · New parties: {{ run.parties_inserted or 0 }} · Updated parties: {{ run.parties_updated or 0 }}
            </p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="small">No stored runs yet.</p>
    {% endif %}
  </section>

  <section class="card pcl-cases-shell">
    <div class="pcl-cases-header">
      <div>
        <h2>Saved PACER cases</h2>
        <p class="small">Search and filter the cases you saved from PACER.</p>
      </div>
      <div class="pcl-cases-summary">
        <strong>{{ pagination.total }}</strong>
        <span class="small">total saved cases</span>
      </div>
    </div>

    <form method="get" class="pcl-filter-form" aria-label="Filter indexed cases">
      <div class="grid two">
        <div>
          <label for="pcl-court">Court</label>
          <input class="small" type="search" placeholder="Type to filter courts" data-filter-input="pcl-court">
          <select id="pcl-court" name="court_id">
            <option value="">All courts</option>
            {% for court in available_courts %}
              <option value="{{ court }}" {% if filters.court_id == court %}selected{% endif %}>{{ court }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="pcl-case-type">Case type</label>
          <input class="small" type="search" placeholder="Type to filter case types" data-filter-input="pcl-case-type">
          <select id="pcl-case-type" name="case_type">
            <option value="">All case types</option>
            {% for case_type in available_case_types %}
              <option value="{{ case_type }}" {% if filters.case_type == case_type %}selected{% endif %}>{{ case_type }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="pcl-date-from">Filed date (from)</label>
          <input id="pcl-date-from" type="date" name="date_filed_from" value="{{ filters.date_filed_from.isoformat() if filters.date_filed_from else '' }}">
        </div>
        <div>
          <label for="pcl-date-to">Filed date (to)</label>
          <input id="pcl-date-to" type="date" name="date_filed_to" value="{{ filters.date_filed_to.isoformat() if filters.date_filed_to else '' }}">
        </div>
        <div>
          <label for="pcl-judge">Judge last name</label>
          <input id="pcl-judge" name="judge_last_name" value="{{ filters.judge_last_name }}" placeholder="e.g., Jackson">
        </div>
        <div>
          <label for="pcl-search">Search case</label>
          <input id="pcl-search" name="q" value="{{ filters.search_text }}" placeholder="Case number or title">
        </div>
      </div>

      <fieldset class="pcl-flag-fieldset">
        <legend>Status filters</legend>
        <label class="pcl-flag-option">
          <input type="checkbox" name="indexed_only" value="1" {% if filters.indexed_only %}checked{% endif %}>
          Saved to database
        </label>
        <label class="pcl-flag-option">
          <input type="checkbox" name="enriched_only" value="1" {% if filters.enriched_only %}checked{% endif %}>
          Expanded data
        </label>
        <label class="pcl-flag-option">
          <input type="checkbox" name="sentencing_only" value="1" {% if filters.sentencing_only %}checked{% endif %}>
          Sentencing facts present
        </label>
      </fieldset>

      <div class="actions pcl-filter-actions">
        <button class="primary" type="submit">Apply filters</button>
        <a class="pill" href="{{ url_for('admin_pcl_cases') }}">Reset</a>
      </div>
    </form>
  </section>

  <section class="pcl-card-grid" aria-live="polite">
    {% if cases %}
      {% for case in cases %}
        <article class="card pcl-case-card">
          <header class="pcl-case-card__header">
            <div>
              <p class="pcl-case-card__number">{{ case.case_number_full or case.case_number }}</p>
              <h3 class="pcl-case-card__title">{{ case.short_title or case.case_title or "Untitled case" }}</h3>
            </div>
            <div class="pcl-case-card__badges">
              <span class="pcl-badge" data-variant="indexed">Saved</span>
              <span class="pcl-badge" data-variant="stub">
                Expanded data: {{ case.enrichment_status or "none" }}
              </span>
              <span class="pcl-badge" data-variant="{{ 'indexed' if case.has_sentencing else 'stub' }}">
                Sentencing: {{ "yes" if case.has_sentencing else "no" }}
              </span>
            </div>
          </header>

          <dl class="pcl-case-meta">
            <div>
              <dt>Date filed</dt>
              <dd>{{ case.date_filed.isoformat() if case.date_filed else "—" }}</dd>
            </div>
            <div>
              <dt>Date closed</dt>
              <dd>
                {% set closed_date = case.effective_date_closed or case.date_closed %}
                {{ closed_date.isoformat() if closed_date else "—" }}
              </dd>
            </div>
            <div>
              <dt>Court</dt>
              <dd>{{ case.court_id }}</dd>
            </div>
            <div>
              <dt>Judge</dt>
              <dd>{{ case.judge_last_name or "—" }}</dd>
            </div>
          </dl>

          <footer class="pcl-case-card__footer">
            <span class="small">Batch status: {{ case.segment_status or "unknown" }}</span>
            <span class="small">
              Last PACER run:
              {% if case.last_search_run_id %}
                Run #{{ case.last_search_run_id }}
              {% endif %}
              {% if case.last_search_run_at %}
                · {{ case.last_search_run_at.isoformat() }}
              {% else %}
                · —
              {% endif %}
            </span>
            <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <button class="secondary" type="submit">Expand data</button>
            </form>
            <a class="pill" href="{{ url_for('admin_pcl_case_detail', case_id=case.id) }}">View details</a>
          </footer>
        </article>
      {% endfor %}
    {% else %}
      <div class="card pcl-empty-state">
        <h3>No cases match those filters</h3>
        <p class="small">Try widening the date range or clearing a filter.</p>
      </div>
    {% endif %}
  </section>

  <nav class="pcl-pagination" aria-label="Indexed case pagination">
    {% set total_pages = pagination.total_pages %}
    {% set current_page = pagination.page %}
    <span class="small">Page {{ current_page }} of {{ total_pages }}</span>
    <div class="pcl-pagination__actions">
      <a class="pill {% if current_page <= 1 %}disabled{% endif %}" href="{{ page_url(current_page - 1) if current_page > 1 else '#' }}" aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">Previous</a>
      <a class="pill {% if current_page >= total_pages %}disabled{% endif %}" href="{{ page_url(current_page + 1) if current_page < total_pages else '#' }}" aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">Next</a>
    </div>
  </nav>
  <script>
    (function () {
      const filters = document.querySelectorAll("[data-filter-input]");
      filters.forEach((input) => {
        const targetId = input.getAttribute("data-filter-input");
        const select = document.getElementById(targetId);
        if (!select) return;
        const options = Array.from(select.options).map((opt) => ({
          value: opt.value,
          label: opt.textContent || "",
          selected: opt.selected,
        }));
        const placeholder = options.shift();
        input.addEventListener("input", () => {
          const query = input.value.trim().toLowerCase();
          select.innerHTML = "";
          if (placeholder) {
            const placeholderOpt = document.createElement("option");
            placeholderOpt.value = placeholder.value;
            placeholderOpt.textContent = placeholder.label;
            placeholderOpt.selected = placeholder.selected;
            select.appendChild(placeholderOpt);
          }
          options.forEach((opt) => {
            const label = opt.label.toLowerCase();
            const value = String(opt.value).toLowerCase();
            if (!query || label.includes(query) || value.includes(query)) {
              const optionEl = document.createElement("option");
              optionEl.value = opt.value;
              optionEl.textContent = opt.label;
              optionEl.selected = opt.selected;
              select.appendChild(optionEl);
            }
          });
        });
      });
    })();
  </script>
{% endblock %}
