{% extends "base.html" %}

{% block title %}Admin | Case Data One{% endblock %}

{% block content %}
  <div class="card">
    <div class="case-data-one-header">
      <div>
        <h1>Case Data One</h1>
        <p class="small">Browse case data one records in a card view.</p>
        <div id="case-data-one-import-status" class="small" style="margin-top: 8px;"></div>
      </div>
      <form id="case-data-one-search" class="case-data-one-search">
        <input
          type="search"
          name="search"
          id="case-data-one-search-input"
          placeholder="Search case number, short title, party, or judge names..."
          aria-label="Search Case Data One"
        />
        <button type="submit">Search</button>
      </form>
    </div>

    <div id="case-data-one-results" class="case-data-one-results"></div>
    <div class="case-data-one-pagination">
      <button type="button" id="case-data-one-prev" class="secondary">Previous</button>
      <span id="case-data-one-page" class="small"></span>
      <button type="button" id="case-data-one-next" class="secondary">Next</button>
    </div>
  </div>

  <style>
    .case-data-one-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .case-data-one-search {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 999px;
      background: #f7f7f7;
    }

    .case-data-one-search input {
      border: none;
      background: transparent;
      min-width: 280px;
      font-size: 1rem;
    }

    .case-data-one-search input:focus {
      outline: none;
    }

    .case-data-one-search button {
      border: none;
      background: #1f6feb;
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }

    .case-data-one-results {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .case-card {
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .case-card__title {
      font-weight: 700;
      font-size: 1.05rem;
      margin: 0;
    }

    .case-card__subtitle {
      color: #666;
      margin: 0;
    }

    .case-card__meta {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }

    .case-card__meta span {
      color: #444;
    }

    .case-data-one-pagination {
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .case-data-one-pagination button.secondary {
      border: 1px solid #d0d7de;
      background: #fff;
      color: #333;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const resultsEl = document.getElementById('case-data-one-results');
      const pageEl = document.getElementById('case-data-one-page');
      const prevButton = document.getElementById('case-data-one-prev');
      const nextButton = document.getElementById('case-data-one-next');
      const searchForm = document.getElementById('case-data-one-search');
      const searchInput = document.getElementById('case-data-one-search-input');
      const statusEl = document.getElementById('case-data-one-import-status');
      const statusUrl = '{{ url_for("admin_case_data_one_import_status") }}';
      const dataUrl = '{{ url_for("admin_case_data_one_data") }}';

      const state = {
        page: 1,
        perPage: 12,
        search: '',
        totalPages: 1
      };

      const formatValue = (value) => {
        if (value === null || value === undefined || value === '') {
          return 'â€”';
        }
        return value;
      };

      const renderCards = (records) => {
        resultsEl.innerHTML = '';
        if (!records.length) {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = 'No case records found.';
          resultsEl.appendChild(empty);
          return;
        }

        records.forEach((record) => {
          const card = document.createElement('div');
          card.className = 'case-card';

          const title = document.createElement('h3');
          title.className = 'case-card__title';
          title.textContent = formatValue(record.cs_case_number);

          const subtitle = document.createElement('p');
          subtitle.className = 'case-card__subtitle';
          subtitle.textContent = formatValue(record.cs_short_title);

          const meta = document.createElement('div');
          meta.className = 'case-card__meta';

          const fields = [
            { label: 'Filed', value: record.cs_date_filed },
            { label: 'Terminated', value: record.cs_date_term },
            { label: 'Case Type', value: record.cs_type },
            { label: 'Party', value: record.party },
            { label: 'Presiding Judge', value: record.pre_judge_name },
            { label: 'Referred Judge', value: record.ref_judge_name }
          ];

          fields.forEach((field) => {
            const row = document.createElement('span');
            row.textContent = `${field.label}: ${formatValue(field.value)}`;
            meta.appendChild(row);
          });

          card.appendChild(title);
          card.appendChild(subtitle);
          card.appendChild(meta);
          resultsEl.appendChild(card);
        });
      };

      const renderPagination = () => {
        pageEl.textContent = `Page ${state.page} of ${state.totalPages}`;
        prevButton.disabled = state.page <= 1;
        nextButton.disabled = state.page >= state.totalPages;
      };

      const fetchData = () => {
        const url = new URL(dataUrl, window.location.origin);
        url.searchParams.set('page', state.page);
        url.searchParams.set('per_page', state.perPage);
        if (state.search) {
          url.searchParams.set('search', state.search);
        }

        fetch(url, { credentials: 'same-origin' })
          .then((response) => response.json())
          .then((payload) => {
            renderCards(payload.data || []);
            state.totalPages = payload.totalPages || 1;
            renderPagination();
          })
          .catch(() => {
            resultsEl.innerHTML = '<div class="small">Unable to load case records.</div>';
          });
      };

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        state.search = searchInput.value.trim();
        state.page = 1;
        fetchData();
      });

      prevButton.addEventListener('click', () => {
        if (state.page > 1) {
          state.page -= 1;
          fetchData();
        }
      });

      nextButton.addEventListener('click', () => {
        if (state.page < state.totalPages) {
          state.page += 1;
          fetchData();
        }
      });

      function renderStatus(payload) {
        if (!statusEl) {
          return;
        }
        if (!payload || payload.status === 'idle') {
          statusEl.textContent = '';
          return;
        }
        if (payload.status === 'processing') {
          statusEl.textContent = 'Import status: processing...';
          return;
        }
        if (payload.status === 'completed') {
          statusEl.textContent = payload.message || 'Import completed.';
          return;
        }
        if (payload.status === 'failed') {
          statusEl.textContent = payload.message || 'Import failed.';
          return;
        }
        statusEl.textContent = 'Import status: ' + payload.status;
      }

      function pollStatus() {
        fetch(statusUrl, { credentials: 'same-origin' })
          .then((response) => response.json())
          .then((payload) => {
            renderStatus(payload);
            if (payload && payload.status === 'processing') {
              setTimeout(pollStatus, 3000);
            }
          })
          .catch(() => {});
      }

      pollStatus();
      fetchData();
    });
  </script>
{% endblock %}
