{% extends "base.html" %}

{% block title %}Admin | Case Data One Upload{% endblock %}

{% block content %}
  <div class="card">
    <h1>Case Data One Upload</h1>
    <p class="small">Upload the pipe-delimited Case Data One file (max 25MB).</p>

    <form method="post" enctype="multipart/form-data" style="margin-top: 16px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="file" name="case_data_one_file" accept=".txt,.csv" required>
      <div style="margin-top: 12px;">
        <button class="pill" type="submit">Upload case data one</button>
      </div>
    </form>

    <div id="case-data-one-status" style="margin-top: 24px; display: none;">
      <h2 style="margin-bottom: 8px;">Import Progress</h2>
      <div style="background: #f1f5f9; border-radius: 999px; height: 12px; overflow: hidden;">
        <div id="case-data-one-progress-bar" style="background: #2563eb; height: 12px; width: 0%;"></div>
      </div>
      <p id="case-data-one-progress-text" class="small" style="margin-top: 8px;">
        Waiting for import status...
      </p>
      <ul class="small" style="margin-top: 12px; padding-left: 18px;">
        <li>Total rows read: <span id="case-data-one-total">0</span></li>
        <li>Processed rows: <span id="case-data-one-processed">0</span></li>
        <li>Inserted rows: <span id="case-data-one-inserted">0</span></li>
        <li>Updated rows: <span id="case-data-one-updated">0</span></li>
        <li>Skipped rows: <span id="case-data-one-skipped">0</span></li>
        <li>Error rows: <span id="case-data-one-errors">0</span></li>
      </ul>
      <div id="case-data-one-error-actions" style="margin-top: 12px; display: none;">
        <p class="small" style="margin-bottom: 8px;">
          Parsing errors were detected. Download the error report or check the server logs.
        </p>
        <button class="pill" id="case-data-one-download-errors" type="button">
          Download error report
        </button>
      </div>
      <details id="case-data-one-error-details" style="margin-top: 12px; display: none;">
        <summary class="small">View error details</summary>
        <ul id="case-data-one-error-list" class="small" style="margin-top: 8px;"></ul>
      </details>
      <div id="case-data-one-ai" style="margin-top: 16px; display: none;">
        <p class="small" style="margin-bottom: 8px;">
          Generate an AI summary of the error report to help fix the source data.
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
          <button class="pill" id="case-data-one-ai-button" type="button">
            Generate AI response
          </button>
          <span id="case-data-one-ai-status" class="small"></span>
        </div>
        <div id="case-data-one-ai-response" style="margin-top: 12px; display: none;">
          <pre style="background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow-x: auto;">
<code id="case-data-one-ai-output"></code>
          </pre>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
            <button class="pill" id="case-data-one-ai-copy" type="button">
              Copy to clipboard
            </button>
            <span id="case-data-one-ai-copy-status" class="small"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusContainer = document.getElementById("case-data-one-status");
    const progressBar = document.getElementById("case-data-one-progress-bar");
    const progressText = document.getElementById("case-data-one-progress-text");
    const totalEl = document.getElementById("case-data-one-total");
    const processedEl = document.getElementById("case-data-one-processed");
    const insertedEl = document.getElementById("case-data-one-inserted");
    const updatedEl = document.getElementById("case-data-one-updated");
    const skippedEl = document.getElementById("case-data-one-skipped");
    const errorsEl = document.getElementById("case-data-one-errors");
    const errorActions = document.getElementById("case-data-one-error-actions");
    const errorDetails = document.getElementById("case-data-one-error-details");
    const errorList = document.getElementById("case-data-one-error-list");
    const downloadErrors = document.getElementById("case-data-one-download-errors");
    const aiContainer = document.getElementById("case-data-one-ai");
    const aiButton = document.getElementById("case-data-one-ai-button");
    const aiStatus = document.getElementById("case-data-one-ai-status");
    const aiResponse = document.getElementById("case-data-one-ai-response");
    const aiOutput = document.getElementById("case-data-one-ai-output");
    const aiCopyButton = document.getElementById("case-data-one-ai-copy");
    const aiCopyStatus = document.getElementById("case-data-one-ai-copy-status");
    let lastErrors = [];
    let lastStatus = null;

    function renderErrors(errors) {
      errorList.innerHTML = "";
      errors.forEach((item) => {
        const li = document.createElement("li");
        const rowLabel = item.row_number ? `Row ${item.row_number}` : "Row";
        const recordText = item.record ? item.record : "(none)";
        const rowEl = document.createElement("p");
        rowEl.textContent = rowLabel;
        const messageEl = document.createElement("p");
        messageEl.textContent = `Message: ${item.message}`;
        const recordEl = document.createElement("pre");
        recordEl.textContent = `Record: ${recordText}`;
        li.appendChild(rowEl);
        li.appendChild(messageEl);
        li.appendChild(recordEl);
        errorList.appendChild(li);
      });
    }

    function buildErrorReportText(errors) {
      return errors
        .map((item) => {
          const rowLabel = item.row_number ? `Row ${item.row_number}` : "Row";
          const recordText = item.record ? item.record : "(none)";
          return `${rowLabel}\nMessage: ${item.message}\nRecord: ${recordText}`;
        })
        .join("\n\n");
    }

    function downloadErrorReport() {
      if (!lastErrors.length) {
        return;
      }
      const blob = new Blob([buildErrorReportText(lastErrors)], {
        type: "text/plain;charset=utf-8",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "case-data-one-import-errors.txt";
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    downloadErrors.addEventListener("click", downloadErrorReport);

    async function copyAiOutput() {
      const text = aiOutput.textContent.trim();
      if (!text) {
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          textarea.remove();
        }
        aiCopyStatus.textContent = "Copied!";
      } catch (error) {
        console.error("Failed to copy", error);
        aiCopyStatus.textContent = "Copy failed.";
      }
      setTimeout(() => {
        aiCopyStatus.textContent = "";
      }, 2000);
    }

    aiCopyButton.addEventListener("click", copyAiOutput);

    async function requestAiSummary() {
      if (!lastErrors.length) {
        aiStatus.textContent = "No error details available.";
        return;
      }
      aiStatus.textContent = "Generating response...";
      aiOutput.textContent = "";
      aiResponse.style.display = "none";
      aiButton.disabled = true;
      aiCopyStatus.textContent = "";

      try {
        const payload = {
          error_details: lastErrors,
          total_rows: lastStatus?.total_rows,
          processed_rows: lastStatus?.processed_rows,
          inserted_rows: lastStatus?.inserted_rows,
          updated_rows: lastStatus?.updated_rows,
          skipped_rows: lastStatus?.skipped_rows,
          error_rows: lastStatus?.error_rows,
          message: lastStatus?.message,
        };
        const response = await fetch("/admin/case-data-one/error-prompt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": "{{ csrf_token }}",
          },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
          aiStatus.textContent = data.error || "Failed to generate response.";
          return;
        }
        aiOutput.textContent = data.response || "(No response returned.)";
        aiResponse.style.display = "block";
        aiStatus.textContent = "Response ready.";
      } catch (error) {
        console.error("Failed to request AI response", error);
        aiStatus.textContent = "Request failed. Please try again.";
      } finally {
        aiButton.disabled = false;
      }
    }

    aiButton.addEventListener("click", requestAiSummary);

    async function fetchStatus() {
      try {
        const response = await fetch("/admin/case-data-one/import-status", {
          headers: {"Accept": "application/json"},
        });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (!data || data.status === "idle") {
          return;
        }
        lastStatus = data;
        statusContainer.style.display = "block";
        totalEl.textContent = data.total_rows ?? 0;
        processedEl.textContent = data.processed_rows ?? 0;
        insertedEl.textContent = data.inserted_rows ?? 0;
        updatedEl.textContent = data.updated_rows ?? 0;
        skippedEl.textContent = data.skipped_rows ?? 0;
        errorsEl.textContent = data.error_rows ?? 0;

        const total = Number(data.total_rows ?? 0);
        const processed = Number(data.processed_rows ?? 0);
        const percent = total > 0 ? Math.min((processed / total) * 100, 100) : 0;
        progressBar.style.width = `${percent}%`;
        progressText.textContent = data.message || `Status: ${data.status}`;

        lastErrors = Array.isArray(data.error_details) ? data.error_details : [];
        if (lastErrors.length) {
          errorActions.style.display = "block";
          errorDetails.style.display = "block";
          aiContainer.style.display = "block";
          renderErrors(lastErrors);
        } else {
          errorActions.style.display = "none";
          errorDetails.style.display = "none";
          aiContainer.style.display = "none";
        }

        if (data.status === "completed" || data.status === "failed") {
          clearInterval(window.caseDataOneStatusTimer);
        }
      } catch (error) {
        console.error("Failed to fetch import status", error);
      }
    }

    fetchStatus();
    window.caseDataOneStatusTimer = setInterval(fetchStatus, 3000);
  </script>
{% endblock %}
