{% extends "base.html" %}

{% block title %}Admin | Import Case Data (Legacy){% endblock %}

{% block content %}
  <div class="card upload-card">
    <div class="upload-header">
      <div>
        <h1>Import Case Data (Legacy)</h1>
        <p class="small">Upload a pipe-delimited file (max 25MB) to the legacy imported-cases dataset.</p>
      </div>
      <span class="upload-badge">Admin upload</span>
    </div>

    <div class="actions mt-8">
      <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases', source='imported') }}">Back to imported cases</a>
      <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases') }}">Go to cases</a>
    </div>

    <div class="upload-guidance">
      <div>
        <h3>What happens next</h3>
        <ul>
          <li>We validate each row and track progress in real time.</li>
          <li>You will see totals, inserts, updates, skips, and errors as they happen.</li>
          <li>If any error occurs, nothing is added and you can download a report.</li>
        </ul>
      </div>
      <div class="upload-callout">
        <strong>Tip:</strong> Make sure the header row includes <code>cs_caseid</code> and dates are in a parseable format.
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="upload-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label class="file-input">
        <input id="case-data-one-file" type="file" name="case_data_one_file" accept=".txt,.csv" required>
        <span id="case-data-one-file-label">Select file to upload</span>
      </label>
      <button class="pill" type="submit">Upload file</button>
    </form>
    <div id="case-data-one-file-panel" class="file-panel" style="display: none;">
      <div class="file-meta">
        <div>
          <strong id="case-data-one-file-name">No file selected</strong>
          <p id="case-data-one-file-size" class="small"></p>
        </div>
        <span class="file-status">Ready</span>
      </div>
      <div class="file-preflight">
        <div>
          <span class="small">Preflight rows</span>
          <strong id="case-data-one-file-rows">-</strong>
        </div>
        <div>
          <span class="small">Header check</span>
          <strong id="case-data-one-file-header">Pending</strong>
        </div>
      </div>
      <p id="case-data-one-file-warning" class="small"></p>
    </div>

    <div id="case-data-one-status" class="upload-status" style="display: none;">
      <div class="status-header">
        <div>
          <h2>Import Progress</h2>
          <p id="case-data-one-progress-text" class="small">Waiting for import status...</p>
        </div>
        <span id="case-data-one-status-pill" class="status-pill">Waiting</span>
      </div>
      <div class="progress-track">
        <div id="case-data-one-progress-bar" class="progress-bar"></div>
      </div>
      <div class="progress-meta small">
        <span id="case-data-one-progress-percent">0%</span>
        <span id="case-data-one-progress-value">0 / 0 rows</span>
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <span>Total rows</span>
          <strong id="case-data-one-total">0</strong>
        </div>
        <div class="stat-card">
          <span>Processed</span>
          <strong id="case-data-one-processed">0</strong>
        </div>
        <div class="stat-card">
          <span>Inserted</span>
          <strong id="case-data-one-inserted">0</strong>
        </div>
        <div class="stat-card">
          <span>Updated</span>
          <strong id="case-data-one-updated">0</strong>
        </div>
        <div class="stat-card">
          <span>Skipped</span>
          <strong id="case-data-one-skipped">0</strong>
        </div>
        <div class="stat-card stat-card--error">
          <span>Errors</span>
          <strong id="case-data-one-errors">0</strong>
        </div>
      </div>
      <div id="case-data-one-error-actions" class="error-actions" style="display: none;">
        <p class="small">
          One or more errors occurred; no files were added to the database. Download the
          error report or check the server logs.
        </p>
        <button class="pill" id="case-data-one-download-errors" type="button">
          Download error report
        </button>
      </div>
      <details id="case-data-one-error-details" class="error-details" style="display: none;">
        <summary class="small">View error details</summary>
        <ul id="case-data-one-error-list" class="small"></ul>
      </details>
      <div id="case-data-one-ai" class="ai-panel" style="display: none;">
        <p class="small">
          Generate an AI response that builds a Codex prompt for fixing the source data.
        </p>
        <div class="ai-controls">
          <button class="pill" id="case-data-one-ai-button" type="button">
            Generate AI response
          </button>
          <span id="case-data-one-ai-status" class="small"></span>
        </div>
        <div id="case-data-one-ai-response" class="ai-response" style="display: none;">
          <pre><code id="case-data-one-ai-output"></code></pre>
          <div class="ai-actions">
            <button class="pill" id="case-data-one-ai-copy" type="button">
              Copy to clipboard
            </button>
            <span id="case-data-one-ai-copy-status" class="small"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusContainer = document.getElementById("case-data-one-status");
    const progressBar = document.getElementById("case-data-one-progress-bar");
    const progressText = document.getElementById("case-data-one-progress-text");
    const statusPill = document.getElementById("case-data-one-status-pill");
    const progressPercent = document.getElementById("case-data-one-progress-percent");
    const progressValue = document.getElementById("case-data-one-progress-value");
    const totalEl = document.getElementById("case-data-one-total");
    const processedEl = document.getElementById("case-data-one-processed");
    const insertedEl = document.getElementById("case-data-one-inserted");
    const updatedEl = document.getElementById("case-data-one-updated");
    const skippedEl = document.getElementById("case-data-one-skipped");
    const errorsEl = document.getElementById("case-data-one-errors");
    const errorActions = document.getElementById("case-data-one-error-actions");
    const errorDetails = document.getElementById("case-data-one-error-details");
    const errorList = document.getElementById("case-data-one-error-list");
    const downloadErrors = document.getElementById("case-data-one-download-errors");
    const aiContainer = document.getElementById("case-data-one-ai");
    const aiButton = document.getElementById("case-data-one-ai-button");
    const aiStatus = document.getElementById("case-data-one-ai-status");
    const aiResponse = document.getElementById("case-data-one-ai-response");
    const aiOutput = document.getElementById("case-data-one-ai-output");
    const aiCopyButton = document.getElementById("case-data-one-ai-copy");
    const aiCopyStatus = document.getElementById("case-data-one-ai-copy-status");
    let lastErrors = [];
    let lastStatus = null;

    function formatRecord(record) {
      if (record === null || record === undefined || record === "") {
        return "(none)";
      }
      if (typeof record === "string") {
        try {
          const parsed = JSON.parse(record);
          if (Array.isArray(parsed)) {
            return parsed.join("|");
          }
          if (parsed && typeof parsed === "object") {
            return JSON.stringify(parsed, null, 2);
          }
        } catch (error) {
          return record;
        }
        return record;
      }
      if (Array.isArray(record)) {
        return record.join("|");
      }
      if (record && typeof record === "object") {
        return JSON.stringify(record, null, 2);
      }
      return String(record);
    }

    function renderErrors(errors) {
      errorList.innerHTML = "";
      if (!errors.length) {
        const li = document.createElement("li");
        li.textContent = "No itemized error records were captured.";
        errorList.appendChild(li);
        return;
      }
      errors.forEach((item) => {
        const li = document.createElement("li");
        const rowLabel = item.row_number ? `Row ${item.row_number}` : "Row";
        const recordText = formatRecord(item.record);
        const rowEl = document.createElement("p");
        rowEl.textContent = rowLabel;
        const messageEl = document.createElement("p");
        messageEl.textContent = `Message: ${item.message}`;
        const recordEl = document.createElement("pre");
        recordEl.textContent = `Record: ${recordText}`;
        li.appendChild(rowEl);
        li.appendChild(messageEl);
        li.appendChild(recordEl);
        errorList.appendChild(li);
      });
    }

    function buildErrorReportText(errors) {
      const summary = [
        `Status: ${lastStatus?.status || "unknown"}`,
        `Message: ${lastStatus?.message || "N/A"}`,
        `Total rows: ${lastStatus?.total_rows ?? 0}`,
        `Processed rows: ${lastStatus?.processed_rows ?? 0}`,
        `Inserted rows: ${lastStatus?.inserted_rows ?? 0}`,
        `Updated rows: ${lastStatus?.updated_rows ?? 0}`,
        `Skipped rows: ${lastStatus?.skipped_rows ?? 0}`,
        `Error rows: ${lastStatus?.error_rows ?? 0}`,
        "",
      ].join("\n");
      const details = errors.length
        ? errors
            .map((item) => {
              const rowLabel = item.row_number ? `Row ${item.row_number}` : "Row";
              const recordText = formatRecord(item.record);
              return `${rowLabel}\nMessage: ${item.message}\nRecord: ${recordText}`;
            })
            .join("\n\n")
        : "No itemized error records were captured.";
      return `${summary}${details}`;
    }

    async function downloadErrorReport() {
      if (!lastStatus || !(lastStatus.error_rows > 0)) {
        return;
      }
      try {
        const response = await fetch("/admin/case-data-one/error-report");
        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "case-data-one-import-errors.txt";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
          return;
        }
      } catch (error) {
        console.error("Failed to download server report", error);
      }
      const blob = new Blob([buildErrorReportText(lastErrors)], {
        type: "text/plain;charset=utf-8",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "case-data-one-import-errors.txt";
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    downloadErrors.addEventListener("click", downloadErrorReport);

    async function copyAiOutput() {
      const text = aiOutput.textContent.trim();
      if (!text) {
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          textarea.remove();
        }
        aiCopyStatus.textContent = "Copied!";
      } catch (error) {
        console.error("Failed to copy", error);
        aiCopyStatus.textContent = "Copy failed.";
      }
      setTimeout(() => {
        aiCopyStatus.textContent = "";
      }, 2000);
    }

    aiCopyButton.addEventListener("click", copyAiOutput);

    async function requestAiSummary() {
      if (!lastErrors.length) {
        aiStatus.textContent = "No error details available.";
        return;
      }
      aiStatus.textContent = "Generating response...";
      aiOutput.textContent = "";
      aiResponse.style.display = "none";
      aiButton.disabled = true;
      aiCopyStatus.textContent = "";

      try {
        const payload = {
          error_details: lastErrors,
          total_rows: lastStatus?.total_rows,
          processed_rows: lastStatus?.processed_rows,
          inserted_rows: lastStatus?.inserted_rows,
          updated_rows: lastStatus?.updated_rows,
          skipped_rows: lastStatus?.skipped_rows,
          error_rows: lastStatus?.error_rows,
          message: lastStatus?.message,
        };
        const response = await fetch("/admin/case-data-one/error-prompt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": "{{ csrf_token }}",
          },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
          aiStatus.textContent = data.error || "Failed to generate response.";
          return;
        }
        aiOutput.textContent = data.response || "(No response returned.)";
        aiResponse.style.display = "block";
        aiStatus.textContent = "Response ready.";
      } catch (error) {
        console.error("Failed to request AI response", error);
        aiStatus.textContent = "Request failed. Please try again.";
      } finally {
        aiButton.disabled = false;
      }
    }

    aiButton.addEventListener("click", requestAiSummary);

    async function fetchStatus() {
      try {
        const response = await fetch("/admin/case-data-one/import-status", {
          headers: {"Accept": "application/json"},
        });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (!data || data.status === "idle") {
          return;
        }
        lastStatus = data;
        statusContainer.style.display = "block";
        totalEl.textContent = data.total_rows ?? 0;
        processedEl.textContent = data.processed_rows ?? 0;
        insertedEl.textContent = data.inserted_rows ?? 0;
        updatedEl.textContent = data.updated_rows ?? 0;
        skippedEl.textContent = data.skipped_rows ?? 0;
        errorsEl.textContent = data.error_rows ?? 0;

        const total = Number(data.total_rows ?? 0);
        const processed = Number(data.processed_rows ?? 0);
        const percent = total > 0 ? Math.min((processed / total) * 100, 100) : 0;
        const percentLabel = `${Math.round(percent)}%`;
        progressBar.style.width = `${percent}%`;
        progressText.textContent = data.message || `Status: ${data.status}`;
        progressPercent.textContent = percentLabel;
        progressValue.textContent = `${processed} / ${total} rows`;
        if (statusPill) {
          statusPill.textContent = data.status || "processing";
          statusPill.dataset.status = data.status || "processing";
        }

        lastErrors = Array.isArray(data.error_details) ? data.error_details : [];
        const hasErrors = Number(data.error_rows ?? 0) > 0;
        if (hasErrors) {
          errorActions.style.display = "block";
          aiContainer.style.display = "block";
          renderErrors(lastErrors);
          errorDetails.style.display = "block";
        } else {
          errorActions.style.display = "none";
          errorDetails.style.display = "none";
          aiContainer.style.display = "none";
        }

        if (data.status === "completed" || data.status === "failed") {
          clearInterval(window.caseDataOneStatusTimer);
        }
      } catch (error) {
        console.error("Failed to fetch import status", error);
      }
    }

    fetchStatus();
    window.caseDataOneStatusTimer = setInterval(fetchStatus, 3000);

    const fileInput = document.getElementById("case-data-one-file");
    const fileLabel = document.getElementById("case-data-one-file-label");
    const filePanel = document.getElementById("case-data-one-file-panel");
    const fileName = document.getElementById("case-data-one-file-name");
    const fileSize = document.getElementById("case-data-one-file-size");
    const fileRows = document.getElementById("case-data-one-file-rows");
    const fileHeader = document.getElementById("case-data-one-file-header");
    const fileWarning = document.getElementById("case-data-one-file-warning");

    function formatBytes(bytes) {
      if (!bytes) {
        return "0 B";
      }
      const units = ["B", "KB", "MB", "GB"];
      let value = bytes;
      let index = 0;
      while (value >= 1024 && index < units.length - 1) {
        value /= 1024;
        index += 1;
      }
      return `${value.toFixed(1)} ${units[index]}`;
    }

    async function runPreflight(file) {
      fileLabel.textContent = file.name;
      fileName.textContent = file.name;
      fileSize.textContent = `Size: ${formatBytes(file.size)}`;
      fileRows.textContent = "Scanning...";
      fileHeader.textContent = "Scanning...";
      fileWarning.textContent = "";
      filePanel.style.display = "block";

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
        const headerLine = lines[0] || "";
        const headers = headerLine
          .split("|")
          .map((value) => value.trim())
          .filter(Boolean);
        const hasCaseId = headers.includes("cs_caseid");
        fileRows.textContent = Math.max(0, lines.length - 1).toString();
        fileHeader.textContent = hasCaseId ? "cs_caseid ok" : "Missing cs_caseid";
        if (!hasCaseId) {
          fileWarning.textContent =
            "Preflight warning: header is missing cs_caseid.";
        } else {
          fileWarning.textContent = "Preflight complete. Ready to upload.";
        }
      } catch (error) {
        console.error("Failed to read file", error);
        fileRows.textContent = "Unavailable";
        fileHeader.textContent = "Unavailable";
        fileWarning.textContent =
          "Preflight failed. You can still upload, or try selecting the file again.";
      }
    }

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) {
        fileLabel.textContent = "Select file to upload";
        filePanel.style.display = "none";
        return;
      }
      runPreflight(file);
    });
  </script>
{% endblock %}
