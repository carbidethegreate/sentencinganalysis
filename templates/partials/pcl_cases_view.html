  {% set active_filter_count = 0 %}
  {% if filters.court_id %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.case_type %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.date_filed_from %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.date_filed_to %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.judge_last_name %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.search_text %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.field_name %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.field_value %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.indexed_only %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.enriched_only %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.sentencing_only %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% set total_pages = pagination.total_pages %}
  {% set current_page = pagination.page %}
  {% set has_results = pagination.total > 0 %}
  {% set start_index = ((current_page - 1) * pagination.page_size) + 1 if has_results else 0 %}
  {% set end_index = (start_index + (cases|length) - 1) if has_results else 0 %}
  {% set window_start = (current_page - 2) if (current_page - 2) > 1 else 1 %}
  {% set window_end = (current_page + 2) if (current_page + 2) < total_pages else total_pages %}

  <section class="card cases-hero">
    <div class="cases-hero__text">
      <p class="pacer-eyebrow">Case Operations</p>
      <h2>PACER Cases (Operations)</h2>
      <p class="small">Find cases fast, triage enrichment work, and jump straight into detail records.</p>
    </div>
    <div class="cases-hero__stats">
      <div class="cases-kpi">
        <span class="cases-kpi__label">Total matches</span>
        <strong class="cases-kpi__value">{{ pagination.total }}</strong>
      </div>
      <div class="cases-kpi">
        <span class="cases-kpi__label">Shown on page</span>
        <strong class="cases-kpi__value">{{ cases|length }}</strong>
      </div>
      <div class="cases-kpi">
        <span class="cases-kpi__label">Active filters</span>
        <strong class="cases-kpi__value">{{ active_filter_count }}</strong>
      </div>
    </div>
  </section>

  <section class="card cases-filter-card">
    <div class="cases-filter-card__header">
      <div>
        <h3>Filter cases</h3>
        <p class="small">Start broad, then narrow by date, metadata, and status.</p>
      </div>
      <div class="cases-filter-card__summary">
        <span class="cases-filter-summary-pill">{{ active_filter_count }} active</span>
        <span class="small">Showing {{ cases|length }} of {{ pagination.total }}</span>
      </div>
    </div>

    {% if active_filter_count > 0 %}
      <div class="cases-active-filters" aria-label="Active filters">
        {% if filters.search_text %}<span class="cases-filter-chip">Search: {{ filters.search_text }}</span>{% endif %}
        {% if filters.court_id %}<span class="cases-filter-chip">Court: {{ filters.court_id }}</span>{% endif %}
        {% if filters.case_type %}<span class="cases-filter-chip">Type: {{ filters.case_type }}</span>{% endif %}
        {% if filters.date_filed_from %}<span class="cases-filter-chip">From: {{ filters.date_filed_from.isoformat() }}</span>{% endif %}
        {% if filters.date_filed_to %}<span class="cases-filter-chip">To: {{ filters.date_filed_to.isoformat() }}</span>{% endif %}
        {% if filters.judge_last_name %}<span class="cases-filter-chip">Judge: {{ filters.judge_last_name }}</span>{% endif %}
        {% if filters.field_name %}<span class="cases-filter-chip">Field: {{ filters.field_name }}</span>{% endif %}
        {% if filters.field_value %}<span class="cases-filter-chip">Value: {{ filters.field_value }}</span>{% endif %}
        {% if filters.indexed_only %}<span class="cases-filter-chip">Saved only</span>{% endif %}
        {% if filters.enriched_only %}<span class="cases-filter-chip">Enriched only</span>{% endif %}
        {% if filters.sentencing_only %}<span class="cases-filter-chip">Sentencing only</span>{% endif %}
        <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases', source='pacer', view='ops', page_size=pagination.page_size) }}">Clear all</a>
      </div>
    {% endif %}

    <form method="get" class="pcl-filter-form cases-filter-form" id="cases-filter-form" aria-label="Filter saved PACER cases">
      <input type="hidden" name="source" value="pacer">
      <input type="hidden" name="view" value="ops">
      <input type="hidden" name="page_size" value="{{ pagination.page_size }}">
      <section class="cases-filter-block">
        <header class="cases-filter-block__header">
          <h4>Case basics</h4>
          <p class="small">Use text, court, and case type to narrow quickly.</p>
        </header>
        <div class="grid three cases-filter-grid">
          <div class="cases-filter-field cases-filter-field--wide">
            <label for="pcl-search">Search case</label>
            <input id="pcl-search" name="q" value="{{ filters.search_text }}" placeholder="Case number, title, or keyword">
          </div>
          <div class="cases-filter-field">
            <label for="pcl-court">Court</label>
            <input class="small" type="search" placeholder="Type to filter courts" data-filter-input="pcl-court">
            <select id="pcl-court" name="court_id">
              <option value="">All courts</option>
              {% for court in available_courts %}
                <option value="{{ court }}" {% if filters.court_id == court %}selected{% endif %}>{{ court }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="cases-filter-field">
            <label for="pcl-case-type">Case type</label>
            <input class="small" type="search" placeholder="Type to filter case types" data-filter-input="pcl-case-type">
            <select id="pcl-case-type" name="case_type">
              <option value="">All case types</option>
              {% for case_type in available_case_types %}
                <option value="{{ case_type }}" {% if filters.case_type == case_type %}selected{% endif %}>{{ case_type }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="cases-filter-field">
            <label for="pcl-judge">Judge last name</label>
            <input id="pcl-judge" name="judge_last_name" value="{{ filters.judge_last_name }}" placeholder="e.g., Jackson">
          </div>
        </div>
      </section>

      <section class="cases-filter-block">
        <header class="cases-filter-block__header">
          <h4>Date window</h4>
          <p class="small">Target filed-date ranges with one click shortcuts.</p>
        </header>
        <div class="grid three cases-filter-grid">
          <div class="cases-filter-field">
            <label for="pcl-date-from">Filed date (from)</label>
            <input id="pcl-date-from" type="date" name="date_filed_from" value="{{ filters.date_filed_from.isoformat() if filters.date_filed_from else '' }}">
          </div>
          <div class="cases-filter-field">
            <label for="pcl-date-to">Filed date (to)</label>
            <input id="pcl-date-to" type="date" name="date_filed_to" value="{{ filters.date_filed_to.isoformat() if filters.date_filed_to else '' }}">
          </div>
          <div class="cases-filter-field">
            <span class="small cases-date-shortcuts__label">Quick ranges</span>
            <div class="cases-date-shortcuts">
              <button class="pill" type="button" data-range-days="30">30 days</button>
              <button class="pill" type="button" data-range-days="90">90 days</button>
              <button class="pill" type="button" data-range-days="365">12 months</button>
              <button class="pill" type="button" data-range="ytd">YTD</button>
              <button class="pill" type="button" data-range="clear">Clear</button>
            </div>
          </div>
        </div>
      </section>

      <section class="cases-filter-block">
        <header class="cases-filter-block__header">
          <h4>Field contains</h4>
          <p class="small">Search within any captured PACER field.</p>
        </header>
        <div class="grid two cases-filter-grid">
          <div class="cases-filter-field">
            <label for="pcl-field-name">Field name</label>
            <input id="pcl-field-name" name="field_name" list="pcl-field-name-list" value="{{ filters.field_name }}" placeholder="e.g., caseId">
            <datalist id="pcl-field-name-list">
              {% for field_name in case_field_choices %}
                <option value="{{ field_name }}"></option>
              {% endfor %}
            </datalist>
          </div>
          <div class="cases-filter-field">
            <label for="pcl-field-value">Field value contains</label>
            <input id="pcl-field-value" name="field_value" value="{{ filters.field_value }}" placeholder="e.g., 2025 or vidc">
            <p class="small">Matches plain text and JSON field values.</p>
          </div>
        </div>
      </section>

      <section class="cases-filter-block">
        <header class="cases-filter-block__header">
          <h4>Status</h4>
        </header>
        <fieldset class="pcl-flag-fieldset cases-flag-fieldset">
          <legend>Status filters</legend>
          <label class="pcl-flag-option">
            <input type="checkbox" name="indexed_only" value="1" {% if filters.indexed_only %}checked{% endif %}>
            <span>Saved to database</span>
          </label>
          <label class="pcl-flag-option">
            <input type="checkbox" name="enriched_only" value="1" {% if filters.enriched_only %}checked{% endif %}>
            <span>Expanded data</span>
          </label>
          <label class="pcl-flag-option">
            <input type="checkbox" name="sentencing_only" value="1" {% if filters.sentencing_only %}checked{% endif %}>
            <span>Sentencing facts present</span>
          </label>
        </fieldset>
      </section>

      <div class="actions pcl-filter-actions cases-filter-actions">
        <button class="primary" type="submit">Apply filters</button>
        <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases', source='pacer', view='ops', page_size=pagination.page_size) }}">Reset all</a>
        <span class="small">Shortcut: press <code>/</code> to focus case search.</span>
      </div>
    </form>
  </section>

  <section class="cases-support-grid">
    <article class="card cases-support-card">
      <div class="cases-support-card__header">
        <p class="pacer-eyebrow">Saved Searches</p>
        <h3>Reusable PACER presets</h3>
      </div>
      <p class="small">Run a saved search to refresh or expand your case dataset.</p>
      {% if saved_searches %}
        <div class="cases-support-list">
          {% for saved in saved_searches %}
            <div class="cases-support-item">
              <div>
                <p class="small"><strong>{{ saved.label }}</strong></p>
                <p class="small">
                  {{ saved.search_type|capitalize }} · {{ saved.search_mode|capitalize }} · {{ saved.schedule_label|capitalize }}
                </p>
                <p class="small">
                  {{ saved.summary.court_id or saved.summary.region_code or 'All' }}
                  {% if saved.summary.date_from or saved.summary.date_to %}
                    · {{ saved.summary.date_from or '—' }} → {{ saved.summary.date_to or '—' }}
                  {% endif %}
                </p>
                {% if saved.last_run_display %}
                  <p class="small">Last run: {{ saved.last_run_display }}</p>
                {% endif %}
              </div>
              <div class="actions">
                <form method="post" action="{{ url_for('admin_pacer_explore_run') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  {% for field in saved.run_fields %}
                    <input type="hidden" name="{{ field.name }}" value="{{ field.value }}">
                  {% endfor %}
                  <button class="secondary" type="submit">Run</button>
                </form>
                <form method="post" action="{{ url_for('admin_pacer_saved_search_delete', search_id=saved.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="next" value="{{ url_for('admin_federal_data_dashboard_cases', source='pacer', view='ops') }}">
                  <button class="secondary" type="submit">Remove</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="small">No saved searches yet. Save one from Get PACER Data.</p>
      {% endif %}
    </article>

    <article class="card cases-support-card">
      <div class="cases-support-card__header">
        <p class="pacer-eyebrow">Run History</p>
        <h3>Recent PACER runs</h3>
      </div>
      <p class="small">Quick context on what was newly inserted or updated.</p>
      {% if search_run_history %}
        <div class="cases-support-list">
          {% for run in search_run_history %}
            <div class="cases-support-item">
              <div>
                <p class="small"><strong>{{ run.search_type|capitalize }}</strong> · {{ run.search_mode|capitalize }} · {{ run.created_at_display }}</p>
                <p class="small">
                  {{ run.court_id or run.region_code or 'All' }}
                  {% if run.date_from or run.date_to %}
                    · {{ run.date_from or '—' }} → {{ run.date_to or '—' }}
                  {% endif %}
                </p>
                <p class="small">
                  New {{ run.cases_inserted or 0 }} / Updated {{ run.cases_updated or 0 }} cases
                  · New {{ run.parties_inserted or 0 }} / Updated {{ run.parties_updated or 0 }} parties
                </p>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="small">No stored runs yet.</p>
      {% endif %}
    </article>
  </section>

  <section class="cases-results" aria-live="polite">
    <div class="cases-results__header">
      <div>
        <h3>Case results</h3>
        <p class="small">Sorted by your active filters and pagination settings.</p>
      </div>
      <div class="pcl-cases-summary">
        <strong>{{ pagination.total }}</strong>
        <span class="small">matching cases</span>
      </div>
    </div>

	    <div class="cases-results__tools">
	      <form method="get" class="cases-page-size-form" id="cases-page-size-form">
	        <input type="hidden" name="source" value="pacer">
	        <input type="hidden" name="view" value="ops">
	        <input type="hidden" name="page" value="1">
	        {% if filters.search_text %}<input type="hidden" name="q" value="{{ filters.search_text }}">{% endif %}
	        {% if filters.court_id %}<input type="hidden" name="court_id" value="{{ filters.court_id }}">{% endif %}
	        {% if filters.case_type %}<input type="hidden" name="case_type" value="{{ filters.case_type }}">{% endif %}
        {% if filters.date_filed_from %}<input type="hidden" name="date_filed_from" value="{{ filters.date_filed_from.isoformat() }}">{% endif %}
        {% if filters.date_filed_to %}<input type="hidden" name="date_filed_to" value="{{ filters.date_filed_to.isoformat() }}">{% endif %}
        {% if filters.judge_last_name %}<input type="hidden" name="judge_last_name" value="{{ filters.judge_last_name }}">{% endif %}
        {% if filters.field_name %}<input type="hidden" name="field_name" value="{{ filters.field_name }}">{% endif %}
        {% if filters.field_value %}<input type="hidden" name="field_value" value="{{ filters.field_value }}">{% endif %}
        {% if filters.indexed_only %}<input type="hidden" name="indexed_only" value="1">{% endif %}
        {% if filters.enriched_only %}<input type="hidden" name="enriched_only" value="1">{% endif %}
        {% if filters.sentencing_only %}<input type="hidden" name="sentencing_only" value="1">{% endif %}

        <label for="cases-page-size">Rows per page</label>
        <select id="cases-page-size" name="page_size">
          {% for size in [10, 25, 50, 100] %}
            <option value="{{ size }}" {% if pagination.page_size == size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </form>

      {% if cases %}
        <div class="cases-results__view-tools">
          <label for="cases-quick-filter">Quick filter</label>
          <input id="cases-quick-filter" type="search" placeholder="Filter cards on this page">
          <label for="cases-client-sort">Sort visible</label>
          <select id="cases-client-sort">
            <option value="default">Default</option>
            <option value="date_filed_desc">Filed date (newest)</option>
            <option value="date_filed_asc">Filed date (oldest)</option>
            <option value="court_asc">Court (A-Z)</option>
            <option value="case_number_asc">Case number (A-Z)</option>
          </select>
          <button class="pill" type="button" id="cases-view-reset">Reset view</button>
        </div>
      {% endif %}

      <p class="small" id="cases-visible-range" data-start="{{ start_index }}" data-end="{{ end_index }}" data-page-count="{{ cases|length }}" data-total="{{ pagination.total }}">
        Showing {{ start_index }}-{{ end_index }} of {{ pagination.total }}
      </p>

      {% if cases %}
        <label class="cases-select-toggle">
          <input type="checkbox" id="cases-select-all">
          Select visible
        </label>
      {% endif %}
    </div>

    {% if cases %}
      <div class="cases-bulk-bar" id="cases-bulk-bar" hidden>
        <span class="cases-bulk-bar__count" id="cases-selected-count">0 selected</span>
        <button class="secondary" type="button" id="cases-bulk-queue">Queue docket for selected</button>
        <button class="pill" type="button" id="cases-bulk-clear">Clear selection</button>
        <span class="small" id="cases-bulk-status" aria-live="polite"></span>
      </div>

      <div class="cases-grid" id="cases-grid">
        {% for case in cases %}
          <article
            class="card cases-case-card"
            data-order="{{ loop.index0 }}"
            data-case-number="{{ case.case_number_full or case.case_number or '' }}"
            data-case-title="{{ case.short_title or case.case_title or '' }}"
            data-court-id="{{ case.court_id or '' }}"
            data-case-type="{{ case.case_type or '' }}"
            data-date-filed="{{ case.date_filed.isoformat() if case.date_filed else '' }}"
            data-judge="{{ case.judge_last_name or '' }}"
            data-enrichment-status="{{ case.enrichment_status or 'none' }}"
            data-has-sentencing="{{ '1' if case.has_sentencing else '0' }}"
          >
            <header class="cases-case-card__header">
              <div>
                <p class="cases-case-card__number">{{ case.case_number_full or case.case_number }}</p>
                <h4 class="cases-case-card__title">{{ case.short_title or case.case_title or "Untitled case" }}</h4>
              </div>
              <div class="cases-case-card__right">
                <label class="cases-case-select">
                  <input
                    type="checkbox"
                    class="cases-select-item"
                    value="{{ case.id }}"
                    data-case-number="{{ case.case_number_full or case.case_number }}"
                  >
                  <span>Select</span>
                </label>
                <div class="cases-case-card__badges">
                  <span class="pcl-badge" data-variant="indexed">Saved</span>
                  <span class="pcl-badge" data-variant="{{ 'indexed' if case.enrichment_status and case.enrichment_status != 'none' else 'stub' }}">
                    Enrichment: {{ case.enrichment_status or "none" }}
                  </span>
                  <span class="pcl-badge" data-variant="{{ 'indexed' if case.has_sentencing else 'stub' }}">
                    Sentencing: {{ "yes" if case.has_sentencing else "no" }}
                  </span>
                </div>
              </div>
            </header>

            <dl class="cases-case-meta">
              <div>
                <dt>Date filed</dt>
                <dd>{{ case.date_filed.isoformat() if case.date_filed else "—" }}</dd>
              </div>
              <div>
                <dt>Date closed</dt>
                <dd>
                  {% set closed_date = case.effective_date_closed or case.date_closed %}
                  {{ closed_date.isoformat() if closed_date else "—" }}
                </dd>
              </div>
              <div>
                <dt>Court</dt>
                <dd>{{ case.court_id }}</dd>
              </div>
              <div>
                <dt>Case type</dt>
                <dd>{{ case.case_type or "—" }}</dd>
              </div>
              <div>
                <dt>Judge</dt>
                <dd>{{ case.judge_last_name or "—" }}</dd>
              </div>
              <div>
                <dt>Segment status</dt>
                <dd>{{ case.segment_status or "unknown" }}</dd>
              </div>
            </dl>

            <div class="cases-case-context">
              <span class="small">
                Last PACER run:
                {% if case.last_search_run_id %}
                  #{{ case.last_search_run_id }}
                {% else %}
                  —
                {% endif %}
                {% if case.last_search_run_at %}
                  · {{ case.last_search_run_at.isoformat() }}
                {% endif %}
              </span>
            </div>

            <footer class="cases-case-actions">
              <form method="post" action="{{ url_for('admin_pcl_case_queue_docket_enrichment', case_id=case.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="include_docket_text" value="1">
                <button class="secondary" type="submit">Pull docket</button>
              </form>
              <button class="pill cases-copy-number" type="button" data-case-number="{{ case.case_number_full or case.case_number }}">Copy number</button>
              <a class="primary" href="{{ url_for('admin_pcl_case_detail', case_id=case.id) }}">View case</a>
            </footer>
          </article>
        {% endfor %}
      </div>
      <div class="card pcl-empty-state cases-client-empty" id="cases-client-empty" hidden>
        <h3>No visible cases in this page view</h3>
        <p class="small">Adjust quick filter text or reset the page view controls.</p>
      </div>
    {% else %}
      <div class="card pcl-empty-state">
        <h3>No cases match those filters</h3>
        <p class="small">Try widening the date range or clearing one or more filters.</p>
      </div>
    {% endif %}
  </section>

  <nav class="pcl-pagination" aria-label="Indexed case pagination">
    <span class="small">Page {{ current_page }} of {{ total_pages }}</span>
    <div class="pcl-pagination__actions">
      <a class="pill {% if current_page <= 1 %}disabled{% endif %}" href="{{ page_url(1) if current_page > 1 else '#' }}" aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">First</a>
      <a class="pill {% if current_page <= 1 %}disabled{% endif %}" href="{{ page_url(current_page - 1) if current_page > 1 else '#' }}" aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">Previous</a>
      {% for page_number in range(window_start, window_end + 1) %}
        {% if page_number == current_page %}
          <span class="pill is-current" aria-current="page">{{ page_number }}</span>
        {% else %}
          <a class="pill" href="{{ page_url(page_number) }}">{{ page_number }}</a>
        {% endif %}
      {% endfor %}
      <a class="pill {% if current_page >= total_pages %}disabled{% endif %}" href="{{ page_url(current_page + 1) if current_page < total_pages else '#' }}" aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">Next</a>
      <a class="pill {% if current_page >= total_pages %}disabled{% endif %}" href="{{ page_url(total_pages) if current_page < total_pages else '#' }}" aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">Last</a>
    </div>
  </nav>
  <script>
    (function () {
      const filterForm = document.getElementById("cases-filter-form");
      const pageSizeForm = document.getElementById("cases-page-size-form");
      const pageSizeSelect = document.getElementById("cases-page-size");
      const quickFilterInput = document.getElementById("cases-quick-filter");
      const clientSortSelect = document.getElementById("cases-client-sort");
      const viewResetButton = document.getElementById("cases-view-reset");
      const visibleRange = document.getElementById("cases-visible-range");
      const casesGrid = document.getElementById("cases-grid");
      const caseCards = Array.from(document.querySelectorAll(".cases-case-card"));
      const clientEmptyState = document.getElementById("cases-client-empty");
      const searchInput = document.getElementById("pcl-search");
      const dateFromInput = document.getElementById("pcl-date-from");
      const dateToInput = document.getElementById("pcl-date-to");
      const selectAllCheckbox = document.getElementById("cases-select-all");
      const caseSelectionInputs = Array.from(document.querySelectorAll(".cases-select-item"));
      const bulkBar = document.getElementById("cases-bulk-bar");
      const bulkCount = document.getElementById("cases-selected-count");
      const bulkStatus = document.getElementById("cases-bulk-status");
      const bulkQueueButton = document.getElementById("cases-bulk-queue");
      const bulkClearButton = document.getElementById("cases-bulk-clear");
      const copyButtons = document.querySelectorAll(".cases-copy-number");
      const csrfToken = {{ csrf_token|tojson }};
      const submitFilterForm = () => {
        if (!filterForm) return;
        if (typeof filterForm.requestSubmit === "function") {
          filterForm.requestSubmit();
        } else {
          filterForm.submit();
        }
      };
      const submitForm = (form) => {
        if (!form) return;
        if (typeof form.requestSubmit === "function") {
          form.requestSubmit();
        } else {
          form.submit();
        }
      };
      const toDateString = (dateValue) => {
        const year = dateValue.getFullYear();
        const month = String(dateValue.getMonth() + 1).padStart(2, "0");
        const day = String(dateValue.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      };
      const textSort = new Intl.Collator(undefined, { numeric: true, sensitivity: "base" });
      const selectedCases = () => caseSelectionInputs.filter((input) => input.checked);
      const visibleSelectionInputs = () =>
        caseSelectionInputs.filter((input) => {
          const card = input.closest(".cases-case-card");
          return Boolean(card) && !card.hidden;
        });
      const parseDateValue = (card) => {
        const raw = card.dataset.dateFiled || "";
        const timestamp = Date.parse(raw);
        if (Number.isNaN(timestamp)) return 0;
        return timestamp;
      };
      const updateVisibleRange = (visibleCount) => {
        if (!visibleRange) return;
        const pageCount = Number.parseInt(visibleRange.dataset.pageCount || "0", 10) || 0;
        const total = Number.parseInt(visibleRange.dataset.total || "0", 10) || 0;
        if (visibleCount === pageCount) {
          const start = visibleRange.dataset.start || "0";
          const end = visibleRange.dataset.end || "0";
          visibleRange.textContent = `Showing ${start}-${end} of ${total}`;
        } else {
          visibleRange.textContent = `Showing ${visibleCount} visible on this page of ${total}`;
        }
      };
      const applyClientView = () => {
        if (!caseCards.length) return;
        const quickText = (quickFilterInput && quickFilterInput.value ? quickFilterInput.value : "")
          .trim()
          .toLowerCase();
        const sortKey = clientSortSelect ? clientSortSelect.value : "default";
        caseCards.forEach((card) => {
          const searchableText = [
            card.dataset.caseNumber || "",
            card.dataset.caseTitle || "",
            card.dataset.courtId || "",
            card.dataset.caseType || "",
            card.dataset.judge || "",
            card.dataset.enrichmentStatus || "",
            card.dataset.hasSentencing === "1" ? "sentencing yes" : "sentencing no",
          ]
            .join(" ")
            .toLowerCase();
          card.hidden = Boolean(quickText) && !searchableText.includes(quickText);
        });

        const visibleCards = caseCards.filter((card) => !card.hidden);
        const sortedCards = [...visibleCards].sort((leftCard, rightCard) => {
          if (sortKey === "date_filed_desc") return parseDateValue(rightCard) - parseDateValue(leftCard);
          if (sortKey === "date_filed_asc") return parseDateValue(leftCard) - parseDateValue(rightCard);
          if (sortKey === "court_asc") {
            return textSort.compare(leftCard.dataset.courtId || "", rightCard.dataset.courtId || "");
          }
          if (sortKey === "case_number_asc") {
            return textSort.compare(leftCard.dataset.caseNumber || "", rightCard.dataset.caseNumber || "");
          }
          const leftOrder = Number.parseInt(leftCard.dataset.order || "0", 10);
          const rightOrder = Number.parseInt(rightCard.dataset.order || "0", 10);
          return leftOrder - rightOrder;
        });

        if (casesGrid) {
          sortedCards.forEach((card) => {
            casesGrid.appendChild(card);
          });
        }
        if (clientEmptyState) {
          clientEmptyState.hidden = visibleCards.length > 0;
        }
        updateVisibleRange(visibleCards.length);
      };
      const updateSelectionState = () => {
        const selectedCount = selectedCases().length;
        const visibleInputs = visibleSelectionInputs();
        const visibleSelectedCount = visibleInputs.filter((input) => input.checked).length;
        if (bulkBar) {
          bulkBar.hidden = selectedCount === 0;
        }
        if (bulkCount) {
          bulkCount.textContent = `${selectedCount} selected`;
        }
        if (selectAllCheckbox) {
          if (!visibleInputs.length) {
            selectAllCheckbox.disabled = true;
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else if (visibleSelectedCount === visibleInputs.length) {
            selectAllCheckbox.disabled = false;
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.disabled = false;
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = visibleSelectedCount > 0;
          }
        }
      };
      const setBulkStatus = (message, variant = "") => {
        if (!bulkStatus) return;
        bulkStatus.textContent = message;
        if (variant) {
          bulkStatus.setAttribute("data-variant", variant);
        } else {
          bulkStatus.removeAttribute("data-variant");
        }
      };
      const fallbackCopy = (text) => {
        const helper = document.createElement("textarea");
        helper.value = text;
        helper.setAttribute("readonly", "");
        helper.style.position = "absolute";
        helper.style.left = "-9999px";
        document.body.appendChild(helper);
        helper.select();
        document.execCommand("copy");
        document.body.removeChild(helper);
      };

      const filters = document.querySelectorAll("[data-filter-input]");
      filters.forEach((input) => {
        const targetId = input.getAttribute("data-filter-input");
        const select = document.getElementById(targetId);
        if (!select) return;
        const placeholder = select.options.length ? {
          value: select.options[0].value,
          label: select.options[0].textContent || "",
        } : null;
        const options = Array.from(select.options).slice(1).map((opt) => ({
          value: String(opt.value),
          label: opt.textContent || "",
        }));

        input.addEventListener("input", () => {
          const query = input.value.trim().toLowerCase();
          const selectedValue = String(select.value || "");
          select.innerHTML = "";
          if (placeholder) {
            const placeholderOpt = document.createElement("option");
            placeholderOpt.value = placeholder.value;
            placeholderOpt.textContent = placeholder.label;
            placeholderOpt.selected = selectedValue === "";
            select.appendChild(placeholderOpt);
          }
          options.forEach((opt) => {
            const label = opt.label.toLowerCase();
            const value = String(opt.value).toLowerCase();
            if (!query || label.includes(query) || value.includes(query)) {
              const optionEl = document.createElement("option");
              optionEl.value = opt.value;
              optionEl.textContent = opt.label;
              optionEl.selected = String(opt.value) === selectedValue;
              select.appendChild(optionEl);
            }
          });
        });
      });

      if (pageSizeSelect && pageSizeForm) {
        pageSizeSelect.addEventListener("change", () => submitForm(pageSizeForm));
      }

      if (quickFilterInput) {
        quickFilterInput.addEventListener("input", () => {
          applyClientView();
          updateSelectionState();
        });
      }

      if (clientSortSelect) {
        clientSortSelect.addEventListener("change", () => {
          applyClientView();
          updateSelectionState();
        });
      }

      if (viewResetButton) {
        viewResetButton.addEventListener("click", () => {
          if (quickFilterInput) quickFilterInput.value = "";
          if (clientSortSelect) clientSortSelect.value = "default";
          applyClientView();
          updateSelectionState();
        });
      }

      const rangeButtons = document.querySelectorAll("[data-range-days], [data-range]");
      rangeButtons.forEach((button) => {
        button.addEventListener("click", () => {
          if (!filterForm || !dateFromInput || !dateToInput) return;
          const rangeType = button.getAttribute("data-range");
          const daysValue = button.getAttribute("data-range-days");
          const today = new Date();
          if (rangeType === "clear") {
            dateFromInput.value = "";
            dateToInput.value = "";
            submitFilterForm();
            return;
          }
          if (rangeType === "ytd") {
            const firstOfYear = new Date(today.getFullYear(), 0, 1);
            dateFromInput.value = toDateString(firstOfYear);
            dateToInput.value = toDateString(today);
            submitFilterForm();
            return;
          }
          if (daysValue) {
            const dayCount = Number.parseInt(daysValue, 10);
            if (!Number.isNaN(dayCount) && dayCount > 0) {
              const startDate = new Date(today);
              startDate.setDate(startDate.getDate() - dayCount);
              dateFromInput.value = toDateString(startDate);
              dateToInput.value = toDateString(today);
              submitFilterForm();
            }
          }
        });
      });

      copyButtons.forEach((button) => {
        const defaultLabel = button.textContent;
        button.addEventListener("click", async () => {
          const value = button.getAttribute("data-case-number") || "";
          if (!value) return;
          try {
            if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
              await navigator.clipboard.writeText(value);
            } else {
              fallbackCopy(value);
            }
            button.textContent = "Copied";
            window.setTimeout(() => {
              button.textContent = defaultLabel;
            }, 1200);
          } catch (error) {
            button.textContent = "Copy failed";
            window.setTimeout(() => {
              button.textContent = defaultLabel;
            }, 1200);
          }
        });
      });

      if (selectAllCheckbox && caseSelectionInputs.length) {
        selectAllCheckbox.addEventListener("change", () => {
          const checked = selectAllCheckbox.checked;
          visibleSelectionInputs().forEach((input) => {
            input.checked = checked;
          });
          updateSelectionState();
        });
      }

      caseSelectionInputs.forEach((input) => {
        input.addEventListener("change", updateSelectionState);
      });

      if (bulkClearButton) {
        bulkClearButton.addEventListener("click", () => {
          caseSelectionInputs.forEach((input) => {
            input.checked = false;
          });
          setBulkStatus("");
          updateSelectionState();
        });
      }

      if (bulkQueueButton) {
        bulkQueueButton.addEventListener("click", async () => {
          const selected = selectedCases();
          if (!selected.length) return;
          const isConfirmed = window.confirm(
            `Queue docket enrichment for ${selected.length} selected case${selected.length === 1 ? "" : "s"}?`
          );
          if (!isConfirmed) return;
          bulkQueueButton.disabled = true;
          if (bulkClearButton) {
            bulkClearButton.disabled = true;
          }
          setBulkStatus(`Queueing ${selected.length} case${selected.length === 1 ? "" : "s"}...`, "pending");
          let queuedCount = 0;
          let failedCount = 0;
          for (const input of selected) {
            const caseId = input.value;
            try {
              const response = await fetch(`/admin/pcl/cases/${encodeURIComponent(caseId)}/docket-enrichment/queue`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                  "X-Requested-With": "XMLHttpRequest",
                },
                body: new URLSearchParams({
                  csrf_token: csrfToken,
                  include_docket_text: "1",
                }).toString(),
                credentials: "same-origin",
              });
              if (response.ok) {
                queuedCount += 1;
                input.checked = false;
              } else {
                failedCount += 1;
              }
            } catch (error) {
              failedCount += 1;
            }
          }
          updateSelectionState();
          if (failedCount > 0) {
            setBulkStatus(`Queued ${queuedCount}. Failed ${failedCount}.`, "error");
          } else {
            setBulkStatus(`Queued ${queuedCount} case${queuedCount === 1 ? "" : "s"}.`, "success");
          }
          bulkQueueButton.disabled = false;
          if (bulkClearButton) {
            bulkClearButton.disabled = false;
          }
        });
      }

      document.addEventListener("keydown", (event) => {
        if (event.key !== "/" || event.metaKey || event.ctrlKey || event.altKey) return;
        const target = event.target;
        const tagName = target && target.tagName ? target.tagName.toUpperCase() : "";
        const isTypingField = tagName === "INPUT" || tagName === "TEXTAREA" || tagName === "SELECT";
        if (isTypingField || !searchInput) return;
        event.preventDefault();
        searchInput.focus();
        searchInput.select();
      });

      applyClientView();
      updateSelectionState();
    })();
  </script>
