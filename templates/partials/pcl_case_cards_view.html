  {% set active_filter_count = 0 %}
  {% if filters.search_text %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.court_id %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.case_type %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.date_filed_from %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.date_filed_to %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.judge_last_name %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.enriched_only %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.sentencing_only %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.field_name %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}
  {% if filters.field_value %}{% set active_filter_count = active_filter_count + 1 %}{% endif %}

  <section class="card casecards-shell">
    <div class="casecards-toolbar">
      <div>
        <p class="pacer-eyebrow">Cases</p>
        <h2>Case cards</h2>
        <p class="small">
          Saved PACER cases. Search by case number, party, or counsel, then open the case or pull the full docket.
        </p>
      </div>

      <div class="casecards-toolbar__right">
        <div class="casecards-switches">
          <div class="actions">
            <a class="primary" href="{{ url_for('admin_federal_data_dashboard_cases', source='pacer', view='cards') }}">PACER</a>
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases', source='imported') }}">Imported</a>
            <a class="pill" href="{{ url_for('admin_pcl_attorneys') }}">Attorneys</a>
          </div>
          <div class="actions">
            <span class="primary">Cards</span>
            <a
              class="pill"
              href="{{ url_for(
                'admin_federal_data_dashboard_cases',
                source='pacer',
                view='ops',
                q=filters.search_text,
                court_id=filters.court_id,
                case_type=filters.case_type,
                date_filed_from=(filters.date_filed_from.isoformat() if filters.date_filed_from else ''),
                date_filed_to=(filters.date_filed_to.isoformat() if filters.date_filed_to else ''),
                judge_last_name=filters.judge_last_name,
                enriched_only=('1' if filters.enriched_only else ''),
                sentencing_only=('1' if filters.sentencing_only else ''),
                field_name=filters.field_name,
                field_value=filters.field_value
              ) }}"
            >
              Operations
            </a>
          </div>
        </div>

        <div class="pcl-cases-summary">
          <strong>{{ pagination.total }}</strong>
          <span class="small">cases</span>
          <span class="small">{{ active_filter_count }} filter(s)</span>
        </div>
      </div>
    </div>

    <form method="get" class="pcl-filter-form casecards-filter-form" aria-label="Search case cards">
      <div class="grid three">
        <div class="casecards-filter-field casecards-filter-field--wide">
          <label for="case-cards-search">Search</label>
          <input
            id="case-cards-search"
            name="q"
            value="{{ filters.search_text }}"
            placeholder="Case number, title, party, counsel"
          >
        </div>

        <div class="casecards-filter-field">
          <label for="case-cards-court">Court</label>
          <input
            id="case-cards-court"
            name="court_id"
            list="case-cards-court-list"
            value="{{ filters.court_id }}"
            placeholder="e.g., paedc"
          >
          <datalist id="case-cards-court-list">
            {% for court in court_choices %}
              <option value="{{ court.court_id }}">{{ court.label }}</option>
            {% endfor %}
          </datalist>
        </div>

        <div class="casecards-filter-field">
          <label for="case-cards-type">Case type</label>
          <select id="case-cards-type" name="case_type">
            <option value="">All case types</option>
            {% for case_type, label in case_type_choices %}
              <option value="{{ case_type }}" {% if filters.case_type == case_type %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <details class="pcl-advanced-filters">
        <summary class="pcl-detail-summary">More filters</summary>

        <div class="grid three mt-12">
          <div class="casecards-filter-field">
            <label for="case-cards-date-from">Date filed from</label>
            <input id="case-cards-date-from" type="date" name="date_filed_from" value="{{ filters.date_filed_from.isoformat() if filters.date_filed_from else '' }}">
          </div>
          <div class="casecards-filter-field">
            <label for="case-cards-date-to">Date filed to</label>
            <input id="case-cards-date-to" type="date" name="date_filed_to" value="{{ filters.date_filed_to.isoformat() if filters.date_filed_to else '' }}">
          </div>
          <div class="casecards-filter-field">
            <label for="case-cards-judge">Judge last name</label>
            <input id="case-cards-judge" name="judge_last_name" value="{{ filters.judge_last_name }}" placeholder="e.g., McHugh">
          </div>
        </div>

        <fieldset class="pcl-flag-fieldset mt-12">
          <legend>Status</legend>
          <label class="pcl-flag-option">
            <input type="checkbox" name="enriched_only" value="1" {% if filters.enriched_only %}checked{% endif %}>
            <span>Has docket data</span>
          </label>
          <label class="pcl-flag-option">
            <input type="checkbox" name="sentencing_only" value="1" {% if filters.sentencing_only %}checked{% endif %}>
            <span>Sentencing only</span>
          </label>
        </fieldset>

        <div class="grid two mt-12">
          <div class="casecards-filter-field">
            <label for="case-cards-field-name">Field name</label>
            <input id="case-cards-field-name" name="field_name" list="case-cards-field-name-list" value="{{ filters.field_name }}" placeholder="e.g., caseId">
            <datalist id="case-cards-field-name-list">
              {% for field_name in case_field_choices %}
                <option value="{{ field_name }}"></option>
              {% endfor %}
            </datalist>
            <p class="small">Search any saved PACER field for the case.</p>
          </div>
          <div class="casecards-filter-field">
            <label for="case-cards-field-value">Field value contains</label>
            <input id="case-cards-field-value" name="field_value" value="{{ filters.field_value }}" placeholder="e.g., 2026 or paedc">
          </div>
        </div>
      </details>

      <div class="actions pcl-filter-actions casecards-filter-actions">
        <button class="primary" type="submit">Search</button>
        <a class="pill" href="{{ url_for('admin_federal_data_dashboard_cases', source='pacer', view='cards') }}">Reset</a>
        <span class="small">Showing {{ cases|length }} on this page</span>
      </div>
    </form>

    <details class="casecards-maintenance">
      <summary class="pcl-detail-summary">Maintenance</summary>
      <p class="small mt-8">
        If a docket was pulled before the latest card layout, you can rebuild card metadata from saved dockets (no PACER cost).
      </p>
      <form method="post" action="{{ url_for('admin_federal_data_dashboard_cases_update_card_metadata') }}" class="inline-form mt-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="next" value="{{ request.full_path }}">
        <label>
          Max cases
          <input type="number" name="limit" min="1" max="5000" value="500">
        </label>
        <button class="primary" type="submit">Update existing cards</button>
      </form>
    </details>
  </section>

  {% set fragment_url = url_for(
    'admin_federal_data_dashboard_cases_cards_fragment',
    q=filters.search_text,
    court_id=filters.court_id,
    case_type=filters.case_type,
    date_filed_from=(filters.date_filed_from.isoformat() if filters.date_filed_from else ''),
    date_filed_to=(filters.date_filed_to.isoformat() if filters.date_filed_to else ''),
    judge_last_name=filters.judge_last_name,
    enriched_only=('1' if filters.enriched_only else ''),
    sentencing_only=('1' if filters.sentencing_only else ''),
    field_name=filters.field_name,
    field_value=filters.field_value,
    page_size=pagination.page_size
  ) %}

  <section
    class="pcl-card-grid"
    id="case-cards-grid"
    aria-live="polite"
    data-fragment-url="{{ fragment_url }}"
    data-page="{{ pagination.page }}"
    data-total-pages="{{ pagination.total_pages }}"
  >
    {% include "partials/pcl_case_cards_grid.html" %}
  </section>

  <div class="casecards-infinite-status small" id="casecards-infinite-status" hidden></div>
  <div class="casecards-sentinel" id="casecards-sentinel" aria-hidden="true"></div>

  <nav class="pcl-pagination casecards-pagination" aria-label="Case card pagination">
    {% set total_pages = pagination.total_pages %}
    {% set current_page = pagination.page %}
    <span class="small">Page {{ current_page }} of {{ total_pages }}</span>
    <div class="pcl-pagination__actions">
      <a class="pill {% if current_page <= 1 %}disabled{% endif %}" href="{{ page_url(current_page - 1) if current_page > 1 else '#' }}" aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">Previous</a>
      <a class="pill {% if current_page >= total_pages %}disabled{% endif %}" href="{{ page_url(current_page + 1) if current_page < total_pages else '#' }}" aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">Next</a>
    </div>
  </nav>

  <script>
    (() => {
      const grid = document.getElementById("case-cards-grid");
      const sentinel = document.getElementById("casecards-sentinel");
      const statusEl = document.getElementById("casecards-infinite-status");
      if (!grid || !sentinel) return;

      document.documentElement.classList.add("js-enabled");

      const fragmentUrl = grid.dataset.fragmentUrl;
      let nextPage = (parseInt(grid.dataset.page || "1", 10) || 1) + 1;
      const totalPages = parseInt(grid.dataset.totalPages || "1", 10) || 1;
      let isLoading = false;

      const setStatus = (text, visible) => {
        if (!statusEl) return;
        statusEl.textContent = text || "";
        statusEl.hidden = !visible;
      };

      const appendCardsFromHtml = (html) => {
        if (!html) return;
        const wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        Array.from(wrapper.children).forEach((child) => {
          grid.appendChild(child);
        });
      };

      const loadNextPage = async () => {
        if (isLoading) return;
        if (!fragmentUrl) return;
        if (nextPage > totalPages) return;
        isLoading = true;
        setStatus("Loading more cases…", true);
        try {
          const url = new URL(fragmentUrl, window.location.origin);
          url.searchParams.set("page", String(nextPage));
          const response = await fetch(url.toString(), {
            credentials: "same-origin",
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          appendCardsFromHtml(payload.html);
          if (payload.next_page) {
            nextPage = payload.next_page;
          } else {
            nextPage = totalPages + 1;
            setStatus("All results loaded.", true);
            sentinel.remove();
            window.setTimeout(() => setStatus("", false), 1500);
          }
        } catch (error) {
          setStatus("Could not load more cases. Scroll to retry.", true);
          window.setTimeout(() => setStatus("", false), 2500);
        } finally {
          isLoading = false;
        }
      };

      if ("IntersectionObserver" in window) {
        const observer = new IntersectionObserver(
          (entries) => {
            if (entries.some((entry) => entry.isIntersecting)) {
              loadNextPage();
            }
          },
          { rootMargin: "600px 0px" }
        );
        observer.observe(sentinel);
      }

      document.addEventListener("toggle", async (event) => {
        const details = event.target;
        if (!(details instanceof HTMLDetailsElement)) return;
        if (!details.matches(".case-docket-details")) return;
        if (!details.open) return;
        const body = details.querySelector(".case-docket-details__body");
        if (!body) return;
        if (body.dataset.loaded === "1") return;
        const caseId = details.dataset.caseId;
        if (!caseId) return;
        body.dataset.loaded = "1";
        body.setAttribute("aria-busy", "true");
        body.innerHTML = "<p class=\"small\">Loading docket…</p>";
        try {
          const response = await fetch(`/admin/pcl/cases/${encodeURIComponent(caseId)}/docket-entries-fragment?limit=60`, {
            credentials: "same-origin",
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const html = await response.text();
          body.innerHTML = html;
        } catch (error) {
          body.dataset.loaded = "0";
          body.innerHTML = "<p class=\"small\">Could not load docket entries.</p>";
        } finally {
          body.setAttribute("aria-busy", "false");
        }
      });
    })();
  </script>
