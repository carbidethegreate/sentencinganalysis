  <div class="card">
    <div class="case-data-one-header">
      <div>
        <h3>Imported cases (legacy)</h3>
        <p class="small">Browse uploaded case records in a card view.</p>
        <div id="case-data-one-import-status" class="small" style="margin-top: 8px;"></div>
      </div>
      <form id="case-data-one-search" class="case-data-one-search">
        <div class="case-data-one-search__row">
          <input
            type="search"
            name="search"
            id="case-data-one-search-input"
            placeholder="Search case number, short title, party, or judge names..."
            aria-label="Search imported cases"
          />
          <button type="submit">Search</button>
        </div>
        <div class="case-data-one-search__filters">
          <label>
            <span class="small">Case Type</span>
            <select id="case-data-one-filter-type" name="case_type">
              <option value="">All</option>
              <option value="ap">Appellate (ap)</option>
              <option value="bk">Bankruptcy (bk)</option>
              <option value="cr">Criminal (cr)</option>
              <option value="cv">Civil (cv)</option>
              <option value="mdl">MDL (mdl)</option>
              <option value="mj">Magistrate (mj)</option>
              <option value="po">Petty Offense (po)</option>
            </select>
          </label>
          <label>
            <span class="small">Party Role</span>
            <input type="text" id="case-data-one-filter-role" name="party_role" placeholder="e.g., plt" />
          </label>
          <label>
            <span class="small">Party Type</span>
            <input type="text" id="case-data-one-filter-party-type" name="party_type" placeholder="e.g., debtor" />
          </label>
          <label>
            <span class="small">Case Year</span>
            <input type="text" id="case-data-one-filter-year" name="case_year" placeholder="YYYY" />
          </label>
        </div>
      </form>
    </div>

    <div id="case-data-one-results" class="case-data-one-results"></div>
    <div class="case-data-one-pagination">
      <button type="button" id="case-data-one-prev" class="secondary">Previous</button>
      <span id="case-data-one-page" class="small"></span>
      <button type="button" id="case-data-one-next" class="secondary">Next</button>
    </div>
  </div>

  <style>
    .case-data-one-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .case-data-one-search {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: #f7f7f7;
    }

    .case-data-one-search__row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .case-data-one-search__row input {
      border: none;
      background: transparent;
      min-width: 280px;
      font-size: 1rem;
    }

    .case-data-one-search__row input:focus {
      outline: none;
    }

    .case-data-one-search button {
      border: none;
      background: #1f6feb;
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }

    .case-data-one-search__filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .case-data-one-search__filters label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.9rem;
      color: #333;
    }

    .case-data-one-search__filters input,
    .case-data-one-search__filters select {
      border: 1px solid #d0d7de;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.9rem;
      background: #fff;
    }

    .case-data-one-results {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .case-card {
      border: 1px solid #e1e4ea;
      border-radius: 12px;
      padding: 16px;
      background: #fafbff;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 6px 18px rgba(31, 111, 235, 0.08);
    }

    .case-card__title {
      font-weight: 700;
      font-size: 1.1rem;
      margin: 0;
    }

    .case-card__subtitle {
      color: #5a6472;
      margin: 0;
      font-size: 0.95rem;
    }

    .case-card__meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .case-card__section {
      background: #fff;
      border: 1px solid #e4e8f0;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .case-card__section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      font-weight: 600;
      margin: 0;
    }

    .case-card__field {
      display: grid;
      grid-template-columns: minmax(120px, 1fr) 1.4fr;
      gap: 8px;
      align-items: baseline;
    }

    .case-card__label {
      color: #1f2937;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .case-card__value {
      color: #374151;
      font-size: 0.9rem;
    }

    .case-data-one-pagination {
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .case-data-one-pagination button.secondary {
      border: 1px solid #d0d7de;
      background: #fff;
      color: #333;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const resultsEl = document.getElementById('case-data-one-results');
      const pageEl = document.getElementById('case-data-one-page');
      const prevButton = document.getElementById('case-data-one-prev');
      const nextButton = document.getElementById('case-data-one-next');
      const searchForm = document.getElementById('case-data-one-search');
      const searchInput = document.getElementById('case-data-one-search-input');
      const caseTypeInput = document.getElementById('case-data-one-filter-type');
      const partyRoleInput = document.getElementById('case-data-one-filter-role');
      const partyTypeInput = document.getElementById('case-data-one-filter-party-type');
      const caseYearInput = document.getElementById('case-data-one-filter-year');
      const statusEl = document.getElementById('case-data-one-import-status');
      const statusUrl = '{{ url_for("admin_case_data_one_import_status") }}';
      const dataUrl = '{{ url_for("admin_case_data_one_data") }}';

      const state = {
        page: 1,
        perPage: 12,
        search: '',
        caseType: '',
        partyRole: '',
        partyType: '',
        caseYear: '',
        totalPages: 1
      };

      const formatValue = (value) => {
        if (value === null || value === undefined || value === '') {
          return '—';
        }
        return value;
      };

      const caseTypeMap = {
        ap: 'Appellate',
        bk: 'Bankruptcy',
        cr: 'Criminal',
        cv: 'Civil',
        mdl: 'Judicial Panel Multidistrict Litigation (JPML)',
        mj: 'Magistrate',
        po: 'Petty Offense'
      };

      const formatCaseTypeValue = (value) => {
        const formatted = formatValue(value);
        if (formatted === '—') {
          return formatted;
        }
        const trimmed = String(formatted).trim();
        const mapped = caseTypeMap[trimmed.toLowerCase()];
        if (!mapped) {
          return formatted;
        }
        return `${trimmed} (${mapped})`;
      };

      const buildFieldRow = (label, value) => {
        const row = document.createElement('div');
        row.className = 'case-card__field';

        const labelEl = document.createElement('div');
        labelEl.className = 'case-card__label';
        labelEl.textContent = label;

        const valueEl = document.createElement('div');
        valueEl.className = 'case-card__value';
        valueEl.textContent = value;

        row.appendChild(labelEl);
        row.appendChild(valueEl);
        return row;
      };

      const buildSection = (title, fields) => {
        const section = document.createElement('div');
        section.className = 'case-card__section';

        const heading = document.createElement('p');
        heading.className = 'case-card__section-title';
        heading.textContent = title;
        section.appendChild(heading);

        fields.forEach((field) => {
          section.appendChild(buildFieldRow(field.label, field.value));
        });

        return section;
      };

      const renderCards = (records) => {
        resultsEl.innerHTML = '';
        if (!records.length) {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = 'No case records found.';
          resultsEl.appendChild(empty);
          return;
        }

        records.forEach((record) => {
          const card = document.createElement('div');
          card.className = 'case-card';

          const title = document.createElement('h3');
          title.className = 'case-card__title';
          title.textContent = formatValue(record.cs_case_number);

          const subtitle = document.createElement('p');
          subtitle.className = 'case-card__subtitle';
          subtitle.textContent = formatValue(record.cs_short_title);

          const meta = document.createElement('div');
          meta.className = 'case-card__meta';

          const sections = [
            {
              title: 'Case identifiers',
              fields: [
                { label: 'Case Type', value: formatCaseTypeValue(record.cs_type) },
                { label: 'Case Type (normalized)', value: formatCaseTypeValue(record.cs_type_normalized) },
                { label: 'Case Type Code', value: formatCaseTypeValue(record.cs_case_type_code) },
                { label: 'Case Year', value: formatValue(record.cs_case_year) },
                { label: 'Case Number Seq', value: formatValue(record.cs_case_number_seq) },
                { label: 'Office', value: formatValue(record.cs_case_office) },
                { label: 'Term Digit', value: formatValue(record.cs_term_digit) }
              ]
            },
            {
              title: 'Dates',
              fields: [
                { label: 'Filed', value: formatValue(record.cs_date_filed) },
                { label: 'Terminated', value: formatValue(record.cs_date_term) }
              ]
            },
            {
              title: 'Parties',
              fields: [
                { label: 'Party', value: formatValue(record.party) },
                { label: 'Party Type', value: formatValue(record.party_type) },
                { label: 'Party Role', value: formatValue(record.party_role) },
                { label: 'Party Def #', value: formatValue(record.party_def_num) }
              ]
            },
            {
              title: 'Judges',
              fields: [
                { label: 'Presiding Judge', value: formatValue(record.pre_judge_name) },
                { label: 'Referred Judge', value: formatValue(record.ref_judge_name) }
              ]
            }
          ];

          sections.forEach((section) => {
            meta.appendChild(buildSection(section.title, section.fields));
          });

          card.appendChild(title);
          card.appendChild(subtitle);
          card.appendChild(meta);
          resultsEl.appendChild(card);
        });
      };

      const renderPagination = () => {
        pageEl.textContent = `Page ${state.page} of ${state.totalPages}`;
        prevButton.disabled = state.page <= 1;
        nextButton.disabled = state.page >= state.totalPages;
      };

      const fetchData = () => {
        const url = new URL(dataUrl, window.location.origin);
        url.searchParams.set('page', state.page);
        url.searchParams.set('per_page', state.perPage);
        if (state.search) {
          url.searchParams.set('search', state.search);
        }
        if (state.caseType) {
          url.searchParams.set('case_type', state.caseType);
        }
        if (state.partyRole) {
          url.searchParams.set('party_role', state.partyRole);
        }
        if (state.partyType) {
          url.searchParams.set('party_type', state.partyType);
        }
        if (state.caseYear) {
          url.searchParams.set('case_year', state.caseYear);
        }

        fetch(url, { credentials: 'same-origin' })
          .then((response) => response.json())
          .then((payload) => {
            renderCards(payload.data || []);
            state.totalPages = payload.totalPages || 1;
            renderPagination();
          })
          .catch(() => {
            resultsEl.innerHTML = '<div class="small">Unable to load case records.</div>';
          });
      };

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        state.search = searchInput.value.trim();
        state.caseType = caseTypeInput.value.trim().toLowerCase();
        state.partyRole = partyRoleInput.value.trim().toLowerCase();
        state.partyType = partyTypeInput.value.trim().toLowerCase();
        state.caseYear = caseYearInput.value.trim();
        state.page = 1;
        fetchData();
      });

      prevButton.addEventListener('click', () => {
        if (state.page > 1) {
          state.page -= 1;
          fetchData();
        }
      });

      nextButton.addEventListener('click', () => {
        if (state.page < state.totalPages) {
          state.page += 1;
          fetchData();
        }
      });

      function renderStatus(payload) {
        if (!statusEl) {
          return;
        }
        if (!payload || payload.status === 'idle') {
          statusEl.textContent = '';
          return;
        }
        if (payload.status === 'processing') {
          statusEl.textContent = 'Import status: processing...';
          return;
        }
        if (payload.status === 'completed') {
          statusEl.textContent = payload.message || 'Import completed.';
          return;
        }
        if (payload.status === 'failed') {
          statusEl.textContent = payload.message || 'Import failed.';
          return;
        }
        statusEl.textContent = 'Import status: ' + payload.status;
      }

      function pollStatus() {
        fetch(statusUrl, { credentials: 'same-origin' })
          .then((response) => response.json())
          .then((payload) => {
            renderStatus(payload);
            if (payload && payload.status === 'processing') {
              setTimeout(pollStatus, 3000);
            }
          })
          .catch(() => {});
      }

      pollStatus();
      fetchData();
    });
  </script>
