{% extends "admin_federal_data_base.html" %}

{% block title %}Admin | Docket Enrichment{% endblock %}

{% block federal_content %}
  <section class="card">
    <div class="page-header page-header--tight">
      <h2>Docket enrichment queue</h2>
      <p class="small">Queue docket text pulls for saved cases. Use filters to target the exact set of cases.</p>
    </div>

    <div class="grid two mb-16">
      <article class="pcl-detail-card">
        <h3>Status counts</h3>
        <dl class="pcl-detail-list">
          {% for status in ["queued", "running", "completed", "failed"] %}
            <div>
              <dt>{{ status|capitalize }}</dt>
              <dd>{{ status_counts.get(status, 0) }}</dd>
            </div>
          {% endfor %}
        </dl>
      </article>

      <article class="pcl-detail-card">
        <h3>Run worker</h3>
        <p class="small pacer-token-status">
          <span class="status-dot {% if service_token.connected %}status-dot--connected{% else %}status-dot--offline{% endif %}" aria-hidden="true"></span>
          Token {{ "connected" if service_token.connected else "not connected" }} ({{ service_token.environment_label }})
        </p>
        <p class="small">Runs one worker cycle on queued jobs.</p>
        <form method="post" action="{{ url_for('admin_docket_enrichment_run') }}" class="inline-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <label>
            Max jobs
            <input type="number" name="max_jobs" min="1" max="50" value="5">
          </label>
          <button class="primary" type="submit">Run worker</button>
        </form>
      </article>

      <article class="pcl-detail-card">
        {% set k_with_text = kearney_estimate_with_text %}
        {% set k_without_text = kearney_estimate_without_text %}
        <h3>Mark A. Kearney backfill</h3>
        <p class="small">Queue all EDPA criminal cases for Judge Kearney (2010-01-01 to today).</p>
        <p class="small">
          {{ kearney_candidate_count }} matching cases.
          {% if k_with_text and k_with_text.avg_fee is not none %}
            Est. with text per case: ${{ '%.2f'|format(k_with_text.avg_fee) }}.
            Est. total: ${{ '%.2f'|format(k_with_text.estimated_total_fee) }}.
          {% else %}
            With-text estimate: unknown.
          {% endif %}
          {% if k_without_text and k_without_text.avg_fee is not none %}
            Without-text: ${{ '%.2f'|format(k_without_text.avg_fee) }}.
          {% else %}
            Without-text estimate: unknown.
          {% endif %}
          History source: {{ k_with_text.fallback }}.
        </p>

        <form method="post" action="{{ url_for('admin_docket_enrichment_queue_kearney') }}" class="stack">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <label>
            Max cases
            <input type="number" name="max_cases" min="1" max="5000" value="500">
          </label>
          <label>
            <input type="checkbox" name="include_docket_text" value="1" checked>
            Include docket text
          </label>
          <label>
            <input type="checkbox" name="queue_documents" value="1">
            Queue docket document downloads
          </label>
          <label>
            Document keywords (optional)
            <input type="text" name="document_keywords" placeholder="5K1.1, cooperation, downward departure">
          </label>
          <button class="primary" type="submit">Queue Mark A. Kearney cases</button>
        </form>
      </article>
    </div>

    <article class="card">
      <h3>Batch queue docket text</h3>
      <p class="small">Filter cases, then queue docket text pulls in bulk.</p>

      <form method="get" action="{{ url_for('admin_docket_enrichment_dashboard') }}" class="pcl-filter-form">
        <div class="grid two">
          <div>
            <label for="docket-court">Court</label>
            <input id="docket-court" name="court_id" list="docket-court-options" value="{{ docket_filters.court_id }}" placeholder="Start typing a court ID">
            <datalist id="docket-court-options">
              {% for court_id in filter_choices.courts %}
                <option value="{{ court_id }}">{{ court_id }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div>
            <label for="docket-case-type">Case type</label>
            <input id="docket-case-type" name="case_type" list="docket-case-type-options" value="{{ docket_filters.case_type }}" placeholder="Start typing a case type">
            <datalist id="docket-case-type-options">
              {% for case_type in filter_choices.case_types %}
                <option value="{{ case_type }}">{{ case_type }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div>
            <label for="docket-judge">Judge</label>
            <input id="docket-judge" name="judge_last_name" list="docket-judge-options" value="{{ docket_filters.judge_last_name }}" placeholder="Judge last name">
            <datalist id="docket-judge-options">
              {% for judge in filter_choices.judges %}
                <option value="{{ judge }}">{{ judge }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div>
            <label for="docket-date-from">Date filed from</label>
            <input id="docket-date-from" type="date" name="date_filed_from" value="{{ docket_filters.date_filed_from.isoformat() if docket_filters.date_filed_from else '' }}">
          </div>
          <div>
            <label for="docket-date-to">Date filed to</label>
            <input id="docket-date-to" type="date" name="date_filed_to" value="{{ docket_filters.date_filed_to.isoformat() if docket_filters.date_filed_to else '' }}">
          </div>
          <div>
            <label for="docket-search">Search case</label>
            <input id="docket-search" name="q" value="{{ docket_filters.search_text }}" placeholder="Case number or title">
          </div>
          <div>
            <label for="docket-status">Docket job status</label>
            <select id="docket-status" name="docket_status">
              <option value="any" {% if docket_filters.docket_status == 'any' %}selected{% endif %}>Any</option>
              <option value="queued" {% if docket_filters.docket_status == 'queued' %}selected{% endif %}>Queued</option>
              <option value="running" {% if docket_filters.docket_status == 'running' %}selected{% endif %}>Running</option>
              <option value="completed" {% if docket_filters.docket_status == 'completed' %}selected{% endif %}>Completed</option>
              <option value="failed" {% if docket_filters.docket_status == 'failed' %}selected{% endif %}>Failed</option>
            </select>
          </div>
          <div>
            <label for="docket-text">Docket text</label>
            <select id="docket-text" name="docket_text">
              <option value="any" {% if docket_filters.docket_text == 'any' %}selected{% endif %}>Any</option>
              <option value="has_text" {% if docket_filters.docket_text == 'has_text' %}selected{% endif %}>Has docket text</option>
              <option value="no_text" {% if docket_filters.docket_text == 'no_text' %}selected{% endif %}>No docket text</option>
            </select>
          </div>
          <div>
            <label for="docket-sort">Sort by</label>
            <select id="docket-sort" name="sort">
              <option value="date_filed_desc" {% if docket_filters.sort == 'date_filed_desc' %}selected{% endif %}>Date filed (newest)</option>
              <option value="date_filed_asc" {% if docket_filters.sort == 'date_filed_asc' %}selected{% endif %}>Date filed (oldest)</option>
              <option value="docket_updated_desc" {% if docket_filters.sort == 'docket_updated_desc' %}selected{% endif %}>Docket updated (newest)</option>
              <option value="docket_updated_asc" {% if docket_filters.sort == 'docket_updated_asc' %}selected{% endif %}>Docket updated (oldest)</option>
            </select>
          </div>
        </div>

        <div class="actions pcl-filter-actions">
          <button class="primary" type="submit">Apply filters</button>
          <a class="pill" href="{{ url_for('admin_docket_enrichment_dashboard') }}">Reset</a>
        </div>
      </form>

      <form method="post" action="{{ url_for('admin_docket_enrichment_queue_batch') }}" class="actions mt-12">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="court_id" value="{{ docket_filters.court_id }}">
        <input type="hidden" name="case_type" value="{{ docket_filters.case_type }}">
        <input type="hidden" name="judge_last_name" value="{{ docket_filters.judge_last_name }}">
        <input type="hidden" name="date_filed_from" value="{{ docket_filters.date_filed_from.isoformat() if docket_filters.date_filed_from else '' }}">
        <input type="hidden" name="date_filed_to" value="{{ docket_filters.date_filed_to.isoformat() if docket_filters.date_filed_to else '' }}">
        <input type="hidden" name="q" value="{{ docket_filters.search_text }}">
        <input type="hidden" name="docket_status" value="{{ docket_filters.docket_status }}">
        <input type="hidden" name="docket_text" value="{{ docket_filters.docket_text }}">
        <input type="hidden" name="sort" value="{{ docket_filters.sort }}">
        <label>
          Max cases
          <input type="number" name="max_cases" min="1" max="500" value="50">
        </label>
        <label>
          <input type="checkbox" name="include_docket_text" value="1" checked>
          Include docket text
        </label>
        <button class="primary" type="submit">Queue batch</button>
      </form>

      {% if case_candidates %}
        <div class="table-wrap mt-16">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Case</th>
                <th>Court</th>
                <th>Type</th>
                <th>Date filed</th>
                <th>Last job status</th>
                <th>Docket text</th>
                <th>Last update</th>
              </tr>
            </thead>
            <tbody>
              {% for case in case_candidates %}
                <tr>
                  <td>
                    <a class="pacer-text-link" href="{{ url_for('admin_pcl_case_detail', case_id=case.id) }}">
                      {{ case.case_number_full or case.case_number }}
                    </a>
                    <div class="small">{{ case.short_title or case.case_title or "Untitled case" }}</div>
                  </td>
                  <td>{{ case.court_id }}</td>
                  <td>{{ case.case_type or "—" }}</td>
                  <td>{{ case.date_filed.isoformat() if case.date_filed else "—" }}</td>
                  <td>{{ case.last_job_status or "—" }}</td>
                  <td>
                    {% if case.last_job_status == 'completed' and case.last_job_include_text %}
                      yes
                    {% else %}
                      no
                    {% endif %}
                  </td>
                  <td>{{ case.last_job_updated_at.isoformat() if case.last_job_updated_at else "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% set total_pages = (candidate_total // candidate_page_size) + (1 if candidate_total % candidate_page_size else 0) %}
        <nav class="pcl-pagination" aria-label="Docket candidate pagination">
          <span class="small">Page {{ candidate_page }} of {{ total_pages if total_pages > 0 else 1 }}</span>
          <div class="pcl-pagination__actions">
            <a class="pill {% if candidate_page <= 1 %}disabled{% endif %}" href="{{ candidate_page_url(candidate_page - 1) if candidate_page > 1 else '#' }}" aria-disabled="{{ 'true' if candidate_page <= 1 else 'false' }}">Previous</a>
            <a class="pill {% if candidate_page >= total_pages %}disabled{% endif %}" href="{{ candidate_page_url(candidate_page + 1) if candidate_page < total_pages else '#' }}" aria-disabled="{{ 'true' if candidate_page >= total_pages else 'false' }}">Next</a>
          </div>
        </nav>
      {% else %}
        <p class="small">No cases match those filters.</p>
      {% endif %}
    </article>

    <article class="card mt-16">
      <h3>Recent docket jobs</h3>
      {% if jobs %}
        <div class="table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Case</th>
                <th>Court</th>
                <th>Type</th>
                <th>Status</th>
                <th>Include text</th>
                <th>Attempts</th>
                <th>Receipts</th>
                <th>Total fee</th>
                <th>Total pages</th>
                <th>Last receipt</th>
                <th>Last error</th>
                <th>Queued</th>
              </tr>
            </thead>
            <tbody>
              {% for job in jobs %}
                <tr>
                  <td class="pcl-mono">{{ job.id }}</td>
                  <td>
                    <a class="pacer-text-link" href="{{ url_for('admin_pcl_case_detail', case_id=job.case_id) }}">
                      {{ job.case_number_full or job.case_number }}
                    </a>
                    <div class="small">{{ job.short_title or job.case_title or "Untitled case" }}</div>
                  </td>
                  <td>{{ job.court_id }}</td>
                  <td>{{ job.case_type or "—" }}</td>
                  <td>{{ job.status }}</td>
                  <td>{{ "yes" if job.include_docket_text else "no" }}</td>
                  <td>{{ job.attempts }}</td>
                  <td>{{ job.receipt_count }}</td>
                  <td>
                    {% if job.total_fee is not none %}
                      ${{ '%.2f'|format(job.total_fee) }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ job.total_billable_pages if job.total_billable_pages is not none else "—" }}</td>
                  <td>{{ job.last_receipt_at.isoformat() if job.last_receipt_at else "—" }}</td>
                  <td>{{ job.last_error or "—" }}</td>
                  <td>{{ job.created_at.isoformat() if job.created_at else "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="small">No docket enrichment jobs queued yet.</p>
      {% endif %}
    </article>
  </section>
{% endblock %}
