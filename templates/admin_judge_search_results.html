{% extends "admin_federal_data_base.html" %}

{% block title %}Judge Search Results{% endblock %}

{% block federal_content %}
  {% set segments_in_flight = segment_statuses.get('submitted', 0) + segment_statuses.get('running', 0) + segment_statuses.get('processing', 0) %}
  {% set segment_percent = 0 %}
  {% if segment_total > 0 %}
    {% set segment_percent = (segment_complete * 100) // segment_total %}
  {% endif %}

  <section class="card stack">
    <div class="page-header page-header--tight">
      <h2>Judge Search</h2>
      <p class="small">
        Run #{{ batch_request_id }}
        · {{ batch_request.date_filed_from }} to {{ batch_request.date_filed_to }}
        · court {{ batch_request.court_id|upper }}
        {% if batch_case_types %}· types {{ batch_case_types|join(', ')|upper }}{% endif %}
        {% if has_judge_filter %}
          · Judge filter: {{ judge_last_name }}{% if judge_initials %} ({{ judge_initials }}){% endif %}
        {% endif %}
      </p>
    </div>

    <div class="wizard" data-wizard>
      <div class="wizard-progress" aria-label="Judge search steps">
        <div class="wizard-progress__step {% if active_step == 1 %}is-current{% elif is_complete %}is-complete{% endif %}">
          <span class="wizard-progress__num">1</span>
          <span class="wizard-progress__label">Collect cases</span>
        </div>
        <div class="wizard-progress__step {% if active_step == 2 %}is-current{% elif active_step > 2 %}is-complete{% endif %}">
          <span class="wizard-progress__num">2</span>
          <span class="wizard-progress__label">Review</span>
        </div>
        <div class="wizard-progress__step {% if active_step == 3 %}is-current{% elif active_step > 3 %}is-complete{% endif %}">
          <span class="wizard-progress__num">3</span>
          <span class="wizard-progress__label">Queue dockets</span>
        </div>
        <div class="wizard-progress__step {% if active_step == 4 %}is-current{% endif %}">
          <span class="wizard-progress__num">4</span>
          <span class="wizard-progress__label">View results</span>
        </div>
      </div>

      {% if active_step == 1 %}
        <section class="wizard-step stack">
          <h3>Step 1: Collect cases</h3>
          <p class="small">
            This date range is split into {{ segment_total }} monthly segment(s).
            {% if not is_complete %}This page auto-refreshes every 12 seconds while the search is running.{% endif %}
          </p>

          {% if tick_error %}
            <div class="flash error">
              <strong>Worker tick error.</strong>
              <div class="small mt-8">{{ tick_error }}</div>
              <div class="small mt-8">
                Next step: open <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_logs') }}">Logs</a> and search for “Judge search tick failed”.
              </div>
            </div>
          {% endif %}

          {% if not is_complete and segment_statuses.get('queued', 0) and segments_in_flight == 0 and segment_complete == 0 %}
            <div class="flash">
              <strong>Waiting to start.</strong>
              {% if global_slot_status and (global_slot_status['in_flight_count'] >= remote_slot_limit) %}
                <div class="small mt-8">
                  All global PCL batch slots are currently in use: {{ global_slot_status['in_flight_count'] }} / {{ remote_slot_limit }}.
                  {% if global_slot_status['next_poll_at'] %}
                    Next global poll (UTC): {{ global_slot_status['next_poll_at'].isoformat() }}.
                  {% endif %}
                </div>
              {% else %}
                <div class="small mt-8">
                  This run should begin as soon as a worker tick submits the first segment.
                </div>
              {% endif %}

              {% if queue_reasons %}
                {% set top_queue = (queue_reasons[0].message if queue_reasons else '')|lower %}
                <div class="small mt-8">
                  <strong>Queued segment notes:</strong>
                  <ul class="small">
                    {% for reason in queue_reasons %}
                      <li>
                        {{ reason.count }}: {{ reason.message }}
                        {% if reason.next_poll_at %} (next retry UTC: {{ reason.next_poll_at.isoformat() }}){% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
                {% if '429' in top_queue or 'concurrent' in top_queue or 'maximum batch' in top_queue %}
                  <div class="small mt-8">
                    PCL is throttling new batch submissions. This often happens when too many remote batch reports exist.
                  </div>
              <form method="post" action="{{ url_for('admin_federal_data_dashboard_pcl_reports_cleanup') }}" class="mt-8">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                <input type="hidden" name="batch_request_id" value="{{ batch_request_id }}">
                <button class="pill" type="submit">Cleanup Remote PCL Reports</button>
              </form>
            {% endif %}
          {% endif %}
            </div>
          {% endif %}

          {% if segment_statuses.get('failed', 0) %}
            {% set top_failure = (failure_reasons[0].message if failure_reasons else '')|lower %}
            <div class="flash error">
              <strong>Some segments failed.</strong>
              {% if failure_reasons %}
                <div class="small mt-8">
                  <strong>Top failure reasons:</strong>
                  <ul class="small">
                    {% for reason in failure_reasons %}
                      <li>{{ reason.count }}: {{ reason.message }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              <div class="small mt-8">
                Next step:
                {% if 'token' in top_failure or 'expired' in top_failure or 'authorization' in top_failure or 'authorisation' in top_failure %}
                  re-authenticate under
                  <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_get_pacer_data', manual='1') }}">Get PACER Data</a>
                  and retry.
                {% else %}
                  check
                  <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_health_checks') }}">Health Checks</a>
                  and retry.
                {% endif %}
              </div>
            </div>
          {% endif %}

          <details class="pacer-status-summary">
            <summary>
              <div class="pacer-status-summary__row">
                <span>Debug</span>
                <span class="pacer-status-summary__text">
                  Global slots: {{ global_slot_status['in_flight_count'] }} / {{ remote_slot_limit }}
                  {% if tick_processed is not none %} · last tick processed {{ tick_processed }} segment(s){% endif %}
                </span>
                <span class="pacer-status-summary__hint">expand</span>
              </div>
            </summary>
            <div class="pacer-status-details small">
              <div><strong>Global in-flight:</strong> {{ global_slot_status['in_flight_count'] }} / {{ remote_slot_limit }}</div>
              <div><strong>Global next poll (UTC):</strong> {% if global_slot_status['next_poll_at'] %}{{ global_slot_status['next_poll_at'].isoformat() }}{% else %}—{% endif %}</div>
              <div><strong>This page tick:</strong> {% if tick_processed is not none %}processed {{ tick_processed }} segment(s){% else %}not run (missing tick=1){% endif %}</div>
              {% if global_slot_status['segments'] %}
                <div class="mt-8"><strong>Sample in-flight segments:</strong></div>
                <ul class="small">
                  {% for seg in global_slot_status['segments'] %}
                    <li>
                      run #{{ seg['batch_request_id'] }} · {{ (seg['court_id'] or '')|upper }} · {{ seg['status'] }}
                      · {{ seg['date_filed_from'] }} to {{ seg['date_filed_to'] }}
                      {% if seg['next_poll_at'] %}· next poll {{ seg['next_poll_at'].isoformat() }}{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </details>

          <dl class="pcl-detail-list">
            <div>
              <dt>Cases discovered</dt>
              <dd>{{ discovered_total }}</dd>
            </div>
            <div>
              <dt>{% if has_judge_filter %}Judge-filtered matches{% else %}Judge filter{% endif %}</dt>
              <dd>
                {% if has_judge_filter %}
                  {{ filtered_count }}
                {% else %}
                  not set
                {% endif %}
              </dd>
            </div>
            <div>
              <dt>Segments processed</dt>
              <dd>
                {{ segment_complete }} / {{ segment_total }}
                ({{ segment_statuses.get('completed', 0) }} completed, {{ segment_statuses.get('failed', 0) }} failed{% if segment_statuses.get('cancelled', 0) %}, {{ segment_statuses.get('cancelled', 0) }} cancelled{% endif %})
              </dd>
            </div>
            <div>
              <dt>Run state</dt>
              <dd>{% if is_complete %}ready to review{% else %}collecting{% endif %}</dd>
            </div>
          </dl>

          <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ segment_percent }}">
            <div class="progress-bar" style="width: {{ segment_percent }}%"></div>
          </div>
          <div class="progress-meta small">
            <span>{{ segment_percent }}%</span>
            <span>{{ segment_complete }} / {{ segment_total }} segments</span>
          </div>

          {% if discovered_total and has_judge_filter and not discovered_with_judge %}
            <p class="small">
              Note: cases were discovered, but the batch payload did not include judge metadata. If matches stay at 0,
              you will need to confirm assignment via docket headers during docket pulls.
            </p>
          {% elif discovered_total and not has_judge_filter %}
            <p class="small">
              Tip: set a judge filter in Step 2 if you want to pull dockets for one judge.
            </p>
          {% endif %}

          <div class="wizard-actions">
            <a
              class="pill"
              href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=1, tick=1) }}"
            >
              Refresh now
            </a>
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search') }}">Start new search</a>
            {% if not is_complete %}
              <form method="post" action="{{ url_for('admin_federal_data_dashboard_judge_search_cancel', batch_request_id=batch_request_id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="judge_last_name" value="{{ judge_last_name }}">
                <input type="hidden" name="judge_initials" value="{{ judge_initials }}">
                <input type="hidden" name="max_cases" value="{{ max_cases }}">
                <input type="hidden" name="case_scope" value="{{ case_scope }}">
                <button class="pill muted" type="submit">Cancel search</button>
              </form>
            {% elif segment_statuses.get('failed', 0) %}
              <form method="post" action="{{ url_for('admin_federal_data_dashboard_judge_search_retry', batch_request_id=batch_request_id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="judge_last_name" value="{{ judge_last_name }}">
                <input type="hidden" name="judge_initials" value="{{ judge_initials }}">
                <input type="hidden" name="max_cases" value="{{ max_cases }}">
                <input type="hidden" name="case_scope" value="{{ case_scope }}">
                <button class="pill" type="submit">Retry failed segments</button>
              </form>
            {% endif %}
            {% if is_complete %}
              <a
                class="primary"
                href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=2) }}"
              >
                Continue to review cases
              </a>
            {% endif %}
          </div>

          {% if not is_complete %}
            <script>
              const refreshUrl = {{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=1, tick=1) | tojson }};
              setTimeout(() => {
                window.location.assign(refreshUrl);
              }, 12000);
            </script>
          {% endif %}
        </section>
      {% elif active_step == 2 %}
        <section class="wizard-step stack">
          <h3>Step 2: Review cases ({% if case_scope == 'all' %}all discovered{% else %}filtered by judge{% endif %})</h3>
          <div class="flash">
            <strong>Filter by judge (optional)</strong>
            <div class="small mt-8">
              Enter a judge last name to narrow the list before pulling dockets. If matches are empty, switch to “Show all discovered”.
            </div>
            <form
              method="get"
              action="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id) }}"
              class="pcl-filter-form mt-8"
            >
              <input type="hidden" name="step" value="2">
              <input type="hidden" name="max_cases" value="{{ max_cases }}">
              <input type="hidden" name="case_scope" value="matched">
              <div class="grid two">
                <div>
                  <label for="judge-last-name">Judge last name</label>
                  <input
                    id="judge-last-name"
                    name="judge_last_name"
                    value="{{ judge_last_name }}"
                    placeholder="Example: Kearney"
                  >
                </div>
                <div>
                  <label for="judge-initials">Judge initials (optional)</label>
                  <input
                    id="judge-initials"
                    name="judge_initials"
                    value="{{ judge_initials }}"
                    placeholder="Example: MAK"
                  >
                </div>
              </div>
              <div class="actions mt-8">
                <button class="pill" type="submit">Apply judge filter</button>
                <a
                  class="pill"
                  href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, max_cases=max_cases, case_scope='all', step=2) }}"
                >
                  Clear filter
                </a>
              </div>
            </form>
          </div>
          <div class="flash">
            <strong>What to do on this step</strong>
            <ul class="small mt-8">
              <li>Open 1 to 2 cases to confirm you are looking at the right group.</li>
              <li>If you want only one judge, apply a judge filter above and click “Show filtered”.</li>
              <li>When the list looks right, click “Continue to queue dockets”.</li>
            </ul>
          </div>
          <p class="small">Showing {{ display_rows|length }} case(s). This list is ordered newest-to-oldest.</p>

          <div class="actions">
            {% if has_judge_filter %}
              <a
                class="pill {% if case_scope != 'all' %}is-current{% endif %}"
                href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope='matched', step=2) }}"
              >
                Show filtered
              </a>
            {% else %}
              <span class="pill muted" aria-disabled="true">Show filtered</span>
            {% endif %}
            <a
              class="pill {% if case_scope == 'all' %}is-current{% endif %}"
              href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope='all', step=2) }}"
            >
              Show all discovered
            </a>
          </div>

          {% if display_rows %}
            <div class="table-wrap">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Case</th>
                    <th>Jurisdiction</th>
                    <th>Type</th>
                    <th>Date filed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for case in display_rows %}
                    <tr>
                      <td>
                        <a class="pacer-text-link" href="{{ url_for('admin_pcl_case_detail', case_id=case.id) }}">
                          {{ case.case_number_full or case.case_number }}
                        </a>
                        <div class="small">{{ case.short_title or case.case_title or "Untitled case" }}</div>
                      </td>
                      <td>{{ case.court_id }}</td>
                      <td>{{ case.case_type or "—" }}</td>
                      <td>{{ case.date_filed.isoformat() if case.date_filed else "—" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% if case_scope == 'all' %}
              <p class="small">No cases discovered for this run.</p>
            {% else %}
              <p class="small">No filtered matches. Try a different judge last name or switch to “Show all discovered”.</p>
            {% endif %}
          {% endif %}

          <div class="wizard-actions">
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=1) }}">Back</a>
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=2, tick=1) }}">Refresh</a>
            {% if display_rows %}
              <a class="primary" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=3) }}">Continue to queue dockets</a>
            {% endif %}
          </div>
        </section>
      {% elif active_step == 3 %}
        <section class="wizard-step stack">
          <h3>Step 3: Pull dockets</h3>
          {% if last_queue %}
            <div class="flash success">
              <strong>Queued docket jobs.</strong>
              <div class="small mt-8">
                Queued {{ last_queue.queued }} job(s) and skipped {{ last_queue.skipped }} already queued/running.
              </div>
              {% if last_queue.worker_started %}
                <div class="small mt-8">
                  Worker started for up to {{ last_queue.worker_jobs }} job(s). Continue to Step 4 to see results.
                </div>
              {% endif %}
            </div>
          {% endif %}
          {% if display_rows %}
            <div class="flash">
              <strong>What happens next</strong>
              <ul class="small mt-8">
                <li>Click “Add … to docket queue” to create docket jobs for these cases.</li>
                <li>Leave “Include docket text” checked unless you are minimizing cost.</li>
                <li>If you check “Run the worker now”, it will process a batch in the background.</li>
                <li>After queueing, go to Step 4 to view job status and open docket results.</li>
                <li>
                  If jobs fail with a token/login error, re-authenticate under
                  <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_get_pacer_data', manual='1') }}">Get PACER Data</a>.
                </li>
              </ul>
            </div>
            <form
              method="post"
              action="{{ url_for('admin_federal_data_dashboard_judge_search_queue', batch_request_id=batch_request_id) }}"
              class="stack"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="judge_last_name" value="{{ judge_last_name }}">
              <input type="hidden" name="judge_initials" value="{{ judge_initials }}">
              <input type="hidden" name="max_cases" value="{{ max_cases }}">
              <input type="hidden" name="case_scope" value="{{ case_scope }}">
              <label>
                <input type="checkbox" name="include_docket_text" value="1" checked>
                Include docket text when queueing
              </label>
              <label>
                <input type="checkbox" name="start_docket_worker" value="1">
                Run the worker now (process a batch in the background)
              </label>
              <label>
                Docket worker batch size
                <input type="number" name="max_docket_jobs" min="1" max="200" value="50">
              </label>
              <button class="primary" type="submit">
                {% if case_scope == 'all' %}Add discovered cases to docket queue{% else %}Add filtered cases to docket queue{% endif %}
              </button>
            </form>
          {% else %}
            {% if case_scope == 'all' %}
              <p class="small">This step unlocks once discovered cases appear in Step 2.</p>
            {% else %}
              <p class="small">This step unlocks once filtered matches appear in Step 2.</p>
            {% endif %}
          {% endif %}

          <div class="wizard-actions">
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=2) }}">Back</a>
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=3, tick=1) }}">Refresh</a>
            <a class="primary" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=4) }}">Continue to view results</a>
          </div>
        </section>
      {% else %}
        <section class="wizard-step stack">
          <h3>Step 4: View results</h3>

          <div class="flash">
            <strong>What to do on this step</strong>
            <ul class="small mt-8">
              <li>Refresh to watch jobs move from queued to running to completed.</li>
              <li>If jobs failed with a token/login error, re-authenticate under <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_get_pacer_data', manual='1') }}">Get PACER Data</a>, then retry.</li>
              <li>Open a case to view the saved docket text/entries.</li>
            </ul>
          </div>

          <dl class="pcl-detail-list">
            <div>
              <dt>Cases in this step</dt>
              <dd>{{ docket_summary.total_cases }}</dd>
            </div>
            <div>
              <dt>Completed</dt>
              <dd>{{ docket_summary.status_counts.get('completed', 0) }}</dd>
            </div>
            <div>
              <dt>Queued</dt>
              <dd>{{ docket_summary.status_counts.get('queued', 0) }}</dd>
            </div>
            <div>
              <dt>Running</dt>
              <dd>{{ docket_summary.status_counts.get('running', 0) }}</dd>
            </div>
            <div>
              <dt>Failed</dt>
              <dd>{{ docket_summary.status_counts.get('failed', 0) }}</dd>
            </div>
          </dl>

          {% if docket_summary.top_errors %}
            <div class="flash error">
              <strong>Top docket failures</strong>
              <ul class="small mt-8">
                {% for reason in docket_summary.top_errors %}
                  <li>{{ reason.count }}: {{ reason.message }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if docket_case_rows %}
            <div class="table-wrap">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Case</th>
                    <th>Docket job</th>
                    <th>Docket data</th>
                    <th>Last update</th>
                    <th>Last error</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in docket_case_rows %}
                    <tr>
                      <td>
                        <a class="pacer-text-link" href="{{ url_for('admin_pcl_case_detail', case_id=row.case_id) }}">
                          {{ row.case_number_full or row.case_number }}
                        </a>
                        <div class="small">{{ row.short_title or row.case_title or "Untitled case" }}</div>
                      </td>
                      <td>{{ row.job_status or "—" }}</td>
                      <td>{% if row.has_docket_data %}yes{% else %}no{% endif %}</td>
                      <td>{{ row.job_updated_at.isoformat() if row.job_updated_at else "—" }}</td>
                      <td>{{ row.job_last_error or "—" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No cases available for results yet. Queue dockets in Step 3 first.</p>
          {% endif %}

          <div class="wizard-actions">
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=3) }}">Back</a>
            <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_last_name=judge_last_name or None, judge_initials=judge_initials or None, max_cases=max_cases, case_scope=case_scope, step=4, tick=1) }}">Refresh</a>
            <a class="pill" href="{{ case_cards_url }}">Open Case Cards</a>
          </div>
        </section>
      {% endif %}
    </div>
  </section>
{% endblock %}
