{% extends "admin_federal_data_base.html" %}

{% block title %}Judge Search Results{% endblock %}

  {% block federal_content %}
    <section class="card stack">
      <div class="page-header page-header--tight">
        <h2>{{ judge.name }} PACER results</h2>
        <p class="small">
          Judge search run #{{ batch_request_id }} | {{ batch_request.date_filed_from }} to {{ batch_request.date_filed_to }} | court {{ batch_request.court_id|upper }}
        </p>
        <p class="small">
          Next: wait for cases to appear below, then click “Add … to docket queue” to pull docket histories.
        </p>
      </div>
    </section>

    <section class="card stack">
      <h3>Search status</h3>

      {% if segment_statuses.get('failed', 0) %}
        {% set top_failure = (failure_reasons[0].message if failure_reasons else '')|lower %}
        <div class="flash error">
          <strong>Some segments failed.</strong>
          {% if failure_reasons %}
            <div class="small mt-8">
              <strong>Top failure reasons:</strong>
              <ul class="small">
                {% for reason in failure_reasons %}
                  <li>{{ reason.count }}: {{ reason.message }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <div class="small mt-8">
            Troubleshooting:
            {% if 'authorization' in top_failure or 'authorisation' in top_failure or 'token' in top_failure or 'expired' in top_failure %}
              re-authenticate under
              <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_get_pacer_data', manual='1') }}">Get PACER Data</a>,
              then run a new judge search.
            {% elif 'court id' in top_failure and 'not recognized' in top_failure %}
              this usually means the PCL court catalog is not seeded yet.
              Check
              <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_health_checks') }}">Health Checks</a>
              and then run a new judge search.
            {% elif 'mismatch' in top_failure %}
              check PACER environment alignment under
              <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_health_checks') }}">Health Checks</a>,
              then run a new judge search.
            {% else %}
              check
              <a class="pacer-text-link" href="{{ url_for('admin_federal_data_dashboard_health_checks') }}">Health Checks</a>
              (token + environment), then run a new judge search.
            {% endif %}
          </div>
        </div>
      {% endif %}

      <dl class="pcl-detail-list">
        <div>
          <dt>Total cases discovered</dt>
          <dd>{{ discovered_total }}</dd>
        </div>
      <div>
        <dt>Discovered matches</dt>
        <dd>{{ discovered_count }}</dd>
      </div>
      <div>
        <dt>Judge metadata present</dt>
        <dd>{{ discovered_with_judge }}</dd>
      </div>
      <div>
        <dt>Discovery cap</dt>
        <dd>{% if max_cases > 0 %}Limited to {{ max_cases }}{% else %}Full search requested{% endif %}</dd>
      </div>
      <div>
        <dt>Segments finished</dt>
        <dd>
          {{ segment_complete }} / {{ segment_total }}
          ({{ segment_statuses.get('completed', 0) }} completed, {{ segment_statuses.get('failed', 0) }} failed{% if segment_statuses.get('cancelled', 0) %}, {{ segment_statuses.get('cancelled', 0) }} cancelled{% endif %})
        </dd>
      </div>
      <div>
        <dt>Run state</dt>
        <dd>{% if is_complete %}search complete{% else %}still collecting results{% endif %}</dd>
      </div>
    </dl>

    {% set segment_percent = 0 %}
    {% if segment_total > 0 %}
      {% set segment_percent = (segment_complete * 100) // segment_total %}
    {% endif %}
    <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ segment_percent }}">
      <div class="progress-bar" style="width: {{ segment_percent }}%"></div>
    </div>
    <div class="progress-meta small">
      <span>{{ segment_percent }}%</span>
      <span>{{ segment_complete }} / {{ segment_total }} segments</span>
    </div>

    {% if discovered_total and not discovered_with_judge %}
      <p class="small">
        Note: this run discovered cases, but the batch case payload did not include judge metadata. If matches stay at 0,
        you will need to confirm assignment via docket headers (Assigned to: ...) during docket enrichment.
      </p>
    {% endif %}

    <div class="actions mt-12">
      <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_id=judge_id, max_cases=max_cases, case_scope=case_scope) }}">
        Refresh now
      </a>
      <a class="pill" href="{{ url_for('admin_federal_data_dashboard_judge_search') }}">
        Start new judge search
      </a>
      {% if not is_complete %}
        <form method="post" action="{{ url_for('admin_federal_data_dashboard_judge_search_cancel', batch_request_id=batch_request_id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="judge_id" value="{{ judge_id }}">
          <input type="hidden" name="max_cases" value="{{ max_cases }}">
          <input type="hidden" name="case_scope" value="{{ case_scope }}">
          <button class="pill muted" type="submit">Cancel search</button>
        </form>
      {% elif segment_statuses.get('failed', 0) %}
        <form method="post" action="{{ url_for('admin_federal_data_dashboard_judge_search_retry', batch_request_id=batch_request_id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="judge_id" value="{{ judge_id }}">
          <input type="hidden" name="max_cases" value="{{ max_cases }}">
          <input type="hidden" name="case_scope" value="{{ case_scope }}">
          <button class="pill" type="submit">Retry failed segments</button>
        </form>
      {% endif %}
    </div>
  </section>

  <section class="card stack">
    <h3>{% if case_scope == 'all' %}Discovered cases{% else %}Matched cases{% endif %}</h3>
    <p class="small">
      Showing {{ display_rows|length }} case(s). This list is ordered newest-to-oldest.
    </p>

    <div class="actions">
      <a
        class="pill {% if case_scope != 'all' %}is-current{% endif %}"
        href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_id=judge_id, max_cases=max_cases, case_scope='matched') }}"
      >
        Show matches
      </a>
      <a
        class="pill {% if case_scope == 'all' %}is-current{% endif %}"
        href="{{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_id=judge_id, max_cases=max_cases, case_scope='all') }}"
      >
        Show all discovered
      </a>
    </div>

    {% if not is_complete %}
      <p class="small">Background search is active. This page auto-refreshes every 12 seconds.</p>
      <script>
        const refreshUrl = {{ url_for('admin_federal_data_dashboard_judge_search_results', batch_request_id=batch_request_id, judge_id=judge_id, max_cases=max_cases, case_scope=case_scope) | tojson }};
        setTimeout(() => {
          window.location.assign(refreshUrl);
        }, 12000);
      </script>
    {% endif %}

    <form
      method="post"
      action="{{ url_for('admin_federal_data_dashboard_judge_search_queue', batch_request_id=batch_request_id) }}"
      class="stack"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="judge_id" value="{{ judge_id }}">
      <input type="hidden" name="max_cases" value="{{ max_cases }}">
      <input type="hidden" name="case_scope" value="{{ case_scope }}">
      <label>
        <input type="checkbox" name="include_docket_text" value="1" checked>
        Include docket text when queueing
      </label>
      <label>
        <input type="checkbox" name="start_docket_worker" value="1">
        Start docket worker now (runs one batch)
      </label>
      <label>
        Docket worker batch size
        <input type="number" name="max_docket_jobs" min="1" max="200" value="50">
      </label>
      <button class="primary" type="submit">
        {% if case_scope == 'all' %}Add discovered cases to docket queue{% else %}Add matched cases to docket queue{% endif %}
      </button>
    </form>

    {% if display_rows %}
      <div class="table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Case</th>
              <th>Jurisdiction</th>
              <th>Type</th>
              <th>Date filed</th>
            </tr>
          </thead>
          <tbody>
            {% for case in display_rows %}
              <tr>
                <td>
                  <a class="pacer-text-link" href="{{ url_for('admin_pcl_case_detail', case_id=case.id) }}">
                    {{ case.case_number_full or case.case_number }}
                  </a>
                  <div class="small">{{ case.short_title or case.case_title or "Untitled case" }}</div>
                </td>
                <td>{{ case.court_id }}</td>
                <td>{{ case.case_type or "—" }}</td>
                <td>{{ case.date_filed.isoformat() if case.date_filed else "—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      {% if case_scope == 'all' %}
        <p class="small">No cases discovered yet. If the run is still in progress, refresh for updates.</p>
      {% else %}
        <p class="small">No judge-filtered matches yet. If cases were discovered, try “Show all discovered”.</p>
      {% endif %}
    {% endif %}
  </section>
{% endblock %}
