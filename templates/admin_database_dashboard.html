{% extends "base.html" %}

{% block title %}Database Dashboard | CourtDataPro{% endblock %}

{% block content %}
  <div class="page-header database-header">
    <div>
      <h1>Database Explorer</h1>
      <p class="small">
        Review the active connection and browse schemas, tables, and columns available to admins.
      </p>
    </div>
  </div>

  <section class="card database-connection-card">
    <div class="database-connection-card__header">
      <div>
        <h2>Active Connection</h2>
        <p class="small">Connected via {{ database_dialect | title }}</p>
      </div>
      <span class="pill">{{ database_driver }}</span>
    </div>
    <div class="database-connection-card__body">
      <div>
        <p class="label">Database URL</p>
        <code class="code-block">{{ database_url }}</code>
      </div>
    </div>
  </section>

  <section class="card database-connection-card">
    <div class="database-connection-card__header">
      <div>
        <h2>Admin DB Check</h2>
        <p class="small">Validate PACER reference tables and key counts.</p>
      </div>
      <button class="button small" type="button" id="dbCheckRun">Run check</button>
    </div>
    <div class="database-connection-card__body">
      <p class="small" id="dbCheckStatus">Not run yet.</p>
      <pre class="code-block" id="dbCheckResults" hidden></pre>
    </div>
  </section>

  <div class="stat-grid database-stat-grid">
    <div class="stat-card">
      <span class="small">Schemas</span>
      <strong>{{ total_schemas }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Tables</span>
      <strong>{{ total_tables }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Columns</span>
      <strong>{{ total_columns }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Views</span>
      <strong>{{ total_views }}</strong>
    </div>
  </div>

  <section class="card database-toolbar">
    <div class="database-toolbar__search">
      <div class="database-search-header">
        <label class="label" for="databaseSearch">Search schemas, tables, or columns</label>
        <div class="database-search-meta">
          <span class="small" id="databaseSearchCount">Showing all tables</span>
          <button class="button small ghost" type="button" id="databaseSearchClear">Clear</button>
        </div>
      </div>
      <input
        id="databaseSearch"
        class="database-search-input"
        type="search"
        placeholder="Search for case_data_one, party_last_name, or any column"
      >
      <p class="small">Type to filter the navigator in real time. Results highlight what matches.</p>
    </div>
    <div class="database-toolbar__actions">
      <div class="database-toolbar__action">
        <p class="label">Preview limit</p>
        <form class="database-limit-form" method="get" action="{{ url_for('admin_database_dashboard') }}">
          {% if selected_schema %}
            <input type="hidden" name="schema" value="{{ selected_schema }}">
          {% endif %}
          {% if selected_table %}
            <input type="hidden" name="table" value="{{ selected_table }}">
          {% endif %}
          {% if selected_column %}
            <input type="hidden" name="column" value="{{ selected_column }}">
          {% endif %}
          <select name="limit">
            {% for option in [10, 25, 50, 75, 100] %}
              <option value="{{ option }}" {% if preview_limit == option %}selected{% endif %}>{{ option }} rows</option>
            {% endfor %}
          </select>
          <button class="button small" type="submit">Apply</button>
        </form>
      </div>
      <div class="database-toolbar__action">
        <p class="label">Database metadata</p>
        <form method="post" action="{{ url_for('admin_database_dashboard_refresh') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="button small" type="submit">Refresh databases &amp; tables</button>
        </form>
        <p class="small">Pulls the latest schema and table list from the database.</p>
      </div>
      <div class="database-toolbar__action">
        <p class="label">Quick tips</p>
        <ul class="database-toolbar__tips">
          <li class="small">Open schemas to see tables and drill into columns.</li>
          <li class="small">Use export to download CSVs for analysis.</li>
        </ul>
      </div>
    </div>
  </section>

  <div class="database-explorer">
    <aside class="card database-explorer__nav">
      <div class="database-explorer__nav-header">
        <div>
          <h2>Schema Navigator</h2>
          <p class="small">Select a table or column to preview live data.</p>
        </div>
      </div>

      {% if schemas %}
        <div class="database-explorer__schema-list">
          <p class="small database-search-empty" id="databaseSearchEmpty" hidden>
            No tables match your search. Try a different keyword.
          </p>
          {% for schema in schemas %}
            <details class="database-schema-item" data-schema="{{ schema.name }}" {% if selected_schema == schema.name %}open{% endif %}>
              <summary class="database-schema-item__summary">
                <div>
                  <span class="database-schema-item__name">{{ schema.name }}</span>
                  <span class="small">{{ schema.tables | length }} tables â€¢ {{ schema.views | length }} views</span>
                </div>
                <span class="pill">{{ schema.tables | length }} tables</span>
              </summary>

              <div class="database-schema-item__content">
                {% if schema.schema_error %}
                  <div class="database-schema-item__error">
                    <p class="small">Schema metadata unavailable: {{ schema.schema_error }}</p>
                  </div>
                {% endif %}
                {% if schema.tables %}
                  {% for table in schema.tables %}
                    <article
                      class="database-table-item {% if selected_schema == schema.name and selected_table == table.name %}active{% endif %}"
                      data-search="{{ schema.name }} {{ table.name }} {{ table.columns | map(attribute='name') | join(' ') }}"
                    >
                      <div class="database-table-item__header">
                        <div>
                          <h3>{{ table.name }}</h3>
                          <span class="small">{{ table.column_count }} columns</span>
                          {% if table.column_error %}
                            <span class="small database-table-item__error-label">Column metadata unavailable</span>
                          {% endif %}
                        </div>
                        <a class="button small" href="{{ url_for('admin_database_dashboard', schema=schema.name, table=table.name) }}">View data</a>
                      </div>
                      {% if table.column_error %}
                        <div class="database-table-item__error">
                          <p class="small">We could not load column details for this table.</p>
                        </div>
                      {% else %}
                        {% set preview_limit = 5 %}
                        {% set preview_columns = table.columns[:preview_limit] %}
                        <details class="database-table-item__columns">
                          <summary class="database-table-item__columns-summary">
                            <div class="database-table-item__columns-summary-text">
                              <span class="small">{{ table.column_count }} columns</span>
                              <span class="database-table-item__columns-preview">
                                {% for column in preview_columns %}
                                  {{ column.name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if table.column_count > preview_limit %}
                                  , ...
                                {% endif %}
                              </span>
                            </div>
                            <span class="database-table-item__columns-toggle">
                              {% if table.column_count > preview_limit %}
                                Show all columns
                              {% else %}
                                Show columns
                              {% endif %}
                            </span>
                          </summary>
                          <ul class="database-table-item__columns-list">
                            {% for column in table.columns %}
                              <li>
                                <div>
                                  <span class="database-column-name">{{ column.name }}</span>
                                  <span class="database-column-type">{{ column.type }}</span>
                                </div>
                                <div class="database-column-actions">
                                  {% if not column.nullable %}
                                    <span class="database-column-pill">Required</span>
                                  {% endif %}
                                  <a class="database-column-link" href="{{ url_for('admin_database_dashboard', schema=schema.name, table=table.name, column=column.name) }}">Drill down</a>
                                </div>
                              </li>
                            {% endfor %}
                          </ul>
                        </details>
                      {% endif %}
                    </article>
                  {% endfor %}
                {% else %}
                  <p class="small">No tables detected for this schema.</p>
                {% endif %}

                {% if schema.views %}
                  <div class="database-view-block">
                    <p class="small">Views: {{ schema.views | join(", ") }}</p>
                  </div>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <p class="small">No schemas were found for the current connection.</p>
      {% endif %}
    </aside>

    <section class="card database-explorer__detail">
      <div class="database-detail-header">
        <div>
          <h2>Data Preview</h2>
          <p class="small">Preview real rows and column samples to validate schemas quickly.</p>
        </div>
        <div class="database-detail-meta">
          {% if selected_schema and selected_table %}
            <span class="pill">Schema: {{ selected_schema }}</span>
            <span class="pill">Table: {{ selected_table }}</span>
            {% if selected_column %}
              <span class="pill">Column: {{ selected_column }}</span>
            {% else %}
              <span class="pill muted">Column: None</span>
            {% endif %}
          {% else %}
            <span class="pill muted">No selection yet</span>
          {% endif %}
        </div>
      </div>

      {% if selected_schema and selected_table %}
        <div class="database-detail-actions">
          <div class="database-detail-card">
            <h3>Table controls</h3>
            <div class="database-detail-card__body">
              <div>
                <p class="label">Table</p>
                <p class="small">{{ selected_schema }}.{{ selected_table }}</p>
              </div>
              <div>
                <p class="label">Columns</p>
                <p class="small">{{ selected_table_columns | length }}</p>
              </div>
              <a
                class="button secondary small"
                href="{{ url_for('admin_database_dashboard_export', schema=selected_schema, table=selected_table, limit=preview_limit) }}"
              >
                Export all columns
              </a>
            </div>
          </div>
          <div class="database-detail-card">
            <h3>Export data</h3>
            <form class="database-export-form" method="get" action="{{ url_for('admin_database_dashboard_export') }}">
              <input type="hidden" name="schema" value="{{ selected_schema }}">
              <input type="hidden" name="table" value="{{ selected_table }}">
              <div class="database-export-controls">
                <button class="button secondary small" type="button" data-action="select-all">Select all</button>
                <button class="button secondary small" type="button" data-action="clear-all">Clear</button>
              </div>
              <div class="database-column-checklist">
                {% for column in selected_table_columns %}
                  <label class="database-column-checklist__item">
                    <input type="checkbox" name="columns" value="{{ column.name }}" checked>
                    <span>{{ column.name }}</span>
                    <span class="small">{{ column.type }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="database-export-footer">
                <label class="small" for="exportLimit">Export limit</label>
                <input id="exportLimit" type="number" name="limit" min="1" max="5000" value="{{ preview_limit }}">
                <button class="button small" type="submit">Download CSV</button>
              </div>
            </form>
          </div>
        </div>

        <div class="database-detail-section">
          <h3>Table Snapshot</h3>
          <p class="small">Showing up to {{ preview_limit }} rows from the selected table.</p>
          {% if table_preview_error %}
            <div class="error-actions">
              <p class="small">Unable to load table data: {{ table_preview_error }}</p>
            </div>
          {% elif table_preview %}
            <div class="database-preview-toolbar">
              <div class="database-preview-meta">
                <span class="database-pill">Columns: {{ table_preview.columns | length }}</span>
                <span class="database-pill" id="tablePreviewRowCount">
                  Rows: {{ table_preview.rows | length }}
                </span>
              </div>
              <div class="database-preview-controls">
                <label class="database-preview-search">
                  <span class="small">Filter rows</span>
                  <input id="tablePreviewSearch" type="search" placeholder="Search values">
                </label>
                <button class="button secondary small" type="button" id="tablePreviewClear">
                  Clear
                </button>
                <label class="database-preview-toggle">
                  <input type="checkbox" id="tablePreviewWrap">
                  <span>Wrap cells</span>
                </label>
              </div>
            </div>
            <div class="database-preview-table">
              <table>
                <thead>
                  <tr>
                    {% for column in table_preview.columns %}
                      <th>{{ column }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% if table_preview.rows %}
                    {% for row in table_preview.rows %}
                      <tr data-preview-row>
                        {% for column in table_preview.columns %}
                          <td title="{{ row[column] }}">{{ row[column] }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="{{ table_preview.columns | length }}">
                        <span class="small">No rows returned for this table.</span>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No data available for this table.</p>
          {% endif %}
        </div>

        <div class="database-detail-section">
          <h3>Column Drilldown</h3>
          <p class="small">Select a column to preview values and metadata.</p>
          <div class="database-column-summary">
            {% for column in selected_table_columns %}
              <a class="database-column-card {% if selected_column == column.name %}active{% endif %}" href="{{ url_for('admin_database_dashboard', schema=selected_schema, table=selected_table, column=column.name) }}">
                <div>
                  <strong>{{ column.name }}</strong>
                  <span class="small">{{ column.type }}</span>
                </div>
                <span class="database-column-card__meta">
                  {% if not column.nullable %}
                    Required
                  {% else %}
                    Optional
                  {% endif %}
                </span>
              </a>
            {% endfor %}
          </div>

          {% if selected_column %}
            {% if column_preview_error %}
              <div class="error-actions">
                <p class="small">Unable to load column data: {{ column_preview_error }}</p>
              </div>
            {% elif column_preview %}
              <div class="database-column-preview">
                <h4>Sample values for {{ column_preview.name }}</h4>
                {% if column_preview.values %}
                  <ul>
                    {% for value in column_preview.values %}
                      <li>{{ value }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="small">No values returned for this column.</p>
                {% endif %}
              </div>
            {% else %}
              <p class="small">Select a column to see sample values.</p>
            {% endif %}
          {% endif %}
        </div>
      {% else %}
        <div class="database-detail-empty">
          <h3>Select a table to begin</h3>
          <p class="small">
            Pick a schema and table from the left to explore live data, columns, and sample values.
          </p>
        </div>
      {% endif %}
    </section>
  </div>

  <script>
    const dbCheckRun = document.getElementById("dbCheckRun");
    const dbCheckStatus = document.getElementById("dbCheckStatus");
    const dbCheckResults = document.getElementById("dbCheckResults");
    if (dbCheckRun && dbCheckStatus && dbCheckResults) {
      dbCheckRun.addEventListener("click", async () => {
        dbCheckStatus.textContent = "Running...";
        dbCheckResults.hidden = true;
        try {
          const response = await fetch("{{ url_for('admin_database_dashboard_db_check') }}");
          const payload = await response.json();
          if (!response.ok || !payload.ok) {
            throw new Error(payload.error || "Request failed");
          }
          const lines = [];
          lines.push(`Checked at: ${payload.checked_at}`);
          lines.push("");
          for (const row of payload.tables || []) {
            const statusText = row.exists ? "present" : "missing";
            const countText = row.count === null || row.count === undefined ? "n/a" : row.count;
            const errorText = row.error ? ` (${row.error})` : "";
            lines.push(`${row.table}: ${statusText}, count=${countText}${errorText}`);
          }
          dbCheckResults.textContent = lines.join("\\n");
          dbCheckResults.hidden = false;
          dbCheckStatus.textContent = "Done.";
        } catch (err) {
          dbCheckStatus.textContent = `Error: ${err.message}`;
        }
      });
    }

    const searchInput = document.getElementById("databaseSearch");
    if (searchInput) {
      const schemaItems = document.querySelectorAll(".database-schema-item");
      const searchCount = document.getElementById("databaseSearchCount");
      const searchClear = document.getElementById("databaseSearchClear");
      const searchEmpty = document.getElementById("databaseSearchEmpty");
      const highlightTargets = Array.from(
        document.querySelectorAll(
          ".database-table-item h3, .database-column-name, .database-table-item__columns-preview"
        )
      );
      const escapeRegExp = (value) =>
        value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const updateHighlights = (query) => {
        highlightTargets.forEach((target) => {
          const originalText = target.dataset.searchOriginal || target.textContent;
          target.dataset.searchOriginal = originalText;
          if (!query) {
            target.textContent = originalText;
            return;
          }
          const regex = new RegExp(`(${escapeRegExp(query)})`, "ig");
          target.innerHTML = originalText.replace(
            regex,
            '<span class="database-search-highlight">$1</span>'
          );
        });
      };
      const updateSearchMeta = () => {
        let visibleTables = 0;
        schemaItems.forEach((schemaItem) => {
          const visibleTablesInSchema = schemaItem.querySelectorAll(
            ".database-table-item:not([style*='display: none'])"
          ).length;
          visibleTables += visibleTablesInSchema;
        });
        if (searchCount) {
          searchCount.textContent = visibleTables
            ? `Showing ${visibleTables} table${visibleTables === 1 ? "" : "s"}`
            : "No tables found";
        }
        if (searchEmpty) {
          searchEmpty.hidden = visibleTables !== 0;
        }
      };
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim().toLowerCase();
        schemaItems.forEach((schemaItem) => {
          let hasMatch = false;
          const tableItems = schemaItem.querySelectorAll(".database-table-item");
          tableItems.forEach((tableItem) => {
            const haystack = (tableItem.dataset.search || tableItem.textContent).toLowerCase();
            const matches = !query || haystack.includes(query);
            tableItem.style.display = matches ? "" : "none";
            if (matches) {
              hasMatch = true;
            }
          });
          schemaItem.style.display = !query || hasMatch ? "" : "none";
          if (query && hasMatch) {
            schemaItem.setAttribute("open", "open");
          }
        });
        updateSearchMeta();
        updateHighlights(query);
      });
      if (searchClear) {
        searchClear.addEventListener("click", () => {
          searchInput.value = "";
          searchInput.dispatchEvent(new Event("input"));
          searchInput.focus();
        });
      }
      updateSearchMeta();
      updateHighlights(searchInput.value.trim());
    }

    const exportForm = document.querySelector(".database-export-form");
    if (exportForm) {
      const checkboxes = Array.from(
        exportForm.querySelectorAll('input[type="checkbox"][name="columns"]')
      );
      const submitButton = exportForm.querySelector('button[type="submit"]');
      const updateSubmitState = () => {
        const anyChecked = checkboxes.some((checkbox) => checkbox.checked);
        if (submitButton) {
          submitButton.disabled = !anyChecked;
        }
      };
      exportForm.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.dataset.action === "select-all") {
          checkboxes.forEach((checkbox) => {
            checkbox.checked = true;
          });
        }
        if (target.dataset.action === "clear-all") {
          checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
        }
        updateSubmitState();
      });
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", updateSubmitState);
      });
      updateSubmitState();
    }

    const previewTable = document.querySelector(".database-preview-table");
    if (previewTable) {
      const searchInput = document.getElementById("tablePreviewSearch");
      const clearButton = document.getElementById("tablePreviewClear");
      const wrapToggle = document.getElementById("tablePreviewWrap");
      const rowCount = document.getElementById("tablePreviewRowCount");
      const rows = Array.from(previewTable.querySelectorAll("tbody tr[data-preview-row]"));
      const totalRows = rows.length;

      const updateRowCount = (visibleCount) => {
        if (!rowCount) {
          return;
        }
        if (totalRows === 0) {
          rowCount.textContent = "Rows: 0";
          return;
        }
        const label = visibleCount === totalRows
          ? `Rows: ${totalRows}`
          : `Rows: ${visibleCount} of ${totalRows}`;
        rowCount.textContent = label;
      };

      const filterRows = () => {
        if (!searchInput) {
          updateRowCount(totalRows);
          return;
        }
        const query = searchInput.value.trim().toLowerCase();
        let visibleCount = 0;
        rows.forEach((row) => {
          const haystack = row.textContent.toLowerCase();
          const matches = !query || haystack.includes(query);
          row.hidden = !matches;
          if (matches) {
            visibleCount += 1;
          }
        });
        updateRowCount(visibleCount);
      };

      if (searchInput) {
        searchInput.addEventListener("input", filterRows);
      }

      if (clearButton && searchInput) {
        clearButton.addEventListener("click", () => {
          searchInput.value = "";
          searchInput.focus();
          filterRows();
        });
      }

      if (wrapToggle) {
        wrapToggle.addEventListener("change", () => {
          previewTable.classList.toggle(
            "database-preview-table--wrap",
            wrapToggle.checked
          );
        });
      }

      updateRowCount(totalRows);
    }
  </script>
{% endblock %}
