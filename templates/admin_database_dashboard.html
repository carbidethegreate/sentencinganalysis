{% extends "base.html" %}

{% block title %}Database Dashboard | CourtDataPro{% endblock %}

{% block content %}
  <div class="page-header database-header">
    <div>
      <h1>Database Explorer</h1>
      <p class="small">
        Review the active connection and browse schemas, tables, and columns available to admins.
      </p>
    </div>
  </div>

  <section class="card database-connection-card">
    <div class="database-connection-card__header">
      <div>
        <h2>Active Connection</h2>
        <p class="small">Connected via {{ database_dialect | title }}</p>
      </div>
      <span class="pill">{{ database_driver }}</span>
    </div>
    <div class="database-connection-card__body">
      <div>
        <p class="label">Database URL</p>
        <code class="code-block">{{ database_url }}</code>
      </div>
    </div>
  </section>

  <div class="stat-grid database-stat-grid">
    <div class="stat-card">
      <span class="small">Schemas</span>
      <strong>{{ total_schemas }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Tables</span>
      <strong>{{ total_tables }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Columns</span>
      <strong>{{ total_columns }}</strong>
    </div>
    <div class="stat-card">
      <span class="small">Views</span>
      <strong>{{ total_views }}</strong>
    </div>
  </div>

  <section class="card database-toolbar">
    <div class="database-toolbar__search">
      <label class="label" for="databaseSearch">Search schemas, tables, or columns</label>
      <input
        id="databaseSearch"
        class="database-search-input"
        type="search"
        placeholder="Search for case_data_one, party_last_name, or any column"
      >
      <p class="small">Type to filter the navigator in real time. Results highlight what matches.</p>
    </div>
    <div class="database-toolbar__actions">
      <div class="database-toolbar__action">
        <p class="label">Preview limit</p>
        <form class="database-limit-form" method="get" action="{{ url_for('admin_database_dashboard') }}">
          {% if selected_schema %}
            <input type="hidden" name="schema" value="{{ selected_schema }}">
          {% endif %}
          {% if selected_table %}
            <input type="hidden" name="table" value="{{ selected_table }}">
          {% endif %}
          {% if selected_column %}
            <input type="hidden" name="column" value="{{ selected_column }}">
          {% endif %}
          <select name="limit">
            {% for option in [10, 25, 50, 75, 100] %}
              <option value="{{ option }}" {% if preview_limit == option %}selected{% endif %}>{{ option }} rows</option>
            {% endfor %}
          </select>
          <button class="button small" type="submit">Apply</button>
        </form>
      </div>
      <div class="database-toolbar__action">
        <p class="label">Quick tips</p>
        <ul class="database-toolbar__tips">
          <li class="small">Open schemas to see tables and drill into columns.</li>
          <li class="small">Use export to download CSVs for analysis.</li>
        </ul>
      </div>
    </div>
  </section>

  <div class="database-explorer">
    <aside class="card database-explorer__nav">
      <div class="database-explorer__nav-header">
        <div>
          <h2>Schema Navigator</h2>
          <p class="small">Select a table or column to preview live data.</p>
        </div>
      </div>

      {% if schemas %}
        <div class="database-explorer__schema-list">
          {% for schema in schemas %}
            <details class="database-schema-item" data-schema="{{ schema.name }}" {% if selected_schema == schema.name %}open{% endif %}>
              <summary class="database-schema-item__summary">
                <div>
                  <span class="database-schema-item__name">{{ schema.name }}</span>
                  <span class="small">{{ schema.tables | length }} tables â€¢ {{ schema.views | length }} views</span>
                </div>
                <span class="pill">{{ schema.tables | length }} tables</span>
              </summary>

              <div class="database-schema-item__content">
                {% if schema.tables %}
                  {% for table in schema.tables %}
                    <article
                      class="database-table-item {% if selected_schema == schema.name and selected_table == table.name %}active{% endif %}"
                      data-search="{{ schema.name }} {{ table.name }} {{ table.columns | map(attribute='name') | join(' ') }}"
                    >
                      <div class="database-table-item__header">
                        <div>
                          <h3>{{ table.name }}</h3>
                          <span class="small">{{ table.column_count }} columns</span>
                        </div>
                        <a class="button small" href="{{ url_for('admin_database_dashboard', schema=schema.name, table=table.name) }}">View data</a>
                      </div>
                      <ul class="database-table-item__columns">
                        {% for column in table.columns %}
                          <li>
                            <div>
                              <span class="database-column-name">{{ column.name }}</span>
                              <span class="database-column-type">{{ column.type }}</span>
                            </div>
                            <div class="database-column-actions">
                              {% if not column.nullable %}
                                <span class="database-column-pill">Required</span>
                              {% endif %}
                              <a class="database-column-link" href="{{ url_for('admin_database_dashboard', schema=schema.name, table=table.name, column=column.name) }}">Drill down</a>
                            </div>
                          </li>
                        {% endfor %}
                      </ul>
                    </article>
                  {% endfor %}
                {% else %}
                  <p class="small">No tables detected for this schema.</p>
                {% endif %}

                {% if schema.views %}
                  <div class="database-view-block">
                    <p class="small">Views: {{ schema.views | join(", ") }}</p>
                  </div>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <p class="small">No schemas were found for the current connection.</p>
      {% endif %}
    </aside>

    <section class="card database-explorer__detail">
      <div class="database-detail-header">
        <div>
          <h2>Data Preview</h2>
          <p class="small">Preview real rows and column samples to validate schemas quickly.</p>
        </div>
        {% if selected_schema and selected_table %}
          <div class="database-detail-meta">
            <span class="pill">{{ selected_schema }}</span>
            <span class="pill">{{ selected_table }}</span>
            {% if selected_column %}
              <span class="pill">{{ selected_column }}</span>
            {% endif %}
          </div>
        {% endif %}
      </div>

      {% if selected_schema and selected_table %}
        <div class="database-detail-actions">
          <div class="database-detail-card">
            <h3>Table controls</h3>
            <div class="database-detail-card__body">
              <div>
                <p class="label">Table</p>
                <p class="small">{{ selected_schema }}.{{ selected_table }}</p>
              </div>
              <div>
                <p class="label">Columns</p>
                <p class="small">{{ selected_table_columns | length }}</p>
              </div>
              <a
                class="button secondary small"
                href="{{ url_for('admin_database_dashboard_export', schema=selected_schema, table=selected_table, limit=preview_limit) }}"
              >
                Export all columns
              </a>
            </div>
          </div>
          <div class="database-detail-card">
            <h3>Export data</h3>
            <form class="database-export-form" method="get" action="{{ url_for('admin_database_dashboard_export') }}">
              <input type="hidden" name="schema" value="{{ selected_schema }}">
              <input type="hidden" name="table" value="{{ selected_table }}">
              <div class="database-export-controls">
                <button class="button secondary small" type="button" data-action="select-all">Select all</button>
                <button class="button secondary small" type="button" data-action="clear-all">Clear</button>
              </div>
              <div class="database-column-checklist">
                {% for column in selected_table_columns %}
                  <label class="database-column-checklist__item">
                    <input type="checkbox" name="columns" value="{{ column.name }}" checked>
                    <span>{{ column.name }}</span>
                    <span class="small">{{ column.type }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="database-export-footer">
                <label class="small" for="exportLimit">Export limit</label>
                <input id="exportLimit" type="number" name="limit" min="1" max="5000" value="{{ preview_limit }}">
                <button class="button small" type="submit">Download CSV</button>
              </div>
            </form>
          </div>
        </div>

        <div class="database-detail-section">
          <h3>Table Snapshot</h3>
          <p class="small">Showing up to {{ preview_limit }} rows from the selected table.</p>
          {% if table_preview_error %}
            <div class="error-actions">
              <p class="small">Unable to load table data: {{ table_preview_error }}</p>
            </div>
          {% elif table_preview %}
            <div class="database-preview-table">
              <table>
                <thead>
                  <tr>
                    {% for column in table_preview.columns %}
                      <th>{{ column }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% if table_preview.rows %}
                    {% for row in table_preview.rows %}
                      <tr>
                        {% for column in table_preview.columns %}
                          <td>{{ row[column] }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="{{ table_preview.columns | length }}">
                        <span class="small">No rows returned for this table.</span>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="small">No data available for this table.</p>
          {% endif %}
        </div>

        <div class="database-detail-section">
          <h3>Column Drilldown</h3>
          <p class="small">Select a column to preview values and metadata.</p>
          <div class="database-column-summary">
            {% for column in selected_table_columns %}
              <a class="database-column-card {% if selected_column == column.name %}active{% endif %}" href="{{ url_for('admin_database_dashboard', schema=selected_schema, table=selected_table, column=column.name) }}">
                <div>
                  <strong>{{ column.name }}</strong>
                  <span class="small">{{ column.type }}</span>
                </div>
                <span class="database-column-card__meta">
                  {% if not column.nullable %}
                    Required
                  {% else %}
                    Optional
                  {% endif %}
                </span>
              </a>
            {% endfor %}
          </div>

          {% if selected_column %}
            {% if column_preview_error %}
              <div class="error-actions">
                <p class="small">Unable to load column data: {{ column_preview_error }}</p>
              </div>
            {% elif column_preview %}
              <div class="database-column-preview">
                <h4>Sample values for {{ column_preview.name }}</h4>
                {% if column_preview.values %}
                  <ul>
                    {% for value in column_preview.values %}
                      <li>{{ value }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="small">No values returned for this column.</p>
                {% endif %}
              </div>
            {% else %}
              <p class="small">Select a column to see sample values.</p>
            {% endif %}
          {% endif %}
        </div>
      {% else %}
        <div class="database-detail-empty">
          <h3>Select a table to begin</h3>
          <p class="small">
            Pick a schema and table from the left to explore live data, columns, and sample values.
          </p>
        </div>
      {% endif %}
    </section>
  </div>

  <script>
    const searchInput = document.getElementById("databaseSearch");
    if (searchInput) {
      const schemaItems = document.querySelectorAll(".database-schema-item");
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim().toLowerCase();
        schemaItems.forEach((schemaItem) => {
          let hasMatch = false;
          const tableItems = schemaItem.querySelectorAll(".database-table-item");
          tableItems.forEach((tableItem) => {
            const haystack = (tableItem.dataset.search || tableItem.textContent).toLowerCase();
            const matches = !query || haystack.includes(query);
            tableItem.style.display = matches ? "" : "none";
            if (matches) {
              hasMatch = true;
            }
          });
          schemaItem.style.display = !query || hasMatch ? "" : "none";
          if (query && hasMatch) {
            schemaItem.setAttribute("open", "open");
          }
        });
      });
    }

    const exportForm = document.querySelector(".database-export-form");
    if (exportForm) {
      const checkboxes = Array.from(
        exportForm.querySelectorAll('input[type="checkbox"][name="columns"]')
      );
      const submitButton = exportForm.querySelector('button[type="submit"]');
      const updateSubmitState = () => {
        const anyChecked = checkboxes.some((checkbox) => checkbox.checked);
        if (submitButton) {
          submitButton.disabled = !anyChecked;
        }
      };
      exportForm.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.dataset.action === "select-all") {
          checkboxes.forEach((checkbox) => {
            checkbox.checked = true;
          });
        }
        if (target.dataset.action === "clear-all") {
          checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
        }
        updateSubmitState();
      });
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", updateSubmitState);
      });
      updateSubmitState();
    }
  </script>
{% endblock %}
